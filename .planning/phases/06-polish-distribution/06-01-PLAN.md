---
phase: 06-polish-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/_layout.tsx
  - lib/offline-queue.ts
  - lib/network-context.tsx
  - lib/cached-data.ts
  - components/ui/OfflineBanner.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a persistent banner saying 'You're offline' when the device loses connectivity"
    - "App opens instantly showing the last-known groups and expenses without waiting for network"
    - "User's offline actions (create group, add expense) are preserved and not lost when the app is backgrounded"
  artifacts:
    - path: "lib/offline-queue.ts"
      provides: "Offline action queue with enqueue, flush, getAll, remove, retry"
      contains: "openDatabaseSync"
    - path: "lib/network-context.tsx"
      provides: "NetworkProvider context with isOnline state"
      contains: "useNetInfo"
    - path: "lib/cached-data.ts"
      provides: "Cached data layer for groups/expenses/balances"
      contains: "openDatabaseSync"
    - path: "components/ui/OfflineBanner.tsx"
      provides: "Persistent top banner shown when offline"
      contains: "isOnline"
    - path: "app/_layout.tsx"
      provides: "Root layout with all providers wired"
      contains: "GestureHandlerRootView"
  key_links:
    - from: "lib/network-context.tsx"
      to: "@react-native-community/netinfo"
      via: "useNetInfo hook"
      pattern: "useNetInfo"
    - from: "lib/offline-queue.ts"
      to: "expo-sqlite"
      via: "openDatabaseSync"
      pattern: "openDatabaseSync"
    - from: "app/_layout.tsx"
      to: "lib/network-context.tsx"
      via: "NetworkProvider wrapping app"
      pattern: "NetworkProvider"
---

<objective>
Install all Phase 6 dependencies and build the offline infrastructure layer: network connectivity context, offline action queue, cached data persistence, and the offline banner UI. Wire all new providers (NetworkProvider, GestureHandlerRootView, BottomSheetModalProvider) into the root layout.

Purpose: This is the foundation for all polish features. Network detection enables the offline banner and queue. GestureHandlerRootView and BottomSheetModalProvider enable bottom sheets in later plans. The cached data layer enables instant app opens.
Output: Working network detection with offline banner, offline queue ready for wiring, cached data layer, root layout with all providers.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-distribution/06-RESEARCH.md
@app/_layout.tsx
@lib/supabase.ts
@theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create network/offline infrastructure</name>
  <files>
    lib/offline-queue.ts
    lib/network-context.tsx
    lib/cached-data.ts
    components/ui/OfflineBanner.tsx
  </files>
  <action>
1. Install all Phase 6 new dependencies:
   ```bash
   npx expo install @gorhom/bottom-sheet moti expo-linear-gradient @react-native-community/netinfo
   ```

2. Create `lib/network-context.tsx`:
   - Import `useNetInfo` from `@react-native-community/netinfo`
   - Create `NetworkContext` with `{ isOnline: boolean }`
   - `NetworkProvider` component that wraps children, uses `useNetInfo()` to derive `isOnline` from `state.isConnected !== false` (treat null as online to avoid false positives on app start)
   - Export `useNetwork()` hook that reads context
   - Export `NetworkProvider`

3. Create `lib/offline-queue.ts`:
   - Use `expo-sqlite` synchronous API via `openDatabaseSync('hatian_offline.db')`
   - On module load, create table if not exists: `offline_queue(id INTEGER PRIMARY KEY AUTOINCREMENT, action_type TEXT NOT NULL, payload TEXT NOT NULL, created_at TEXT DEFAULT CURRENT_TIMESTAMP, status TEXT DEFAULT 'pending')`
   - `action_type` values: `'create_group'` | `'add_expense'`
   - Export functions:
     - `enqueue(actionType: string, payload: object): number` - inserts and returns id
     - `getAll(): QueueItem[]` - returns all pending items ordered by created_at
     - `remove(id: number): void` - deletes by id
     - `updateStatus(id: number, status: 'pending' | 'failed'): void`
     - `clearAll(): void` - deletes all items
   - Type `QueueItem = { id: number; action_type: string; payload: any; created_at: string; status: string }`

4. Create `lib/cached-data.ts`:
   - Use same `openDatabaseSync('hatian_offline.db')` (shares DB with queue)
   - Create table if not exists: `cached_data(key TEXT PRIMARY KEY, value TEXT NOT NULL, updated_at TEXT DEFAULT CURRENT_TIMESTAMP)`
   - Key format: `{userId}:{dataType}` (e.g., `abc123:groups`, `abc123:group_expenses_xyz`)
   - Export functions:
     - `setCachedData(key: string, data: any): void` - upsert JSON.stringify(data)
     - `getCachedData<T>(key: string): T | null` - parse or return null
     - `clearUserCache(userId: string): void` - delete all keys starting with userId
   - This enables instant app opens: load cached data first, then refresh from Supabase in background

5. Create `components/ui/OfflineBanner.tsx`:
   - Import `useNetwork` from `lib/network-context`
   - Renders a fixed banner at top of screen (below safe area) when `!isOnline`
   - Use Reanimated for slide-in/slide-out animation (entering: SlideInUp, exiting: SlideOutUp)
   - Style: `backgroundColor: colors.warning` (yellow), full width, `paddingVertical: spacing[2]`, centered text
   - Text: "You're offline" in dark text (`colors.textInverse`)
   - Return null when online (with animated exit)
  </action>
  <verify>
    - `npx expo install` completes without errors
    - `npx tsc --noEmit` passes (no type errors in new files)
    - All four new files exist and export their documented APIs
  </verify>
  <done>
    - @react-native-community/netinfo, @gorhom/bottom-sheet, moti, expo-linear-gradient in package.json
    - NetworkProvider provides isOnline boolean from netinfo
    - Offline queue can enqueue/dequeue actions in SQLite
    - Cached data layer can store/retrieve JSON by user-scoped keys
    - OfflineBanner shows/hides with animation based on connectivity
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire providers into root layout</name>
  <files>
    app/_layout.tsx
  </files>
  <action>
1. Update `app/_layout.tsx` to wrap the app with required providers. The nesting order matters:
   ```
   GestureHandlerRootView (outermost - required by bottom-sheet)
     AuthProvider
       NetworkProvider
         BottomSheetModalProvider
           RootNavigator
           OfflineBanner
           StatusBar
   ```

2. Import additions:
   - `import { GestureHandlerRootView } from 'react-native-gesture-handler'`
   - `import { BottomSheetModalProvider } from '@gorhom/bottom-sheet'`
   - `import { NetworkProvider } from '@/lib/network-context'`
   - `import { OfflineBanner } from '@/components/ui/OfflineBanner'`

3. In `RootLayout`, wrap the return JSX:
   - `GestureHandlerRootView` with `style={{ flex: 1 }}`
   - `NetworkProvider` inside AuthProvider
   - `BottomSheetModalProvider` inside NetworkProvider
   - Place `<OfflineBanner />` as a sibling of `<RootNavigator />` inside the providers (it positions itself absolutely)

4. Keep all existing functionality (fonts, splash screen, auth routing) unchanged.

5. IMPORTANT: The `OfflineBanner` must render inside `NetworkProvider` to access the context.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - App launches in simulator without crashes
    - Toggle airplane mode: offline banner appears with slide animation; toggle back: banner disappears
  </verify>
  <done>
    - Root layout wraps app in GestureHandlerRootView > AuthProvider > NetworkProvider > BottomSheetModalProvider
    - OfflineBanner appears when device goes offline and disappears when back online
    - All existing auth routing and navigation continues to work unchanged
  </done>
</task>

</tasks>

<verification>
1. App launches without errors after all provider changes
2. Network context correctly reports online/offline state
3. Offline banner slides in when airplane mode enabled, slides out when disabled
4. `npx tsc --noEmit` shows no type errors
5. Offline queue SQLite operations work (can be verified by importing and calling in a test)
</verification>

<success_criteria>
- All 4 new dependencies installed and importable
- NetworkProvider, GestureHandlerRootView, and BottomSheetModalProvider wired in root layout
- Offline banner visible when offline, hidden when online
- Offline queue and cached data modules export working APIs
- No regressions in existing app functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-distribution/06-01-SUMMARY.md`
</output>
