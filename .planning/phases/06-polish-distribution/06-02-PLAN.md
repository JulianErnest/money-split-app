---
phase: 06-polish-distribution
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - components/ui/Skeleton.tsx
  - components/ui/PullToRefresh.tsx
  - app/(tabs)/index.tsx
  - app/group/[id].tsx
  - app/group/[id]/balance/[memberId].tsx
autonomous: true

must_haves:
  truths:
    - "Groups list shows shimmer skeleton placeholders during initial load instead of spinner"
    - "Group detail shows shimmer skeleton placeholders during initial load instead of spinner"
    - "Balance drill-down screen shows shimmer skeleton during initial load"
    - "Pull-to-refresh works on groups list with a custom animated indicator"
    - "App opens instantly with last-known cached data before network fetch completes"
    - "Key actions trigger haptic feedback (tab switch, add expense, group created, expense saved)"
  artifacts:
    - path: "components/ui/Skeleton.tsx"
      provides: "Reusable skeleton components matching card/list shapes"
      contains: "MotiSkeletonGroup"
    - path: "components/ui/PullToRefresh.tsx"
      provides: "Custom animated pull-to-refresh control"
      contains: "useAnimatedStyle"
  key_links:
    - from: "components/ui/Skeleton.tsx"
      to: "moti/skeleton"
      via: "Skeleton component from moti"
      pattern: "moti/skeleton"
    - from: "app/(tabs)/index.tsx"
      to: "components/ui/Skeleton.tsx"
      via: "GroupsListSkeleton replaces loading spinner"
      pattern: "Skeleton"
    - from: "app/group/[id].tsx"
      to: "components/ui/Skeleton.tsx"
      via: "GroupDetailSkeleton replaces ActivityIndicator"
      pattern: "Skeleton"
    - from: "app/(tabs)/index.tsx"
      to: "lib/cached-data.ts"
      via: "getCachedData on mount, setCachedData after fetch"
      pattern: "getCachedData|setCachedData"
    - from: "app/group/[id].tsx"
      to: "lib/cached-data.ts"
      via: "getCachedData on mount, setCachedData after fetch"
      pattern: "getCachedData|setCachedData"
---

<objective>
Replace all loading spinners with shimmer skeleton loaders, add a custom pull-to-refresh animation, wire cached data for instant app opens, and add haptic feedback into key user actions across the app.

Purpose: Skeleton loaders feel faster and more polished than spinners. Cached data makes the app open instantly. Haptics provide tactile confirmation of actions. Pull-to-refresh with a custom animation adds personality.
Output: Skeleton components, custom PTR, cached data wiring, haptic feedback on key actions. All list screens feel instant and responsive.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-distribution/06-RESEARCH.md
@.planning/phases/06-polish-distribution/06-01-SUMMARY.md
@app/(tabs)/index.tsx
@app/group/[id].tsx
@app/group/[id]/balance/[memberId].tsx
@components/ui/Card.tsx
@lib/cached-data.ts
@theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skeleton loader and pull-to-refresh components</name>
  <files>
    components/ui/Skeleton.tsx
    components/ui/PullToRefresh.tsx
  </files>
  <action>
1. Create `components/ui/Skeleton.tsx`:
   - Import `Skeleton` from `moti/skeleton` and `MotiView` from `moti`
   - Use `colorMode="dark"` for all skeletons (dark theme app)
   - Set skeleton colors to match dark theme: `colors={[colors.surface, colors.surfaceElevated, colors.surface]}` for the shimmer gradient
   - Create these exported skeleton presets:

   a) `GroupCardSkeleton` - matches the GroupRow card layout:
      - Row with: circle (40x40 avatar), column with 2 rectangles (name ~60% width, member count ~30% width)
      - Wrap in Card component for consistent styling

   b) `GroupsListSkeleton` - renders 4x GroupCardSkeleton with same gap as real list

   c) `GroupDetailSkeleton` - matches group detail layout:
      - Center: large circle (64x64 avatar placeholder), rectangle below (group name)
      - Section: 2 rectangle buttons
      - Section: "Balances" label + 2 settlement card skeletons
      - Section: "Expenses" label + 3 expense card skeletons

   d) `ExpenseCardSkeleton` - single expense card shape:
      - Row with: circle (36x36), column with 2 rectangles (description, amount)

   e) `BalanceDetailSkeleton` - matches the balance drill-down screen layout:
      - Center: circle (48x48 member avatar), rectangle (member name)
      - Rectangle (summary amount)
      - Section: "Expenses" label + 3 expense card skeletons (reuse ExpenseCardSkeleton)

   - All skeletons wrapped in `Skeleton.Group show={true}` for coordinated animation
   - Use `radius="round"` for circles, `radius={radius.md}` for rectangles

2. Create `components/ui/PullToRefresh.tsx`:
   - Create a custom `RefreshControl` replacement using Reanimated
   - Design: A peso coin (text "â‚±") that rotates/scales as user pulls down
   - Export `AnimatedRefreshControl` component that accepts `refreshing: boolean` and `onRefresh: () => void`
   - Use `useAnimatedStyle` for the coin rotation animation
   - When pulling: coin scales from 0.5 to 1.0 and rotates 360 degrees
   - When refreshing: coin pulses (scale 0.8 to 1.0 loop)
   - Colors: `colors.accent` for the coin, `colors.background` behind it
   - The component should work as a drop-in replacement for RN's `RefreshControl`
   - If implementing a fully custom pull-to-refresh proves too complex with FlatList, fall back to using React Native's built-in `RefreshControl` with custom `tintColor={colors.accent}` and `colors={[colors.accent]}` props, which is simpler but still polished
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Skeleton components render without errors when imported
    - Skeleton shapes visually match the card layouts they replace
    - BalanceDetailSkeleton is exported and matches drill-down layout
  </verify>
  <done>
    - Skeleton.tsx exports GroupCardSkeleton, GroupsListSkeleton, GroupDetailSkeleton, ExpenseCardSkeleton, BalanceDetailSkeleton
    - All skeletons use dark colorMode with app theme colors
    - PullToRefresh.tsx exports a working refresh control component
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire skeletons, cached data, pull-to-refresh, and haptics into screens</name>
  <files>
    app/(tabs)/index.tsx
    app/group/[id].tsx
    app/group/[id]/balance/[memberId].tsx
  </files>
  <action>
1. Update `app/(tabs)/index.tsx` (Groups list screen):
   - Replace the loading state (currently returns null when `loading && groups.length === 0`) with `<GroupsListSkeleton />` from Skeleton.tsx
   - Keep the existing FlatList but swap its `refreshing`/`onRefresh` to use the custom AnimatedRefreshControl (or styled RefreshControl)
   - **Wire cached data for instant app opens:**
     - Import `getCachedData`, `setCachedData` from `@/lib/cached-data`
     - Import `useAuth` to get the current user ID
     - On mount (useEffect), call `getCachedData<Group[]>(\`\${userId}:groups\`)` and set it as initial state if non-null. This makes the app open instantly with last-known data.
     - After each successful fetch from Supabase (in fetchGroups), call `setCachedData(\`\${userId}:groups\`, groups)` to persist the latest data.
     - The flow is: mount -> show cached data immediately -> fetch from Supabase in background -> update state + cache when fetch completes
   - Add haptic feedback:
     - `import * as Haptics from 'expo-haptics'`
     - On group created successfully (after `await fetchGroups()` in handleCreateGroup): `Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success)`
     - On create group error: `Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error)`
   - Add fade-in animation for list items when data changes after background refresh:
     - Wrap each card in `MotiView` with `from={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ type: 'timing', duration: 300 }}`
     - Only apply fade-in on data refresh (not initial load). Use a `useRef` to track if initial load is complete.

2. Update `app/group/[id].tsx` (Group detail screen):
   - Replace the `ActivityIndicator` loading state with `<GroupDetailSkeleton />`
   - Keep the back button visible during skeleton loading (show skeleton below the header bar)
   - **Wire cached data:**
     - On mount, call `getCachedData(\`\${userId}:group_\${groupId}\`)` for group detail and set as initial state if non-null.
     - After each successful fetchData, call `setCachedData(\`\${userId}:group_\${groupId}\`, { expenses, balances, members })`.
   - Add haptic feedback:
     - On "Add Expense" button press: `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)`
     - On "Invite Friends" share: `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)`
     - On member removed successfully: `Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success)`
   - The ScrollView already doesn't have pull-to-refresh. Add RefreshControl to the ScrollView with the custom animated control, wired to the existing `fetchData` function.

3. Update `app/group/[id]/balance/[memberId].tsx` (Balance drill-down screen):
   - Replace any loading spinner/ActivityIndicator with `<BalanceDetailSkeleton />` from Skeleton.tsx
   - This ensures all list screens use skeleton loaders per locked decision

4. Haptic feedback patterns (per research discretion):
   - Tab switches: handled by existing haptic-tab component (already exists at `components/haptic-tab.tsx`)
   - Success actions (create group, save expense): `NotificationFeedbackType.Success`
   - Button presses (add expense, invite): `ImpactFeedbackStyle.Light`
   - Destructive confirms (remove member): `ImpactFeedbackStyle.Medium`
   - Errors: `NotificationFeedbackType.Error`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Groups list shows skeleton shimmer during first load, then renders real data
    - Group detail shows skeleton shimmer during first load
    - Balance drill-down shows skeleton shimmer during first load
    - Pull-to-refresh works on both screens
    - Haptic feedback fires on group creation and button presses (test on physical device)
    - Kill app, reopen: groups list appears instantly from cache before network fetch
  </verify>
  <done>
    - No ActivityIndicator or spinner visible anywhere in the app (including balance drill-down)
    - All list screens show shimmer skeletons during initial load
    - Pull-to-refresh works on groups list and group detail
    - Haptic feedback fires on: group created, expense button, invite, member removed
    - Data updates show fade-in animation
    - Cached data loads instantly on app open, then refreshes from Supabase in background
  </done>
</task>

</tasks>

<verification>
1. Groups list: skeleton shimmer on first load, smooth transition to real data
2. Group detail: skeleton shimmer on first load with back button visible
3. Balance drill-down: skeleton shimmer on first load
4. Pull-to-refresh on groups list and group detail
5. Haptics fire on key actions (requires physical device to verify)
6. Fade-in animation when data updates in background
7. App opens instantly with cached data, then refreshes
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Zero loading spinners in the app (all replaced by skeletons, including balance drill-down)
- Skeleton shapes match real content layout
- Pull-to-refresh works with themed indicator
- Haptic feedback on 4+ key actions
- Smooth fade-in when data refreshes in background
- Cached data enables instant app opens with last-known data
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-distribution/06-02-SUMMARY.md`
</output>
