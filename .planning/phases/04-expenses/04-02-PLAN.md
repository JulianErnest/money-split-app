---
phase: 04-expenses
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/group/[id]/add-expense.tsx
  - components/expenses/NumPad.tsx
  - components/expenses/AmountDisplay.tsx
  - components/expenses/PayerSelector.tsx
  - components/expenses/MemberSelector.tsx
  - components/expenses/SplitTypeToggle.tsx
  - components/expenses/CustomSplitRow.tsx
  - components/expenses/DotIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter an expense amount via a GCash-style numpad with large peso display"
    - "User can type a description for the expense"
    - "User can select who paid from group members via radio buttons"
    - "Current user is pre-selected as payer"
    - "User can choose equal or custom split type"
    - "User can select/deselect members for equal split"
    - "User can enter custom amounts per member with live remaining counter"
    - "User cannot submit until amount > 0, description non-empty, and splits valid"
    - "Expense is saved atomically via create_expense RPC"
    - "Amount is capped at 999,999 pesos"
  artifacts:
    - path: "app/group/[id]/add-expense.tsx"
      provides: "Multi-step expense wizard screen"
      min_lines: 100
    - path: "components/expenses/NumPad.tsx"
      provides: "Custom numpad grid component"
      min_lines: 30
    - path: "components/expenses/AmountDisplay.tsx"
      provides: "Large peso amount display"
      min_lines: 20
    - path: "components/expenses/MemberSelector.tsx"
      provides: "Checkbox member list for split selection"
      min_lines: 30
    - path: "components/expenses/PayerSelector.tsx"
      provides: "Radio button member list for payer selection"
      min_lines: 30
  key_links:
    - from: "app/group/[id]/add-expense.tsx"
      to: "lib/expense-utils.ts"
      via: "import calculateEqualSplit, customSplitRemaining, pesosToCentavos"
      pattern: "from.*expense-utils"
    - from: "app/group/[id]/add-expense.tsx"
      to: "supabase.rpc('create_expense')"
      via: "RPC call on submit"
      pattern: "supabase\\.rpc.*create_expense"
    - from: "app/group/[id]/add-expense.tsx"
      to: "react-native-pager-view"
      via: "PagerView for swipe steps"
      pattern: "PagerView"
---

<objective>
Build the complete add-expense wizard: a 3-step swipeable form with custom numpad, payer selection, split configuration, and atomic expense submission via Supabase RPC.

Purpose: This is the core expense creation flow -- the primary action users perform in the app. It must feel like a payment app (GCash/PayMaya style) with smooth swipe transitions.
Output: Full add-expense screen at app/group/[id]/add-expense.tsx with all supporting components.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-expenses/04-RESEARCH.md
@.planning/phases/04-expenses/04-01-SUMMARY.md
@lib/expense-utils.ts
@lib/database.types.ts
@lib/supabase.ts
@lib/auth-context.tsx
@app/group/[id].tsx
@theme/tokens.ts
@theme/colors.ts
@theme/spacing.ts
@components/ui/Text.tsx
@components/ui/Button.tsx
@components/ui/Card.tsx
@components/ui/Avatar.tsx
@components/ui/Input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-pager-view and build expense components</name>
  <files>
    components/expenses/NumPad.tsx
    components/expenses/AmountDisplay.tsx
    components/expenses/PayerSelector.tsx
    components/expenses/MemberSelector.tsx
    components/expenses/SplitTypeToggle.tsx
    components/expenses/CustomSplitRow.tsx
    components/expenses/DotIndicator.tsx
  </files>
  <action>
    1. Install react-native-pager-view:
       ```
       npx expo install react-native-pager-view
       ```

    2. Create components/expenses/ directory and build these components using the project's design system (colors, spacing, radius from @/theme, Text/Button/Avatar from @/components/ui):

    **NumPad.tsx**: 4x3 grid of Pressable keys (1-9, '.', 0, backspace). Props: onDigit(digit: string), onDecimal(), onBackspace(). Style: dark surface background keys, generous height (56px), rounded corners. Backspace key shows a left arrow icon or text.

    **AmountDisplay.tsx**: Large centered peso amount. Props: display (string, e.g. "1,234.50"), isEmpty (boolean). Shows peso sign to the left. Use the largest text variant available or a custom fontSize ~40. When isEmpty, show muted "0.00". Apply formatPeso from expense-utils for display formatting, BUT the raw display string is managed by the parent (numpad state). Show the raw display string as-is (parent handles formatting logic).

    **PayerSelector.tsx**: Scrollable list of group members with radio button selection. Props: members (array of {id, display_name, avatar_url}), selectedId (string), onSelect(id: string). Each row: Avatar + name + radio indicator (filled circle for selected, empty for unselected). Use the existing Avatar component.

    **MemberSelector.tsx**: Scrollable list of group members with checkbox selection. Props: members (array of {id, display_name, avatar_url}), selectedIds (string[]), onToggle(id: string). Each row: Avatar + name + checkbox indicator (filled for selected, empty for unselected). Re-use Avatar component.

    **SplitTypeToggle.tsx**: Segmented control with two options: "Equal" and "Custom". Props: value ('equal' | 'custom'), onChange(value). Two Pressable buttons side by side. Active button has accent background, inactive has surface background. Per research discretionary recommendation.

    **CustomSplitRow.tsx**: Single member row for custom split input. Props: member ({id, display_name, avatar_url}), amountCentavos (number), onAmountChange(centavos: number). Shows Avatar + name on left, peso amount on right as a tappable TextInput. Use a numeric keyboard type TextInput for the amount (NOT the custom numpad -- that's only for the main amount). Format display with formatPeso. Parse input back to centavos on change.

    **DotIndicator.tsx**: Simple dot row indicator. Props: current (number), total (number). Row of circles, active one uses accent color, inactive uses surface color. 8px dots with 8px gap.

    All components must:
    - Import from @/theme for colors, spacing, radius
    - Import from @/components/ui for Text, Avatar, etc.
    - Use StyleSheet.create for styles
    - Be typed with TypeScript interfaces for props
  </action>
  <verify>Run `npx tsc --noEmit` to verify all components compile. Verify react-native-pager-view appears in package.json dependencies.</verify>
  <done>All 7 expense components exist in components/expenses/ with proper TypeScript types. react-native-pager-view is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Assemble add-expense wizard screen with submit logic</name>
  <files>app/group/[id]/add-expense.tsx</files>
  <action>
    Create app/group/[id]/add-expense.tsx -- the multi-step expense wizard.

    **Screen structure:**
    - Full screen with SafeAreaView, dark background
    - Header: back button (X or left arrow) + "Add Expense" title
    - PagerView with 3 pages (each page is a direct View child with key prop -- CRITICAL for PagerView)
    - DotIndicator at the bottom
    - "Next" button on steps 1 and 2, "Add Expense" submit button on step 3

    **State management (lifted above PagerView):**
    - display: string (numpad raw input, e.g. "123.45")
    - description: string
    - payerId: string (default to current user's ID from auth context)
    - splitType: 'equal' | 'custom'
    - selectedMemberIds: string[] (default to all group members per discretionary rec)
    - customAmounts: Record<string, number> (centavos per member)
    - submitting: boolean (prevent double-submit)
    - currentPage: number

    **Numpad amount logic (implement as useAmountInput hook or inline):**
    - Track raw display string, NOT formatted
    - onDigit: append digit. If display is "0", replace with digit. If already has decimal with 2 places, reject. If resulting value > 999999.00, reject.
    - onDecimal: add "." if not already present
    - onBackspace: remove last char, if empty reset to "0"
    - Derive centavos: Math.round(parseFloat(display) * 100)

    **Page 1 -- Amount + Description:**
    - AmountDisplay showing the current amount (format with peso sign and commas for display, but numpad operates on raw string)
    - NumPad below
    - TextInput for description below numpad (or above amount -- use good judgment for layout). Placeholder: "What's this for?"
    - "Next" button enabled only when amount > 0

    **Page 2 -- Payer Selection:**
    - "Who paid?" header
    - PayerSelector with group members, current user pre-selected
    - "Next" button (always enabled since payer defaults)

    **Page 3 -- Split Type + Members:**
    - SplitTypeToggle at top
    - If equal: MemberSelector with checkboxes (default all selected). Show calculated per-person amount below: "Each person pays: {formatPeso(amount / selectedCount)}"
    - If custom: List of CustomSplitRow components for each member. Show "Remaining: {formatPeso(remaining)}" prominently. Remaining updates in real-time.
    - "Add Expense" submit button, enabled only when:
      - Equal: at least 1 member selected
      - Custom: remaining === 0 (all centavos assigned)

    **Submit logic:**
    1. Set submitting = true, disable button
    2. Calculate splits:
       - Equal: use calculateEqualSplit(centavos, selectedMemberIds)
       - Custom: use customAmounts directly
    3. Call supabase.rpc('create_expense', { p_group_id, p_description, p_amount: centavos/100, p_paid_by, p_split_type, p_splits: JSON array of {user_id, amount: centavos/100} })
    4. On success: router.back() to return to group detail
    5. On error: show Alert with error message, set submitting = false

    **Data loading:**
    - Get groupId from route params (useLocalSearchParams)
    - Get current user ID from auth context
    - Fetch group members on mount (same query pattern as group/[id].tsx)

    **Navigation:**
    - pagerRef.current?.setPage(n) for programmatic navigation on "Next" press
    - Allow swipe between pages naturally via PagerView

    IMPORTANT: PagerView children MUST be direct View components with key props. Do not wrap in fragments.
  </action>
  <verify>Run `npx tsc --noEmit` to verify the screen compiles. Run `npx expo export --platform ios` (dry run) to check for build errors. Manually verify the route resolves: the file at app/group/[id]/add-expense.tsx should be accessible as /group/{id}/add-expense.</verify>
  <done>Add-expense wizard screen exists with 3 swipeable steps, numpad amount entry, payer selection, equal/custom split configuration, and atomic submit via create_expense RPC. Button is disabled during submission to prevent duplicates.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- react-native-pager-view in package.json
- All 7 expense components exist in components/expenses/
- add-expense.tsx screen exists at app/group/[id]/add-expense.tsx
- Screen imports and uses expense-utils functions
- Screen calls supabase.rpc('create_expense') on submit
- Amount capped at 999,999 pesos in numpad logic
- Submit disabled when submitting or validation fails
</verification>

<success_criteria>
- Wizard has 3 swipeable steps with dot indicator
- Step 1: GCash-style numpad with large peso display + description input
- Step 2: Payer selection with current user pre-selected, radio buttons
- Step 3: Segmented control for equal/custom, member selection, live remaining counter for custom
- Submit creates expense atomically via RPC
- Amount validation enforces 999,999 peso cap
</success_criteria>

<output>
After completion, create `.planning/phases/04-expenses/04-02-SUMMARY.md`
</output>
