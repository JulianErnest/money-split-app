---
phase: 04-expenses
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - app/group/[id].tsx
  - components/expenses/ExpenseCard.tsx
  - app/group/[id]/expense/[expenseId].tsx
autonomous: true

must_haves:
  truths:
    - "User can view a chronological list of expenses in a group, most recent first"
    - "Each expense card shows description, total amount, who paid, and date"
    - "Each expense card shows personal balance impact (You owe / You lent / You paid)"
    - "User can tap an expense to see the full split breakdown"
    - "User can navigate to add-expense from the group detail screen"
  artifacts:
    - path: "app/group/[id].tsx"
      provides: "Group detail with expenses section and Add Expense button"
      contains: "ExpenseCard"
    - path: "components/expenses/ExpenseCard.tsx"
      provides: "Rich expense card component"
      min_lines: 40
    - path: "app/group/[id]/expense/[expenseId].tsx"
      provides: "Expense detail view with split breakdown"
      min_lines: 50
  key_links:
    - from: "app/group/[id].tsx"
      to: "supabase expenses query"
      via: "fetch expenses with splits on mount"
      pattern: "from.*expenses.*select"
    - from: "app/group/[id].tsx"
      to: "app/group/[id]/add-expense.tsx"
      via: "router.push navigation"
      pattern: "router\\.push.*add-expense"
    - from: "components/expenses/ExpenseCard.tsx"
      to: "lib/expense-utils.ts"
      via: "formatPeso for display"
      pattern: "from.*expense-utils"
    - from: "app/group/[id].tsx"
      to: "app/group/[id]/expense/[expenseId].tsx"
      via: "router.push on card tap"
      pattern: "router\\.push.*expense"
---

<objective>
Add the expense list to the group detail screen and build the expense detail view. Users see their group's expenses as rich cards with balance impact, and can tap to view the full split breakdown. An "Add Expense" button navigates to the wizard.

Purpose: This completes the expense viewing experience -- users can see what they owe and who paid, and navigate to add new expenses. Combined with Plan 02's wizard, this delivers the full expense feature.
Output: Modified group detail screen with expenses, ExpenseCard component, expense detail screen.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-expenses/04-RESEARCH.md
@.planning/phases/04-expenses/04-01-SUMMARY.md
@.planning/phases/04-expenses/04-02-SUMMARY.md
@app/group/[id].tsx
@lib/expense-utils.ts
@lib/database.types.ts
@lib/supabase.ts
@lib/auth-context.tsx
@theme/colors.ts
@theme/spacing.ts
@components/ui/Text.tsx
@components/ui/Card.tsx
@components/ui/Avatar.tsx
@components/ui/Button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExpenseCard component and expense detail screen</name>
  <files>components/expenses/ExpenseCard.tsx, app/group/[id]/expense/[expenseId].tsx</files>
  <action>
    **ExpenseCard.tsx** -- Rich card for expense list display.

    Props:
    - expense: { id, description, amount (numeric from DB -- pesos), paid_by, split_type, created_at, users: { display_name, avatar_url } }
    - splits: { user_id, amount }[]
    - currentUserId: string
    - onPress: () => void

    Layout (inside a Card component):
    - Left side: payer's Avatar (small)
    - Middle: description (bodyMedium, textPrimary), "Paid by {name}" (caption, textSecondary), date formatted as "Feb 18" or "Today" (caption, textSecondary)
    - Right side: total amount in peso format (bodyMedium, textPrimary), balance impact text below (caption, colored: accent for "You lent", a warning/red-ish color for "You owe", textSecondary for "Not involved")

    Balance impact logic (implement getBalanceImpact helper inside the file or import from expense-utils):
    - If current user is payer: "You lent {formatPeso((totalAmount - userSplitAmount) * 100)}" (convert DB pesos to centavos for formatPeso)
    - If current user is not payer but has a split: "You owe {formatPeso(userSplitAmount * 100)}"
    - If current user has no split: "Not involved"
    - If payer and only split member: "You paid {formatPeso(totalAmount * 100)}"

    Use Pressable wrapping the Card for onPress tap handler.

    **Expense detail screen** at app/group/[id]/expense/[expenseId].tsx:

    Uses Modal-style presentation. This is a full screen in Expo Router (presentationStyle comes from Stack config, or just a regular screen -- use good judgment).

    Layout:
    - Header: back button + "Expense Detail" title
    - Description (large text)
    - Total amount (large, formatted)
    - "Paid by {name}" with avatar
    - Split type badge ("Equal" or "Custom")
    - Date (formatted)
    - Divider
    - "Split Breakdown" section header
    - List of all members in the split: Avatar + name + their amount (formatPeso)
    - If the member is the payer, show "(paid)" label next to their name

    Data loading:
    - Get expenseId from route params
    - Fetch expense with splits and user info:
      ```
      supabase.from('expenses')
        .select('*, users!expenses_paid_by_fkey(display_name, avatar_url), expense_splits(user_id, amount, users(display_name, avatar_url))')
        .eq('id', expenseId)
        .single()
      ```
    - Handle loading and error states
  </action>
  <verify>Run `npx tsc --noEmit` to verify both files compile. ExpenseCard renders balance impact text. Detail screen fetches and displays split breakdown.</verify>
  <done>ExpenseCard component shows description, amount, payer, date, and personal balance impact. Expense detail screen shows full split breakdown with member amounts.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate expenses into group detail screen</name>
  <files>app/group/[id].tsx</files>
  <action>
    Modify the existing group detail screen (app/group/[id].tsx) to add:

    1. **Fetch expenses** alongside the existing group + members fetch in fetchGroupAndMembers(). Add a third parallel query:
       ```typescript
       supabase
         .from('expenses')
         .select('id, description, amount, paid_by, split_type, created_at, users!expenses_paid_by_fkey(display_name, avatar_url), expense_splits(user_id, amount)')
         .eq('group_id', id)
         .order('created_at', { ascending: false })
       ```
       Store in a new state: expenses (array). Define the Expense type interface at the top of the file.

    2. **"Add Expense" button** below the share/invite section. Use the existing Button component with variant="primary". Label: "Add Expense". OnPress: router.push(`/group/${id}/add-expense`). Place it prominently.

    3. **Expenses section** below the "Add Expense" button and above the Members section. Structure:
       - Section header: "Expenses" with count badge (same pattern as Members section header)
       - If no expenses: show empty state text "No expenses yet" (caption, textSecondary, centered)
       - If expenses exist: render ExpenseCard for each expense using FlatList (NOT ScrollView -- expense lists can grow). NOTE: Since the whole screen is a ScrollView, use a flat map of ExpenseCard components instead (avoid nested scroll). Just map over expenses and render ExpenseCard components directly inside the ScrollView.
       - Each ExpenseCard gets onPress={() => router.push(`/group/${id}/expense/${expense.id}`)}

    4. **Get current user ID** from auth context (useAuth or similar) to pass to ExpenseCard for balance impact calculation.

    5. **Refresh after adding expense**: When returning from add-expense screen, the data should refresh. Use useFocusEffect from expo-router (or useEffect with isFocused) to re-fetch when the screen regains focus. This ensures newly added expenses appear without manual refresh.

    IMPORTANT: Keep all existing functionality intact (group header, share button, members list). Just add the expenses section and Add Expense button.

    Order of sections in the ScrollView:
    1. Group header (avatar + name) -- existing
    2. Invite Friends button -- existing
    3. Add Expense button -- NEW
    4. Expenses section -- NEW
    5. Members section -- existing (moved below expenses)
  </action>
  <verify>Run `npx tsc --noEmit` to verify the modified screen compiles. Verify the screen still renders group header, share button, and members. Verify expenses section exists with ExpenseCard imports. Verify "Add Expense" button navigates to add-expense route.</verify>
  <done>Group detail screen shows expense list with rich cards, personal balance impact, "Add Expense" button, and tappable cards that navigate to expense detail. Expenses refresh on screen focus. Members section preserved below expenses.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Group detail screen fetches and displays expenses
- ExpenseCard shows description, amount, payer, date, balance impact
- Tap on expense navigates to detail screen with split breakdown
- "Add Expense" button navigates to wizard
- Expenses ordered most recent first
- Empty state shown when no expenses
- Screen refreshes expense data on focus
</verification>

<success_criteria>
- Expense list displays in group detail, most recent first
- Each card shows: description, total peso amount, who paid, date, "You owe X" or "You lent X"
- Tapping a card shows full split breakdown (each member's share)
- "Add Expense" button navigates to the wizard from Plan 02
- Returning from wizard refreshes the expense list
</success_criteria>

<output>
After completion, create `.planning/phases/04-expenses/04-03-SUMMARY.md`
</output>
