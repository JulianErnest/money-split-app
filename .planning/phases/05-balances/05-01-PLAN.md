---
phase: 05-balances
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/balance-utils.ts
  - lib/__tests__/balance-utils.test.ts
autonomous: true

must_haves:
  truths:
    - "simplifyDebts converts net balances into minimal settlement transactions"
    - "Settlements always sum to zero (conservation of money)"
    - "Zero-balance members produce no settlements"
    - "All amounts are in centavos (integers) to avoid floating-point issues"
  artifacts:
    - path: "lib/balance-utils.ts"
      provides: "simplifyDebts pure function and Settlement type"
      exports: ["simplifyDebts", "Settlement"]
    - path: "lib/__tests__/balance-utils.test.ts"
      provides: "TDD tests for debt simplification"
      min_lines: 40
  key_links:
    - from: "lib/__tests__/balance-utils.test.ts"
      to: "lib/balance-utils.ts"
      via: "import"
      pattern: "import.*simplifyDebts.*from.*balance-utils"
---

<objective>
TDD the greedy debt simplification algorithm as a pure TypeScript function.

Purpose: The debt simplification algorithm is the core value proposition of the app -- it minimizes the number of transactions needed to settle all debts in a group. TDD ensures correctness for edge cases (zero balances, single debt, multi-party, conservation of money).
Output: Tested `simplifyDebts()` function in `lib/balance-utils.ts` with full test coverage.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-balances/05-RESEARCH.md
@lib/expense-utils.ts
@lib/__tests__/expense-utils.test.ts
</context>

<feature>
  <name>Greedy Debt Simplification Algorithm</name>
  <files>lib/balance-utils.ts, lib/__tests__/balance-utils.test.ts</files>
  <behavior>
    `simplifyDebts(netBalances: Map<string, number>): Settlement[]`

    All amounts are in centavos (integers). The function takes a map of member_id -> net_balance_centavos where positive = owed money (creditor) and negative = owes money (debtor).

    Algorithm: Sort debtors and creditors descending by amount. Greedily match highest debtor to highest creditor, transferring the minimum of the two amounts. Repeat until all debts settled.

    Test cases (input -> expected output):
    - Empty map -> []
    - All zero balances -> []
    - Two-person: {alice: 5000, bob: -5000} -> [{from: bob, to: alice, amount: 5000}]
    - Three-person: {alice: 20000, bob: -15000, charlie: -5000} -> 2 settlements totaling 20000 to alice
    - Four-person conservation: {a: 10000, b: -3000, c: -4000, d: -3000} -> net flows match original balances
    - Zero-balance member ignored: {alice: 5000, bob: 0, charlie: -5000} -> 1 settlement, bob not involved
    - Single person with zero net (paid and owes same) -> []

    Also export:
    - `Settlement` type: { from: string; to: string; amount: number }
    - `netBalancesToCentavos(rows: Array<{member_id: string, net_balance: number}>): Map<string, number>` -- converts RPC response (pesos as number) to centavos map using Math.round(amount * 100)
  </behavior>
  <implementation>
    Follow the greedy algorithm from 05-RESEARCH.md:
    1. Separate into debtors (negative balance, store as positive amount) and creditors (positive balance)
    2. Sort both descending by amount
    3. Two-pointer: transfer min(debtor.amount, creditor.amount), advance pointer when amount reaches 0
    4. Return array of Settlement objects

    For netBalancesToCentavos: iterate rows, Math.round(row.net_balance * 100), skip zero entries.

    Follow existing patterns from lib/expense-utils.ts for code style and exports.
  </implementation>
</feature>

<verification>
- `npx jest lib/__tests__/balance-utils.test.ts` passes all tests
- All test cases from the behavior section are covered
- No floating-point numbers in the algorithm (all centavo integers)
</verification>

<success_criteria>
- simplifyDebts correctly minimizes transactions for all test cases
- Conservation property holds: net flows match original balances for every test
- Zero-balance members produce no settlements
- netBalancesToCentavos correctly converts decimal pesos to integer centavos
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-balances/05-01-SUMMARY.md`
</output>
