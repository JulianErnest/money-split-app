---
phase: 05-balances
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - supabase/migrations/00009_balance_rpcs.sql
  - lib/database.types.ts
  - app/group/[id].tsx
  - lib/balance-utils.ts
autonomous: true

must_haves:
  truths:
    - "User can view simplified balances within a group showing the minimum set of transactions to settle all debts"
    - "Balances section appears above expenses in group detail"
    - "Each settlement shows who owes whom and how much in pesos"
    - "Pending members appear in balances with their phone number"
  artifacts:
    - path: "supabase/migrations/00009_balance_rpcs.sql"
      provides: "get_group_balances and get_my_group_balances RPC functions"
      contains: "get_group_balances"
    - path: "app/group/[id].tsx"
      provides: "Balances section in group detail screen"
      contains: "simplifyDebts"
  key_links:
    - from: "app/group/[id].tsx"
      to: "supabase RPC get_group_balances"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*get_group_balances"
    - from: "app/group/[id].tsx"
      to: "lib/balance-utils.ts"
      via: "import simplifyDebts"
      pattern: "import.*simplifyDebts.*from.*balance-utils"
    - from: "supabase/migrations/00009_balance_rpcs.sql"
      to: "expenses and expense_splits tables"
      via: "SQL aggregation with COALESCE for pending members"
      pattern: "coalesce.*user_id.*pending_member_id"
---

<objective>
Create the balance RPCs and display simplified balances in the group detail screen.

Purpose: This is the core balance feature (BLNC-01). Users need to see who owes whom within a group, computed from all expenses and splits (including pending members). The RPCs aggregate expense data server-side, and the client runs the simplification algorithm from Plan 01.
Output: Two Supabase RPCs (get_group_balances, get_my_group_balances) and a working "Balances" section in the group detail screen.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-balances/05-RESEARCH.md
@.planning/phases/05-balances/05-01-SUMMARY.md
@app/group/[id].tsx
@lib/balance-utils.ts
@lib/group-members.ts
@lib/expense-utils.ts
@lib/database.types.ts
@supabase/migrations/00004_create_expense_rpc.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create balance RPC migration and regenerate types</name>
  <files>supabase/migrations/00009_balance_rpcs.sql, lib/database.types.ts</files>
  <action>
    Create migration `supabase/migrations/00009_balance_rpcs.sql` with two RPC functions:

    1. `get_group_balances(p_group_id uuid)` -- returns table(member_id uuid, is_pending boolean, net_balance numeric(10,2)):
       - Use `security definer` with `set search_path = public` (established pattern from 00003, 00004, 00008)
       - Auth check: verify caller is a group member via `group_members` table
       - CTE `paid`: sum expenses.amount grouped by paid_by for the group
       - CTE `owed`: sum expense_splits.amount grouped by `COALESCE(es.user_id, es.pending_member_id)`, with `(es.user_id IS NULL) as is_pending`
       - Final select: `COALESCE(p.total_paid, 0) - o.total_owed as net_balance`
       - Left join paid on member_id only for non-pending members (pending members cannot be payers)
       - Filter with `WHERE EXISTS (SELECT 1 FROM auth_check)` for security

    2. `get_my_group_balances()` -- returns table(group_id uuid, net_balance numeric(10,2)):
       - `security definer` with `set search_path = public`
       - CTE `my_groups`: select group_id from group_members where user_id = auth.uid()
       - CTE `paid`: sum expenses.amount where paid_by = auth.uid() grouped by group_id
       - CTE `owed`: sum expense_splits.amount where es.user_id = auth.uid() grouped by group_id
       - Final: for each group, `COALESCE(paid, 0) - COALESCE(owed, 0)` as net_balance
       - Only return groups where net_balance != 0 (optimization for groups list)

    After creating the migration, run `npx supabase db push` to apply it (if local dev), then regenerate types with `npx supabase gen types typescript --local > lib/database.types.ts`.

    If supabase CLI commands fail (no local instance), just create the migration file and manually update `lib/database.types.ts` to add the RPC function signatures to the `Functions` section, following the exact pattern of existing RPC type definitions in that file.
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/00009_balance_rpcs.sql`
    - SQL is syntactically valid (no typos in function signatures)
    - Both functions use `security definer` and `set search_path = public`
    - `get_group_balances` includes auth check via group_members
    - `COALESCE(es.user_id, es.pending_member_id)` pattern used for pending members
    - `lib/database.types.ts` includes type definitions for both new RPCs
  </verify>
  <done>Two RPC functions defined in migration, types updated to include their signatures</done>
</task>

<task type="auto">
  <name>Task 2: Add balances section to group detail screen</name>
  <files>app/group/[id].tsx, lib/balance-utils.ts</files>
  <action>
    Update `app/group/[id].tsx` to add a "Balances" section ABOVE the existing expenses section.

    1. Add a `useBalances` data fetch (or inline in existing useEffect/useFocusEffect):
       - Call `supabase.rpc('get_group_balances', { p_group_id: id })`
       - Convert response to centavos map using `netBalancesToCentavos()` from balance-utils
       - Run `simplifyDebts()` to get settlements array
       - Store settlements in state

    2. For display, also need member display info. Add a helper or extend balance-utils:
       - `formatSettlementDisplay(settlement, memberMap)` that resolves member_id to display_name/phone
       - Use the existing `GroupMember` type from `lib/group-members.ts` for member info lookup
       - The RPC only returns member_id + net_balance. Member display info comes from the already-fetched members list in the group detail screen.

    3. Render the "Balances" section:
       - Section header: "Balances" with appropriate styling (match existing section headers)
       - If no settlements (all settled): show "All settled up" in textSecondary color
       - For each settlement: show "{debtor_name} owes {creditor_name} {formatPeso(amount)}"
       - Use the app's color tokens: green (accent) for creditor amounts, red (error) for debtor amounts
       - Each settlement row should be pressable (prep for drill-down in Plan 03)
       - Include pending member indicator (# avatar, phone number) matching established pattern from Phase 4.1

    4. Refresh balances on screen focus using `useFocusEffect` (same pattern as expenses refresh).

    5. Add `formatBalanceColor(amountCentavos: number)` and `formatBalanceSummary(netBalanceCentavos: number)` helpers to `lib/balance-utils.ts`:
       - `formatBalanceColor`: returns accent (green) for positive, error (red) for negative, textSecondary for zero
       - `formatBalanceSummary`: returns "You are owed {amount}" for positive, "You owe {amount}" for negative, "Settled up" for zero

    Keep the existing expenses section and members section unchanged. Balances section goes between members and expenses.
  </action>
  <verify>
    - `app/group/[id].tsx` imports `simplifyDebts` and `netBalancesToCentavos` from balance-utils
    - Balances section renders above expenses section
    - `useFocusEffect` triggers balance refresh
    - Settlement rows show debtor, creditor, and formatted peso amount
    - Empty state shows "All settled up"
    - `npx tsc --noEmit` passes (no type errors)
  </verify>
  <done>Group detail screen shows simplified balances section with settlement transactions computed from the RPC data</done>
</task>

</tasks>

<verification>
- Migration file exists and contains both RPC functions
- Group detail screen shows balances section
- TypeScript compiles without errors
- Balances refresh on screen focus
</verification>

<success_criteria>
- User can see simplified balances within a group (BLNC-01)
- Pending members appear in balances with their phone number
- Balances refresh when navigating back after adding an expense
- Empty groups show "All settled up"
</success_criteria>

<output>
After completion, create `.planning/phases/05-balances/05-02-SUMMARY.md`
</output>
