---
phase: 05-balances
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - app/(tabs)/index.tsx
  - app/group/[id]/balance/[memberId].tsx
autonomous: true

must_haves:
  truths:
    - "Each group in the groups list shows a quick net balance summary"
    - "User can tap a balance entry to see which expenses contribute to that debt"
    - "Balance drill-down shows each contributing expense with the debtor's share amount"
  artifacts:
    - path: "app/(tabs)/index.tsx"
      provides: "Per-group net balance summary on group cards"
      contains: "get_my_group_balances"
    - path: "app/group/[id]/balance/[memberId].tsx"
      provides: "Balance drill-down screen showing contributing expenses"
      min_lines: 40
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "supabase RPC get_my_group_balances"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*get_my_group_balances"
    - from: "app/group/[id].tsx"
      to: "app/group/[id]/balance/[memberId].tsx"
      via: "router.push navigation on settlement press"
      pattern: "router\\.push.*balance"
    - from: "app/group/[id]/balance/[memberId].tsx"
      to: "supabase expenses + expense_splits"
      via: "query for contributing expenses"
      pattern: "expenses.*expense_splits|paid_by"
---

<objective>
Add per-group balance summary to the groups list and balance drill-down screen.

Purpose: Completes BLNC-02 (net balance on group cards) and BLNC-03 (tap balance to see contributing expenses). Users need to see their net position at a glance on the groups list, and drill into any balance to understand where the debt comes from.
Output: Updated groups list with balance badges and a new balance drill-down screen.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-balances/05-RESEARCH.md
@.planning/phases/05-balances/05-02-SUMMARY.md
@app/(tabs)/index.tsx
@app/group/[id].tsx
@lib/balance-utils.ts
@lib/expense-utils.ts
@lib/group-members.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add net balance summary to groups list</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
    Update the groups list screen to show the current user's net balance for each group.

    1. Fetch balances on screen focus:
       - Call `supabase.rpc('get_my_group_balances')` which returns `{ group_id, net_balance }[]`
       - Store in a Map<string, number> keyed by group_id, values in centavos (Math.round(net_balance * 100))
       - Use `useFocusEffect` for refresh (matching existing pattern)

    2. Display on each group card:
       - Below the group name / member count, add a balance line
       - Use `formatBalanceSummary()` from balance-utils: "You owe P350" (red), "You are owed P200" (green), or nothing if zero
       - Use `formatBalanceColor()` from balance-utils for text color
       - If the group has no balance data (no expenses), don't show the balance line at all
       - Keep styling compact -- single line, smaller font size than group name, matching the existing card layout

    3. Error handling:
       - If the RPC call fails, silently skip balance display (don't break the groups list)
       - Balance fetch should not block groups list rendering (load groups first, then overlay balances)
  </action>
  <verify>
    - Groups list screen calls `get_my_group_balances` RPC
    - Each group card shows net balance text with correct color
    - Groups with no expenses show no balance text
    - `npx tsc --noEmit` passes
  </verify>
  <done>Each group in the groups list shows the user's net balance summary with color coding</done>
</task>

<task type="auto">
  <name>Task 2: Create balance drill-down screen</name>
  <files>app/group/[id]/balance/[memberId].tsx, app/group/[id].tsx</files>
  <action>
    Create a new screen for balance drill-down (BLNC-03) and wire up navigation from the balances section.

    1. Create `app/group/[id]/balance/[memberId].tsx`:
       - Route params: `id` (group_id), `memberId` (the other member in the settlement)
       - Also pass via route params or query: `direction` ("owe" or "owed"), `memberName`, `amount` (for the header)
       - Header: "{You owe / X owes you} P{amount}" with appropriate color

    2. Fetch contributing expenses:
       - Query expenses where the creditor (payer) paid AND the debtor has a split
       - If current user owes memberId: query expenses where `paid_by = memberId` and `expense_splits.user_id = auth.uid()`
       - If memberId owes current user: query expenses where `paid_by = auth.uid()` and `(expense_splits.user_id = memberId OR expense_splits.pending_member_id = memberId)`
       - Use supabase query builder (not RPC) -- join expenses with expense_splits:
         ```
         supabase.from('expenses')
           .select('id, description, amount, created_at, expense_splits!inner(amount, user_id, pending_member_id)')
           .eq('group_id', id)
           .eq('paid_by', creditorId)
           .or(`user_id.eq.${debtorId},pending_member_id.eq.${debtorId}`, { referencedTable: 'expense_splits' })
           .order('created_at', { ascending: false })
         ```
       - If RLS blocks this query, create an inline supabase query that works within existing RLS policies (expenses are readable by group members per existing policy)

    3. Display list of contributing expenses:
       - Each row: expense description, date, total expense amount, and the debtor's share from that expense
       - Format: "{description} - {date}" on first line, "Total: {formatPeso(total)} | Your share: {formatPeso(split_amount)}" on second line
       - Use existing dark theme styling and Card/list patterns from the app
       - Empty state: "No expenses found" (shouldn't happen if navigated here, but handle gracefully)

    4. Wire navigation from group detail balances section:
       - In `app/group/[id].tsx`, make each settlement row pressable
       - On press, navigate to the drill-down screen with appropriate params
       - Use `router.push` with the path: `/group/${id}/balance/${otherMemberId}?direction=owe&memberName=...&amount=...`
       - Determine `otherMemberId` and `direction` from the settlement (if current user is the debtor, direction is "owe"; if creditor, direction is "owed")
  </action>
  <verify>
    - New file exists at `app/group/[id]/balance/[memberId].tsx`
    - Tapping a settlement in group detail navigates to drill-down screen
    - Drill-down shows list of contributing expenses with individual split amounts
    - Back navigation returns to group detail
    - `npx tsc --noEmit` passes
  </verify>
  <done>User can tap any balance entry to see which expenses contribute to that debt, with individual share amounts per expense</done>
</task>

</tasks>

<verification>
- Groups list shows per-group net balance summary
- Balance drill-down screen accessible from group detail
- All three requirements (BLNC-01, BLNC-02, BLNC-03) are met
- TypeScript compiles without errors
- Navigation flow: groups list -> group detail (balances) -> balance drill-down
</verification>

<success_criteria>
- Each group card shows "You owe X" or "You are owed X" with correct color (BLNC-02)
- Tapping a settlement shows contributing expenses with per-expense share amounts (BLNC-03)
- Pending members work correctly in drill-down (via pending_member_id)
- Empty states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/05-balances/05-03-SUMMARY.md`
</output>
