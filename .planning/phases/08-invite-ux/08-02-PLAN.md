---
phase: 08-invite-ux
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - lib/group-members.ts
  - app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a 'Pending Invites' section at the top of the home screen showing group name and inviter name for each invite"
    - "User sees an empty state message when no invites are pending"
    - "User can tap Accept on an invite card and is navigated to the group detail screen with a success toast"
    - "User can tap Decline on an invite card, sees a confirmation warning, and the invite disappears after confirming"
    - "Accepted group appears in the My Groups section on return to home screen"
  artifacts:
    - path: "lib/group-members.ts"
      provides: "fetchPendingInvites function and InviteRow type"
      contains: "fetchPendingInvites|InviteRow"
    - path: "app/(tabs)/index.tsx"
      provides: "SectionList with Pending Invites and My Groups sections, invite card with accept/decline buttons"
      contains: "SectionList|Pending Invites|Accept|Decline"
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "get_my_pending_invites RPC"
      via: "fetchPendingInvites in lib/group-members.ts"
      pattern: "supabase\\.rpc.*get_my_pending_invites"
    - from: "app/(tabs)/index.tsx accept handler"
      to: "accept_invite RPC"
      via: "supabase.rpc call with p_pending_member_id"
      pattern: "supabase\\.rpc.*accept_invite"
    - from: "app/(tabs)/index.tsx decline handler"
      to: "decline_invite RPC"
      via: "Alert.alert confirmation then supabase.rpc call"
      pattern: "Alert\\.alert.*decline_invite"
---

<objective>
Build the invite inbox UI on the home screen with accept and decline flows. Convert the home screen FlatList to a SectionList with two sections: "Pending Invites" at top and "My Groups" below, with inline accept/decline buttons on invite cards.

Purpose: This is the user-facing experience for the invite system. Users who were added to a group by phone number can now see, accept, or decline those invites directly from the home screen.

Output: Updated home screen with SectionList, invite cards, accept handler with toast and navigation, decline handler with Alert confirmation.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-invite-ux/08-RESEARCH.md
@.planning/phases/08-invite-ux/08-01-SUMMARY.md
@app/(tabs)/index.tsx
@lib/group-members.ts
@components/ui/EmptyState.tsx
@components/ui/Toast.tsx
@components/ui/Button.tsx
@components/ui/Card.tsx
@components/ui/Avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fetchPendingInvites function and InviteRow type</name>
  <files>lib/group-members.ts</files>
  <action>
Add to `lib/group-members.ts`:

1. **InviteRow type** (export it):
```typescript
export interface InviteRow {
  pending_member_id: string;
  group_id: string;
  group_name: string;
  invited_by_name: string;
}
```

2. **fetchPendingInvites function** (export it):
```typescript
export async function fetchPendingInvites(): Promise<InviteRow[]> {
  const { data, error } = await supabase.rpc("get_my_pending_invites");
  if (error || !data) return [];
  return data as InviteRow[];
}
```

Place both after the existing `fetchAllMembers` function. Follow the same code style (JSDoc comment, explicit return type).
  </action>
  <verify>
Run: `npx expo export --platform ios 2>&1 | tail -5` -- should compile cleanly.
Verify exports: `grep -c 'export.*InviteRow\|export.*fetchPendingInvites' lib/group-members.ts` -- should return 2.
  </verify>
  <done>
lib/group-members.ts exports InviteRow interface and fetchPendingInvites function that calls get_my_pending_invites RPC.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert home screen to SectionList with invite inbox and accept/decline flows</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
Major update to `app/(tabs)/index.tsx`. This is the core UI task for Phase 8.

**Imports to add:**
- `SectionList` from `react-native` (replace FlatList import, or keep both if FlatList is used elsewhere -- it is not)
- `{ useToast }` from `@/components/ui/Toast`
- `{ fetchPendingInvites, InviteRow }` from `@/lib/group-members`

**State to add:**
- `const [pendingInvites, setPendingInvites] = useState<InviteRow[]>([]);`
- `const [acceptingId, setAcceptingId] = useState<string | null>(null);` -- tracks which invite is being accepted (for loading state)
- `const { showToast } = useToast();`

**Fetch invites function:**
```typescript
const fetchInvites = useCallback(async () => {
  if (!user) return;
  const invites = await fetchPendingInvites();
  setPendingInvites(invites);
}, [user]);
```

**Wire fetchInvites into existing fetch patterns:**
- Add `fetchInvites()` call alongside `fetchGroups()` in the initial `useEffect` (line ~170)
- Add `fetchInvites()` to the `useFocusEffect` that calls `fetchBalances()` -- so invites refresh when returning to home screen
- Add `fetchInvites()` to `handleRefresh` (alongside fetchGroups and fetchBalances)
- Add `fetchInvites()` to the sync-complete listener

**Accept handler (LOCKED DECISIONS -- honor exactly):**
- Single tap accept -- NO confirmation dialog
- After accepting, navigate directly to the group detail screen
- Show success toast: "You joined [Group Name]!"
- Haptic feedback on success and error

```typescript
const handleAcceptInvite = useCallback(async (invite: InviteRow) => {
  setAcceptingId(invite.pending_member_id);
  try {
    const { data: groupId, error } = await supabase.rpc("accept_invite", {
      p_pending_member_id: invite.pending_member_id,
    });
    if (error) {
      showToast({ message: error.message, type: "error" });
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
      return;
    }
    // Remove from local state immediately
    setPendingInvites(prev => prev.filter(i => i.pending_member_id !== invite.pending_member_id));
    // Toast and navigate
    showToast({ message: `You joined ${invite.group_name}!`, type: "success" });
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
    router.push(`/group/${groupId}` as any);
  } catch {
    showToast({ message: "Something went wrong. Please try again.", type: "error" });
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
  } finally {
    setAcceptingId(null);
  }
}, [showToast, router]);
```

**Decline handler (LOCKED DECISIONS -- honor exactly):**
- Show warning before declining -- user must confirm via Alert
- Warning text: "Declining will remove you from all expense splits in this group."
- After confirming decline, invite disappears silently -- NO toast
- Haptic feedback on success

```typescript
const handleDeclineInvite = useCallback((invite: InviteRow) => {
  Alert.alert(
    "Decline Invite",
    "Declining will remove you from all expense splits in this group.",
    [
      { text: "Cancel", style: "cancel" },
      {
        text: "Decline",
        style: "destructive",
        onPress: async () => {
          try {
            const { error } = await supabase.rpc("decline_invite", {
              p_pending_member_id: invite.pending_member_id,
            });
            if (error) {
              showToast({ message: error.message, type: "error" });
              Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
              return;
            }
            // Silently remove (no toast per user decision)
            setPendingInvites(prev => prev.filter(i => i.pending_member_id !== invite.pending_member_id));
            Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
          } catch {
            showToast({ message: "Something went wrong. Please try again.", type: "error" });
            Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
          }
        },
      },
    ]
  );
}, [showToast]);
```

**SectionList conversion:**
Replace the `<FlatList>` component with `<SectionList>`. Define sections:

```typescript
const sections = useMemo(() => [
  { title: "Pending Invites", data: pendingInvites, type: "invite" as const },
  { title: "My Groups", data: groups, type: "group" as const },
], [pendingInvites, groups]);
```

The SectionList needs:
- `sections={sections}`
- `keyExtractor` -- for invites use `pending_member_id`, for groups use `group_id`
- `renderItem` -- dispatch by section type. For "invite" type, render an invite card. For "group" type, use the existing `renderItem` logic (the group card Pressable with Card, Avatar, balance info).
- `renderSectionHeader` -- render section title text (use `Text variant="caption" color="textSecondary"` styled as a section label, uppercase or normal case, matching app conventions). Add top margin for separation.
- `renderSectionFooter` -- for the "invite" section: if `pendingInvites.length === 0`, render an EmptyState with emoji="✉️", headline="No pending invites", subtext="When someone adds you to a group, it will show up here." For the "group" section: if `groups.length === 0`, render the existing empty state (the "Wala pa kay group!" one).
- `contentContainerStyle`, `refreshControl`, `alwaysBounceVertical` -- carry over from existing FlatList
- `stickySectionHeadersEnabled={false}` -- section headers should scroll with content, not stick

**Invite card rendering:**
Each invite card should be a `Card` with:
- Left: `Avatar` with `getGroupEmoji(invite.group_name)` and size="md"
- Center: group name (`Text variant="bodyMedium" color="textPrimary"`) and "Invited by [name]" (`Text variant="caption" color="textSecondary"`)
- Bottom row: Accept button (`Button variant="primary" label="Accept"` with `loading={acceptingId === invite.pending_member_id}`) and Decline button (`Button variant="ghost" label="Decline"`)
- Wrap invite card in `MotiView` for fade-in animation (same pattern as group cards)
- Disable both buttons while any invite is being accepted (check `acceptingId !== null`)

**Styles to add:**
- `sectionHeader` -- paddingTop, paddingBottom, text styling for section labels
- `inviteCard` -- card styling for invite items
- `inviteActions` -- flexDirection row, gap for Accept/Decline buttons, marginTop
- `acceptButton` and `declineButton` -- flex sizing so they share the row evenly

**Important implementation details:**
- The existing `ListEmptyComponent` prop does not exist on SectionList. Use `renderSectionFooter` for per-section empty states instead.
- Keep the `GroupsListSkeleton` loading state as-is (shown before SectionList renders).
- The existing group card `renderItem` callback should be inlined or extracted as a named function since SectionList needs a single `renderItem` that handles both types.
- Add `fetchInvites` and `fetchGroups` to `useFocusEffect` so the groups list also refreshes when navigating back from a group detail (important: after accepting, going back should show the newly joined group).
  </action>
  <verify>
1. Run: `npx expo export --platform ios 2>&1 | tail -5` -- should compile without errors.
2. Verify SectionList is used: `grep -c 'SectionList' app/\(tabs\)/index.tsx` -- should return at least 1.
3. Verify accept_invite RPC call: `grep 'accept_invite' app/\(tabs\)/index.tsx` -- should match.
4. Verify decline_invite RPC call: `grep 'decline_invite' app/\(tabs\)/index.tsx` -- should match.
5. Verify Alert.alert for decline: `grep 'Alert.alert' app/\(tabs\)/index.tsx` -- should match.
6. Verify toast import: `grep 'useToast' app/\(tabs\)/index.tsx` -- should match.
7. Verify no FlatList remains: `grep -c 'FlatList' app/\(tabs\)/index.tsx` -- should return 0.
  </verify>
  <done>
Home screen displays two sections: "Pending Invites" at top (always visible, with empty state when no invites) and "My Groups" below. Invite cards show group name + inviter name with Accept/Decline buttons. Accept taps call accept_invite RPC, show toast "You joined [Group Name]!", and navigate to group detail. Decline taps show Alert confirmation warning about expense splits, then call decline_invite RPC and silently remove the card. Both sections refresh on focus, pull-to-refresh, and sync-complete.
  </done>
</task>

</tasks>

<verification>
1. Home screen shows "Pending Invites" section at top with invite cards or empty state
2. Home screen shows "My Groups" section below with existing group cards
3. Invite cards display: group name, "Invited by [name]", Accept button, Decline button
4. Tapping Accept calls accept_invite RPC, shows success toast, navigates to group detail
5. Tapping Decline shows Alert with warning, on confirm calls decline_invite RPC, card disappears silently
6. Accept button shows loading spinner while processing
7. Both sections refresh on screen focus (useFocusEffect), pull-to-refresh, and sync-complete
8. Empty state for invites: "No pending invites" with subtext
9. Empty state for groups: existing "Wala pa kay group!" message
10. App compiles without TypeScript errors
</verification>

<success_criteria>
- SectionList replaces FlatList on home screen with two sections
- Invite cards show group name + inviter name per locked decision
- Accept is single-tap with no confirmation (locked decision)
- Accept shows toast "You joined [Group Name]!" and navigates to group detail (locked decision)
- Decline shows Alert warning before proceeding (locked decision)
- Decline removes card silently with no toast (locked decision)
- Pending Invites section always visible with empty state when no invites (locked decision)
- Invites refresh alongside groups on focus, refresh, and sync
</success_criteria>

<output>
After completion, create `.planning/phases/08-invite-ux/08-02-SUMMARY.md`
</output>
