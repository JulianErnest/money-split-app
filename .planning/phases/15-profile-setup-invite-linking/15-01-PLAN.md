---
phase: 15-profile-setup-invite-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/auth-context.tsx
  - app/(auth)/profile-setup.tsx
  - app/(tabs)/profile.tsx
autonomous: true

must_haves:
  truths:
    - "Profile setup screen shows a phone number input with +63 prefix that validates PH mobile format"
    - "Display name field is pre-filled with Apple-provided name on first sign-in"
    - "User cannot save profile without both a valid display name (2+ chars) and valid phone number (10 digits starting with 9)"
    - "Saving profile with a phone number already used by another account shows a clear error message"
    - "After saving profile with phone, pending invites for that phone number are automatically linked"
    - "User without both display_name and phone_number in database is routed to profile-setup"
    - "Profile screen shows phone number from users table only, never Apple relay email"
  artifacts:
    - path: "lib/auth-context.tsx"
      provides: "Updated isNewUser check gating on both display_name AND phone_number"
      contains: "phone_number"
    - path: "app/(auth)/profile-setup.tsx"
      provides: "Phone input field with +63 prefix, Apple name pre-fill, invite linking RPC call, uniqueness error handling"
      contains: "isValidPHPhone"
    - path: "app/(tabs)/profile.tsx"
      provides: "Profile display using only profile.phone_number, no user.phone fallback"
  key_links:
    - from: "app/(auth)/profile-setup.tsx"
      to: "lib/group-members.ts"
      via: "import isValidPHPhone"
      pattern: "isValidPHPhone"
    - from: "app/(auth)/profile-setup.tsx"
      to: "supabase RPC"
      via: "supabase.rpc('link_phone_to_pending_invites')"
      pattern: "link_phone_to_pending_invites"
    - from: "lib/auth-context.tsx"
      to: "supabase users table"
      via: "select display_name, phone_number"
      pattern: "phone_number"
    - from: "app/(auth)/profile-setup.tsx"
      to: "lib/auth-context.tsx"
      via: "useAuth().user.user_metadata.full_name for pre-fill"
      pattern: "user_metadata"
---

<objective>
Complete the profile setup flow so new Apple Sign-In users provide their phone number, get their Apple-provided name pre-filled, and have pending invites automatically linked after saving. Also clean up the profile screen to remove phone OTP vestiges.

Purpose: This is the final phase of v1.3 Apple Sign-In migration. Without this, new users can onboard without a phone number, breaking the invite system that relies on phone-based matching.
Output: Three modified files completing requirements PROF-01 through PROF-06, CLEAN-01 (already done), and CLEAN-02.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-profile-setup-invite-linking/15-RESEARCH.md

@lib/auth-context.tsx
@app/(auth)/profile-setup.tsx
@app/(tabs)/profile.tsx
@lib/group-members.ts
@components/groups/AddMemberModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phone input to profile setup with Apple name pre-fill and invite linking</name>
  <files>lib/auth-context.tsx, app/(auth)/profile-setup.tsx</files>
  <action>
**1. Update `lib/auth-context.tsx` -- isNewUser check (PROF-05):**

In the `checkIsNewUser` function, change the select query from `select("display_name")` to `select("display_name, phone_number")`. Update the condition to check BOTH fields:

```
if (error || !data || !data.display_name || !data.phone_number) {
  setIsNewUser(true);
} else {
  setIsNewUser(false);
}
```

This ensures users who authenticated via Apple Sign-In but have not yet provided a phone number are routed back to profile-setup.

**2. Update `app/(auth)/profile-setup.tsx` -- Full overhaul (PROF-01, 02, 03, 04, 06):**

a) **Add import** for `isValidPHPhone` from `@/lib/group-members`.

b) **Add state** for phone digits: `const [phoneDigits, setPhoneDigits] = useState("")`.

c) **Pre-fill Apple name (PROF-04):** In the existing `useEffect`, add logic to read `user?.user_metadata?.full_name`. If it is a non-empty string, call `setDisplayName(appleName)`. This goes BEFORE the random emoji selection (which stays).

d) **Update validation (PROF-01, PROF-02):** Change `isValid` from `trimmedName.length >= 2` to `trimmedName.length >= 2 && isValidPHPhone(phoneDigits)`. Add a separate `nameValid` and `phoneValid` for per-field error display:
```
const nameValid = trimmedName.length >= 2;
const phoneValid = isValidPHPhone(phoneDigits);
const isValid = nameValid && phoneValid;
```

e) **Phone formatting helper:** Add a local function `formatPhoneInput` that formats digits with spaces for display: "917" -> "917", "917123" -> "917 123", "9171234567" -> "917 123 4567".

f) **Phone change handler:** Strip non-digits, limit to 10 characters. Clear error on valid input when `submitted` is true.

g) **Update handleSubmit (PROF-03, PROF-06):**
- Construct `phoneE164 = \`+63${phoneDigits}\`` before the upsert.
- Change the upsert to use `phone_number: phoneE164` instead of `user.phone ?? null`.
- After the upsert, check for uniqueness constraint error: if `upsertError.code === "23505"` OR `upsertError.message` includes "duplicate key" or "unique", set error to `"This phone number is already registered to another account."`. Otherwise show the raw error.
- After successful upsert, call `supabase.rpc("link_phone_to_pending_invites", { p_phone_number: phoneE164 })`. Log a warning if the RPC fails but do NOT block the flow (non-fatal).
- Then call `refreshProfile()` as before.

h) **Add phone input JSX** after the display name `<Input>` section. Follow the AddMemberModal pattern:
- A label "Phone number" using `<Text variant="label" color="textTertiary">`
- A row with a `+63` prefix `<Text>` and a `<TextInput>` accepting formatted digits
- `keyboardType="number-pad"`, `maxLength={12}` (10 digits + 2 spaces), placeholder "9XX XXX XXXX"
- Style the prefix and input to match the app's dark theme (use `colors.surface` background, `colors.text` for text, `colors.inputPlaceholder` for placeholder)
- Show validation error below: "Enter a valid Philippine mobile number" when `submitted && !phoneValid`

i) **Update validationError display:** Currently shows name error. Update to also handle phone error. The existing `error` state handles API errors. Use the `submitted` flag with `nameValid`/`phoneValid` for field-level errors.

j) **Add styles** for `phoneRow` (flexDirection row, alignItems center, background surface, borderRadius, padding), `prefix` (color textSecondary, marginRight), `phoneInput` (flex 1, color text, fontSize).

**What NOT to do:**
- Do NOT import `formatPhoneDisplay` from group-members -- that formats E.164 for display. Here we format raw input digits with spaces, which is different.
- Do NOT save empty string for phone_number. Always construct with `+63` prefix from validated digits.
- Do NOT use `user.phone` anywhere in the upsert -- Apple users have no `user.phone`.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root. TypeScript compilation should pass (ignoring the 2 pre-existing errors in index.tsx and _layout.tsx).

Grep verification:
- `grep -n "phone_number" lib/auth-context.tsx` should show the select and check
- `grep -n "isValidPHPhone" app/\(auth\)/profile-setup.tsx` should show the import and usage
- `grep -n "link_phone_to_pending_invites" app/\(auth\)/profile-setup.tsx` should show the RPC call
- `grep -n "user_metadata" app/\(auth\)/profile-setup.tsx` should show the Apple name pre-fill
- `grep -n "23505" app/\(auth\)/profile-setup.tsx` should show the uniqueness error handling
  </verify>
  <done>
- auth-context.tsx `checkIsNewUser` selects and checks both `display_name` AND `phone_number`
- profile-setup.tsx has a phone input with +63 prefix, validates with `isValidPHPhone`, pre-fills Apple name from `user_metadata.full_name`, handles uniqueness constraint with user-friendly message, calls `link_phone_to_pending_invites` RPC after successful upsert, and requires both fields before enabling save
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up profile screen and verify no OTP vestiges remain</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
**1. Remove `user?.phone` fallback in `profile.tsx` (CLEAN-02):**

In the `phoneNumber` variable computation (currently lines 110-114), remove the `user?.phone` fallback branch. Change from:

```
const phoneNumber = profile?.phone_number
  ? formatPhone(profile.phone_number)
  : user?.phone
    ? formatPhone(user.phone)
    : "";
```

To:

```
const phoneNumber = profile?.phone_number
  ? formatPhone(profile.phone_number)
  : "";
```

After Phase 15, phone number always comes from `profile.phone_number` (collected during profile setup). The `user.phone` fallback was a vestige of the phone OTP flow and would be undefined for Apple Sign-In users anyway.

**2. Remove `useAuth` import usage for `user?.phone`:** The `user` variable from `useAuth()` is still needed for `user?.id` in the `useEffect` dependency and `user!.id` in the query. Keep the `useAuth` import and destructuring. Just remove the `user?.phone` reference from the phoneNumber computation.

**3. Verify CLEAN-01 is already done:** Run a grep for "OTP", "otp", "phone OTP", "verification code" across the entire `app/` directory. Confirm no phone OTP language remains. The research confirmed CLEAN-01 was completed in Phase 14, but verify it.

**4. Verify CLEAN-02 completeness:** Run a grep for `user\.email`, `user\.phone`, `@privaterelay`, and `relay` across `app/(tabs)/profile.tsx` to confirm no email or old phone references remain.
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compilation should pass (ignoring pre-existing errors).

Grep checks:
- `grep -rn "user?.phone\|user\.phone" app/\(tabs\)/profile.tsx` should return NO matches
- `grep -rn "otp\|OTP\|verification code" app/` should return NO matches in UI-facing files (test files or comments are acceptable)
- `grep -rn "privaterelay\|relay" app/` should return NO matches
- `grep -rn "user\.email\|user?.email" app/\(tabs\)/profile.tsx` should return NO matches
  </verify>
  <done>
- profile.tsx uses only `profile.phone_number` for display, no `user.phone` fallback
- No phone OTP language exists anywhere in the app UI
- No Apple relay email is displayed anywhere in the app
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase success criteria:

1. **PROF-01/02**: `grep -n "isValidPHPhone\|phoneDigits\|number-pad" app/\(auth\)/profile-setup.tsx` confirms phone input with validation
2. **PROF-03**: `grep -n "23505\|already registered" app/\(auth\)/profile-setup.tsx` confirms uniqueness error handling
3. **PROF-04**: `grep -n "user_metadata\|full_name" app/\(auth\)/profile-setup.tsx` confirms Apple name pre-fill
4. **PROF-05**: `grep -n "phone_number" lib/auth-context.tsx` confirms dual-field gating
5. **PROF-06**: `grep -n "link_phone_to_pending_invites" app/\(auth\)/profile-setup.tsx` confirms RPC call
6. **CLEAN-01**: `grep -rn "OTP\|otp" app/` confirms no OTP references remain in UI
7. **CLEAN-02**: `grep -n "user?.phone\|user\.email" app/\(tabs\)/profile.tsx` returns no matches

TypeScript check: `npx tsc --noEmit` passes (ignoring 2 pre-existing cosmetic errors)
</verification>

<success_criteria>
- Profile setup screen has phone input with +63 prefix, validates PH format, pre-fills Apple name
- Both display_name and phone_number are required to complete onboarding
- Phone uniqueness constraint violations show user-friendly error message
- link_phone_to_pending_invites RPC is called after successful profile save
- Profile screen shows only profile.phone_number, no user.phone fallback
- No phone OTP language or Apple relay email appears in the UI
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/15-profile-setup-invite-linking/15-01-SUMMARY.md`
</output>
