---
phase: 16-posthog-analytics-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/analytics.ts
  - app/_layout.tsx
  - app/(tabs)/profile.tsx
autonomous: true
user_setup:
  - service: posthog
    why: "Product analytics"
    env_vars:
      - name: EXPO_PUBLIC_POSTHOG_API_KEY
        source: "PostHog Dashboard -> Project Settings -> Project API Key"

must_haves:
  truths:
    - "PostHog initializes on app launch with debug logging in development"
    - "Navigating between screens produces $screen events with normalized route names"
    - "After profile setup, user is identified in PostHog with display_name, signup_method, and first_sign_in_date"
    - "Signing out calls posthog.reset() before supabase.auth.signOut() to prevent identity leakage"
  artifacts:
    - path: "lib/analytics.ts"
      provides: "PostHog client instance, normalizePathname, 9 typed event helpers"
      contains: "posthogClient"
    - path: "app/_layout.tsx"
      provides: "PostHogProvider wrapper and AnalyticsTracker renderless component"
      contains: "PostHogProvider"
  key_links:
    - from: "app/_layout.tsx"
      to: "lib/analytics.ts"
      via: "import posthogClient"
      pattern: "import.*posthogClient.*from.*lib/analytics"
    - from: "app/_layout.tsx"
      to: "posthog-react-native"
      via: "PostHogProvider with autocapture={false}"
      pattern: "PostHogProvider.*autocapture.*false"
    - from: "app/_layout.tsx"
      to: "usePathname"
      via: "AnalyticsTracker screen tracking"
      pattern: "usePathname.*posthog\\.screen"
    - from: "app/(tabs)/profile.tsx"
      to: "posthog.reset()"
      via: "reset before signOut"
      pattern: "posthog.*reset.*signOut"
---

<objective>
Create the PostHog analytics foundation: standalone client, provider wrapper, automatic screen tracking with route normalization, user identity management, and sign-out reset.

Purpose: This is the analytics infrastructure that all event tracking depends on. Without it, no events can be captured. It covers requirements SETUP-01, SETUP-02, SETUP-03, SCREEN-01, SCREEN-02, IDENT-01, IDENT-02, IDENT-03.
Output: `lib/analytics.ts` with PostHog client + typed event helpers, modified `app/_layout.tsx` with provider + AnalyticsTracker, modified `app/(tabs)/profile.tsx` with reset on sign-out.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-posthog-analytics-integration/16-RESEARCH.md

@lib/supabase.ts
@app/_layout.tsx
@app/(tabs)/profile.tsx
@lib/auth-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/analytics.ts with PostHog client, normalizePathname, and typed event helpers</name>
  <files>lib/analytics.ts</files>
  <action>
Create a new file `lib/analytics.ts` with the following:

1. **PostHog client initialization** (SETUP-01, SETUP-03):
   - `import PostHog from 'posthog-react-native'`
   - Read API key from `process.env.EXPO_PUBLIC_POSTHOG_API_KEY!` (same pattern as `lib/supabase.ts`)
   - Host: `'https://us.i.posthog.com'`
   - `debug: __DEV__` (debug mode only in development)
   - Export as `posthogClient`

2. **normalizePathname function** (SCREEN-02):
   - Export function `normalizePathname(pathname: string): string`
   - Replace dynamic route segments with template names using these 4 regex replacements:
     - `/group/[^/]+/add-expense` -> `/group/[id]/add-expense` (MUST come before the group/[id] replacement)
     - `/group/[^/]+` -> `/group/[id]`
     - `/join/[^/]+` -> `/join/[code]`
     - `/activity` stays as-is (no dynamic segment)
   - Order matters: longer paths first to avoid partial matches

3. **9 typed event tracking helpers** (EVENT-01 through EVENT-09):
   - `trackSignIn(method: 'apple')` -> captures `sign_in` with `{ method }`
   - `trackProfileCompleted(hasAvatar: boolean)` -> captures `profile_completed` with `{ has_avatar }`
   - `trackGroupCreated(groupId: string)` -> captures `group_created` with `{ group_id }`
   - `trackExpenseAdded(data: { groupId: string; amount: number; splitType: string; memberCount: number })` -> captures `expense_added` with `{ group_id, amount, split_type, member_count }`
   - `trackSettleUp(data: { groupId: string; amount: number })` -> captures `settle_up` with `{ group_id, amount }`
   - `trackInviteAccepted(groupId: string)` -> captures `invite_accepted` with `{ group_id }`
   - `trackInviteDeclined(groupId: string)` -> captures `invite_declined` with `{ group_id }`
   - `trackGroupJoinedViaLink(groupId: string)` -> captures `group_joined_via_link` with `{ group_id }`
   - `trackInviteShared(groupId: string)` -> captures `invite_shared` with `{ group_id }`
   - Each helper calls `posthogClient.capture(eventName, properties)`
   - All event names use snake_case per PostHog convention

IMPORTANT: Do NOT use `usePostHog()` hook in this file. This is a standalone module importable from anywhere.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "analytics" || echo "No analytics TypeScript errors"` to confirm the file compiles. Manually verify the file exports posthogClient, normalizePathname, and all 9 track* functions.
  </verify>
  <done>
`lib/analytics.ts` exists with posthogClient (PostHog instance with API key from env var, debug: __DEV__), normalizePathname (4 regex replacements), and 9 typed event helpers that call posthogClient.capture with correct event names and property shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PostHogProvider and AnalyticsTracker to app/_layout.tsx</name>
  <files>app/_layout.tsx</files>
  <action>
Modify `app/_layout.tsx` to add PostHog provider wrapping and automatic screen/identity tracking:

1. **Add imports:**
   - `import { PostHogProvider } from 'posthog-react-native'`
   - `import { usePostHog } from 'posthog-react-native'`
   - `import { usePathname } from 'expo-router'` (usePathname is NOT already imported -- existing imports are useFonts, Stack, useRouter, useSegments)
   - `import { posthogClient, normalizePathname } from '@/lib/analytics'`

2. **Create AnalyticsTracker renderless component** (SCREEN-01, SCREEN-02, IDENT-01, IDENT-02):
   - Define `function AnalyticsTracker()` that returns `null`
   - Place it AFTER the existing `SyncWatcher` component definition (before `RootLayout`)
   - Inside, use: `const pathname = usePathname()`, `const posthog = usePostHog()`, `const { session, isNewUser, user } = useAuth()`
   - **Screen tracking useEffect** (dep: `[pathname]`):
     - Guard: `if (!posthog || !pathname) return`
     - Call `posthog.screen(normalizePathname(pathname))`
   - **Identity useEffect** (dep: `[session, isNewUser]`):
     - Guard: `if (!posthog || !session?.user) return`
     - Only identify when `isNewUser === false` (profile setup complete)
     - Call `posthog.identify(session.user.id, { $set: { display_name: user?.user_metadata?.full_name || session.user.email || 'Unknown' }, $set_once: { signup_method: 'apple', first_sign_in_date: new Date().toISOString() } })`
     - Note: To get display_name, check if auth-context exposes a profile/user object. If `user` from `useAuth()` has `user_metadata.full_name`, use that. Otherwise use the Supabase user email as fallback.
   - DO NOT add a session-null reset effect here. IDENT-03 reset is handled explicitly in profile.tsx sign-out handler (see Task 3).

3. **Wrap with PostHogProvider** (SETUP-02):
   - In `RootLayout` return, wrap the existing tree with `<PostHogProvider client={posthogClient} autocapture={false}>` OUTSIDE `<AuthProvider>` but INSIDE `<GestureHandlerRootView>`
   - Place `<AnalyticsTracker />` inside both PostHogProvider AND AuthProvider (it needs both), right before `<SyncWatcher />`
   - CRITICAL: `autocapture={false}` is mandatory. Do NOT use `autocapture={{ captureScreens: false, captureTouches: false }}`. Use the boolean shorthand `autocapture={false}`.

Final provider hierarchy:
```
GestureHandlerRootView
  PostHogProvider (client={posthogClient}, autocapture={false})
    AuthProvider
      NetworkProvider
        ToastProvider
          BottomSheetModalProvider
            AnalyticsTracker (NEW)
            SyncWatcher
            RootNavigator
            OfflineBanner
            StatusBar
```
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0 errors"` to check TypeScript compiles (expect pre-existing errors only from index.tsx and _layout.tsx segments). Run `npx expo start` briefly to confirm app launches without crash (no `useNavigationState` error).
  </verify>
  <done>
`app/_layout.tsx` has PostHogProvider wrapping the app tree (outside AuthProvider, autocapture={false}), AnalyticsTracker component that tracks screens via usePathname + normalizePathname and identifies users when isNewUser becomes false with correct $set and $set_once properties.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add posthog.reset() before sign-out in profile.tsx</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
Modify `app/(tabs)/profile.tsx` to call `posthog.reset()` before `supabase.auth.signOut()` (IDENT-03):

1. **Add import:** `import { posthogClient } from '@/lib/analytics'`

2. **Modify `handleSignOut` function:**
   - In the destructive button's `onPress` async callback (line ~82-89), add `posthogClient.reset()` BEFORE `await supabase.auth.signOut()`
   - This ensures the PostHog identity is cleared synchronously before the auth state changes
   - The call is: `posthogClient.reset()` (using the standalone client, not the hook -- simpler and guaranteed to work)

The modified onPress should look like:
```typescript
onPress: async () => {
  setSigningOut(true);
  try {
    posthogClient.reset(); // Clear PostHog identity BEFORE sign-out
    await supabase.auth.signOut();
  } catch {
    setSigningOut(false);
    Alert.alert("Error", "Failed to sign out. Please try again.");
  }
},
```
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep "profile" || echo "No profile.tsx TypeScript errors"`. Verify the import exists and `posthogClient.reset()` appears before `supabase.auth.signOut()`.
  </verify>
  <done>
`app/(tabs)/profile.tsx` imports `posthogClient` from `@/lib/analytics` and calls `posthogClient.reset()` immediately before `supabase.auth.signOut()` in the sign-out handler, preventing identity leakage between sessions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` produces no NEW TypeScript errors (pre-existing errors in index.tsx and _layout.tsx are acceptable)
2. `lib/analytics.ts` exports: posthogClient, normalizePathname, trackSignIn, trackProfileCompleted, trackGroupCreated, trackExpenseAdded, trackSettleUp, trackInviteAccepted, trackInviteDeclined, trackGroupJoinedViaLink, trackInviteShared
3. `app/_layout.tsx` contains PostHogProvider with autocapture={false} wrapping AuthProvider
4. `app/_layout.tsx` contains AnalyticsTracker component with usePathname screen tracking and identify logic
5. `app/(tabs)/profile.tsx` calls posthogClient.reset() before supabase.auth.signOut()
</verification>

<success_criteria>
- PostHog SDK initializes with API key from environment variable and debug mode in dev
- Screen views are tracked on every route change with normalized paths (e.g., /group/[id] not /group/abc123)
- Users are identified after profile setup with display_name ($set), signup_method ($set_once), first_sign_in_date ($set_once)
- Sign-out clears PostHog identity before Supabase sign-out
- All 9 typed event helpers exist and are importable for Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/16-posthog-analytics-integration/16-01-SUMMARY.md`
</output>
