---
phase: 16-posthog-analytics-integration
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - app/(auth)/sign-in.tsx
  - app/(auth)/profile-setup.tsx
  - app/(tabs)/index.tsx
  - app/group/[id].tsx
  - app/group/[id]/add-expense.tsx
  - app/join/[code].tsx
  - components/settlements/SettleConfirmSheet.tsx
autonomous: true

must_haves:
  truths:
    - "Signing in with Apple produces a sign_in event with method: apple"
    - "Completing profile setup produces a profile_completed event with has_avatar boolean"
    - "Creating a group produces a group_created event with group_id"
    - "Adding an expense produces an expense_added event with group_id, amount, split_type, member_count"
    - "Settling up produces a settle_up event with group_id and amount"
    - "Accepting an invite produces an invite_accepted event with group_id"
    - "Declining an invite produces an invite_declined event with group_id"
    - "Joining via deep link produces a group_joined_via_link event with group_id"
    - "Sharing an invite produces an invite_shared event with group_id"
  artifacts:
    - path: "app/(auth)/sign-in.tsx"
      provides: "sign_in event capture"
      contains: "trackSignIn"
    - path: "app/(auth)/profile-setup.tsx"
      provides: "profile_completed event capture"
      contains: "trackProfileCompleted"
    - path: "app/(tabs)/index.tsx"
      provides: "group_created, invite_accepted, invite_declined event captures"
      contains: "trackGroupCreated"
    - path: "app/group/[id]/add-expense.tsx"
      provides: "expense_added event capture"
      contains: "trackExpenseAdded"
    - path: "components/settlements/SettleConfirmSheet.tsx"
      provides: "settle_up event capture"
      contains: "trackSettleUp"
    - path: "app/join/[code].tsx"
      provides: "group_joined_via_link event capture"
      contains: "trackGroupJoinedViaLink"
    - path: "app/group/[id].tsx"
      provides: "invite_shared event capture"
      contains: "trackInviteShared"
  key_links:
    - from: "app/(auth)/sign-in.tsx"
      to: "lib/analytics.ts"
      via: "import trackSignIn"
      pattern: "import.*trackSignIn.*from.*lib/analytics"
    - from: "app/(tabs)/index.tsx"
      to: "lib/analytics.ts"
      via: "import trackGroupCreated, trackInviteAccepted, trackInviteDeclined"
      pattern: "import.*trackGroupCreated.*from.*lib/analytics"
    - from: "components/settlements/SettleConfirmSheet.tsx"
      to: "lib/analytics.ts"
      via: "import trackSettleUp"
      pattern: "import.*trackSettleUp.*from.*lib/analytics"
---

<objective>
Wire all 9 core product events into existing screen handlers by importing typed helpers from lib/analytics.ts and calling them at the exact insertion points after each RPC/action succeeds.

Purpose: This completes the analytics instrumentation (EVENT-01 through EVENT-09) so the full product loop is tracked in PostHog.
Output: 7 modified files, each with one or more trackXxx() calls at the right insertion points.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-posthog-analytics-integration/16-RESEARCH.md
@.planning/phases/16-posthog-analytics-integration/16-01-SUMMARY.md

@lib/analytics.ts
@app/(auth)/sign-in.tsx
@app/(auth)/profile-setup.tsx
@app/(tabs)/index.tsx
@app/group/[id].tsx
@app/group/[id]/add-expense.tsx
@app/join/[code].tsx
@components/settlements/SettleConfirmSheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sign_in and profile_completed events in auth screens</name>
  <files>app/(auth)/sign-in.tsx, app/(auth)/profile-setup.tsx</files>
  <action>
**sign-in.tsx (EVENT-01: sign_in):**
1. Add import: `import { trackSignIn } from '@/lib/analytics'`
2. In `handleSignIn()`, after `signInWithIdToken` succeeds (after the `if (signInError)` guard returns, around line 91), add:
   `trackSignIn('apple');`
   Place it BEFORE the fullName update block (`if (credential.fullName?.givenName)`). The sign-in has already succeeded at this point.

**profile-setup.tsx (EVENT-02: profile_completed):**
1. Add import: `import { trackProfileCompleted } from '@/lib/analytics'`
2. In `handleSubmit()`, after `refreshProfile()` succeeds (line ~121, after `await refreshProfile()`), add:
   `trackProfileCompleted(selectedEmoji !== '');`
   The `selectedEmoji` is always set (random on mount), so `has_avatar` will be `true` when any emoji is selected. This correctly reflects that the user has an avatar. Place the call right after `await refreshProfile()` and before the catch block.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(sign-in|profile-setup)" || echo "No auth screen TypeScript errors"`. Verify `trackSignIn` appears in sign-in.tsx and `trackProfileCompleted` appears in profile-setup.tsx.
  </verify>
  <done>
sign-in.tsx calls `trackSignIn('apple')` after successful Apple sign-in. profile-setup.tsx calls `trackProfileCompleted(selectedEmoji !== '')` after successful profile save and refresh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire group_created, invite_accepted, invite_declined events in home screen</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
1. Add import: `import { trackGroupCreated, trackInviteAccepted, trackInviteDeclined } from '@/lib/analytics'`

**group_created (EVENT-03):**
In `handleCreateGroup()`, the `create_group` RPC returns a string (the group_id) according to `database.types.ts`. Currently the code only destructures `{ error }`. Change to `{ data, error }` and add the track call:
- Change line `const { error } = await supabase.rpc("create_group", {` to `const { data, error } = await supabase.rpc("create_group", {`
- After the `if (error)` guard block (after line ~512), add: `trackGroupCreated(data as string);`
- Place it before `setNewGroupName("")` (line ~514)

**invite_accepted (EVENT-06):**
In `handleAcceptInvite()`, after `accept_invite` RPC succeeds and before removing from local state (around line 400), add:
`trackInviteAccepted(groupId as string);`
The `data: groupId` is already destructured from the RPC response and contains the group_id string.

**invite_declined (EVENT-07):**
In `handleDeclineInvite()`, inside the destructive `onPress` handler, after `decline_invite` RPC succeeds and after the `if (error)` guard returns (around line 446), add:
`trackInviteDeclined(invite.group_id);`
The `invite` object has a `group_id` property (it is an InviteRow from the pending invites query). Check the InviteRow type to confirm the correct property name -- if it's `group_id`, use that. If the type uses a different field, check the invite object shape.

NOTE: The `handleAcceptInvite` and `handleDeclineInvite` are wrapped in `useCallback`. After adding imports, add `trackGroupCreated`, `trackInviteAccepted`, `trackInviteDeclined` to the dependency arrays if the linter requires it (though since they are module-level imports, not state, they don't need to be in deps -- but check the existing pattern in the file).
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep "index.tsx" || echo "No index.tsx TypeScript errors"`. Verify trackGroupCreated, trackInviteAccepted, trackInviteDeclined are all imported and called at the right locations.
  </verify>
  <done>
index.tsx captures `group_created` with group_id after create_group RPC, `invite_accepted` with group_id after accept_invite RPC, and `invite_declined` with group_id after decline_invite RPC.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire expense_added, settle_up, group_joined_via_link, and invite_shared events</name>
  <files>app/group/[id]/add-expense.tsx, components/settlements/SettleConfirmSheet.tsx, app/join/[code].tsx, app/group/[id].tsx</files>
  <action>
**add-expense.tsx (EVENT-04: expense_added):**
1. Add import: `import { trackExpenseAdded } from '@/lib/analytics'`
2. In `handleSubmit()`, after `create_expense` RPC succeeds (after the `if (error)` guard around line 228) and BEFORE `router.back()` (line ~231), add:
   ```
   trackExpenseAdded({
     groupId: groupId!,
     amount: centavos / 100,
     splitType: splitType,
     memberCount: selectedMemberIds.length,
   });
   ```
   The variables `groupId`, `centavos`, `splitType`, and `selectedMemberIds` are all in scope from the component.

**SettleConfirmSheet.tsx (EVENT-05: settle_up):**
1. Add import: `import { trackSettleUp } from '@/lib/analytics'`
2. In `handleConfirmSettle()`, after `record_settlement` RPC succeeds (after the `if (error)` guard around line 65) and BEFORE the haptic/toast success calls (line ~67), add:
   ```
   trackSettleUp({ groupId, amount: amountCentavos / 100 });
   ```
   Both `groupId` and `amountCentavos` are available from the component props.

**join/[code].tsx (EVENT-08: group_joined_via_link):**
1. Add import: `import { trackGroupJoinedViaLink } from '@/lib/analytics'`
2. In `joinGroup()`, after the group info is fetched and before `setState("success")` (around line 133), add:
   ```
   trackGroupJoinedViaLink(data as string);
   ```
   The `data` variable from the `join_group_by_invite` RPC contains the group_id.

**group/[id].tsx (EVENT-09: invite_shared):**
1. Add import: `import { trackInviteShared } from '@/lib/analytics'`
2. In `handleShare()`, after `Share.share()` is called (around line 293), add:
   ```
   trackInviteShared(group!.id);
   ```
   Fire on intent (Share.share was called), not on delivery (we cannot know if user completed the share). Place it after the `await Share.share(...)` call, inside the try block. The `group` variable is available from state and has an `id` property. Use `group!.id` since we already guard `if (!group) return` at the top.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0 errors"` to verify no new TypeScript errors. Verify each file has the correct import and track call by searching: `grep -n "track" app/group/\[id\]/add-expense.tsx app/group/\[id\].tsx app/join/\[code\].tsx components/settlements/SettleConfirmSheet.tsx`.
  </verify>
  <done>
add-expense.tsx captures expense_added with group_id/amount/split_type/member_count. SettleConfirmSheet.tsx captures settle_up with group_id/amount. join/[code].tsx captures group_joined_via_link with group_id. group/[id].tsx captures invite_shared with group_id. All 9 events are now instrumented.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` produces no NEW TypeScript errors (pre-existing errors in index.tsx and _layout.tsx are acceptable)
2. All 9 event track calls exist in the correct files:
   - `grep -rn "trackSignIn\|trackProfileCompleted\|trackGroupCreated\|trackExpenseAdded\|trackSettleUp\|trackInviteAccepted\|trackInviteDeclined\|trackGroupJoinedViaLink\|trackInviteShared" app/ components/` shows 9 unique calls across 7 files
3. Each track call appears AFTER the corresponding RPC/action succeeds and BEFORE navigation/cleanup
4. No track call fires on error paths (all are guarded by error checks above them)
</verification>

<success_criteria>
- All 9 named events are captured at the correct insertion points in the codebase
- Each event fires only after the corresponding action succeeds (no tracking on error paths)
- Event properties match the specification: correct property names (snake_case) and types
- Walking through the complete product loop (sign in, profile setup, create group, add expense, settle up, share invite, accept invite, decline invite, join via link) would produce all 9 events in PostHog
</success_criteria>

<output>
After completion, create `.planning/phases/16-posthog-analytics-integration/16-02-SUMMARY.md`
</output>
