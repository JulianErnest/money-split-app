---
phase: 14-core-auth-replacement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(auth)/sign-in.tsx
autonomous: true

must_haves:
  truths:
    - "Apple Sign-In screen exists with HIG-compliant AppleAuthenticationButton"
    - "Nonce-based signInWithIdToken flow exchanges Apple credential for Supabase session"
    - "User cancellation of Apple dialog is handled silently without error display"
    - "Apple Sign-In availability is checked before rendering the button"
    - "Apple-provided fullName is captured immediately on first authorization"
  artifacts:
    - path: "app/(auth)/sign-in.tsx"
      provides: "Apple Sign-In screen with nonce-based auth flow"
      min_lines: 80
      contains: "signInWithIdToken"
  key_links:
    - from: "app/(auth)/sign-in.tsx"
      to: "supabase.auth.signInWithIdToken"
      via: "Apple credential identity token exchange"
      pattern: "signInWithIdToken.*provider.*apple"
    - from: "app/(auth)/sign-in.tsx"
      to: "supabase.auth.updateUser"
      via: "fullName capture on first sign-in"
      pattern: "updateUser.*full_name"
    - from: "app/(auth)/sign-in.tsx"
      to: "expo-apple-authentication"
      via: "AppleAuthenticationButton and signInAsync"
      pattern: "AppleAuthentication\\.signInAsync"
---

<objective>
Create the Apple Sign-In screen with nonce-based authentication flow, replacing the phone OTP entry point.

Purpose: This is the core new screen for Phase 14 -- the Apple Sign-In UI that triggers the native iOS dialog (Face ID / Touch ID) and exchanges the Apple identity token for a Supabase session. Covers AUTH-01, AUTH-02, AUTH-03, AUTH-04 requirements.
Output: `app/(auth)/sign-in.tsx` -- a fully functional Apple Sign-In screen with background image carousel, availability check, nonce-based signInWithIdToken flow, cancellation handling, and fullName capture.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-core-auth-replacement/14-RESEARCH.md
@.planning/phases/13-database-infrastructure-prep/13-02-SUMMARY.md
@app/(auth)/phone.tsx
@lib/supabase.ts
@theme/index.ts
@components/ui/Text.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-crypto and create Apple Sign-In screen</name>
  <files>app/(auth)/sign-in.tsx</files>
  <action>
First, install expo-crypto:
```bash
npx expo install expo-crypto
```

Then create `app/(auth)/sign-in.tsx` with the following implementation:

1. **Availability check (AUTH-04):** Use `AppleAuthentication.isAvailableAsync()` in a `useEffect` to set an `isAvailable` state. If unavailable, show fallback text "Apple Sign-In is not available on this device."

2. **Background image carousel:** Reuse the exact carousel pattern from the existing `phone.tsx` -- same `CAROUSEL_IMAGES` array (require the 3 friends images from `@/assets/images/auth/`), same 5-second interval, same fade animation with `Animated.timing` (600ms crossfade). Same dark overlay with `rgba(13,13,13,0.75)`.

3. **Header:** Same KKB branding header from phone.tsx -- `Text variant="h1" color="accent"` for "KKB", `Text variant="body" color="textSecondary"` for "Split expenses with your barkada".

4. **Apple Sign-In button (AUTH-01):** Use `AppleAuthentication.AppleAuthenticationButton` with:
   - `buttonType`: `SIGN_IN`
   - `buttonStyle`: `WHITE`
   - `cornerRadius`: 8
   - `style`: `{ width: "100%", height: 56 }` -- CRITICAL: explicit height/width required or button won't render
   - `onPress`: calls `handleSignIn`

5. **handleSignIn function (AUTH-02):** Implement the nonce-based flow:
   - Guard against double-tap with `loading` state
   - Generate raw nonce: `Crypto.randomUUID()`
   - Hash nonce: `await Crypto.digestStringAsync(Crypto.CryptoDigestAlgorithm.SHA256, rawNonce)`
   - Call `AppleAuthentication.signInAsync({ requestedScopes: [FULL_NAME, EMAIL], nonce: hashedNonce })`
   - Check `credential.identityToken` exists (if not, show error)
   - Exchange token: `await supabase.auth.signInWithIdToken({ provider: "apple", token: credential.identityToken, nonce: rawNonce })`
   - If signInError, display it
   - **CRITICAL: Capture fullName immediately** (Apple only provides it on first auth, data is lost forever otherwise):
     - Check `credential.fullName?.givenName`
     - If present, build fullName from givenName + familyName
     - Call `await supabase.auth.updateUser({ data: { full_name, given_name, family_name } })`
   - AuthProvider's `onAuthStateChange` handles navigation automatically -- do NOT manually navigate

6. **Cancellation handling (AUTH-03):** In the catch block, check `e.code === "ERR_REQUEST_CANCELED"`. If so, return silently (no error shown). Otherwise, set error to "Sign-in failed. Please try again."

7. **Error display:** Show error text between header and button using `Text variant="caption" color="error"`.

8. **Styling:** Match the existing phone.tsx aesthetic -- dark background, overlay, centered layout with `justifyContent: "center"` and `paddingHorizontal: spacing[6]`. Use existing theme tokens (colors, spacing) from `@/theme`.

Imports needed:
- `* as AppleAuthentication from "expo-apple-authentication"`
- `* as Crypto from "expo-crypto"`
- React, useState, useEffect, useRef from react
- Animated, ImageBackground, SafeAreaView, StyleSheet, View from react-native
- Text from `@/components/ui/Text`
- supabase from `@/lib/supabase`
- colors, spacing from `@/theme`

Reference the complete code example in 14-RESEARCH.md "Complete Sign-In Screen" section.
  </action>
  <verify>
1. `npx tsc --noEmit` -- should compile without new errors (pre-existing errors in index.tsx and _layout.tsx are acceptable)
2. Verify file exists: `ls app/(auth)/sign-in.tsx`
3. Verify expo-crypto installed: `grep "expo-crypto" package.json`
4. Verify key patterns present in the file:
   - `signInWithIdToken` (Supabase token exchange)
   - `signInAsync` (Apple dialog trigger)
   - `ERR_REQUEST_CANCELED` (cancellation handling)
   - `isAvailableAsync` (availability check)
   - `updateUser` (fullName capture)
   - `AppleAuthenticationButton` (HIG-compliant button)
   - `randomUUID` (nonce generation)
   - `digestStringAsync` (nonce hashing)
  </verify>
  <done>
- `app/(auth)/sign-in.tsx` exists with complete Apple Sign-In implementation
- expo-crypto is in package.json dependencies
- TypeScript compiles without new errors
- All 6 AUTH requirements addressed in the implementation (AUTH-01 button, AUTH-02 token exchange, AUTH-03 cancellation, AUTH-04 availability check)
- fullName captured on first authorization before any navigation
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (ignoring pre-existing errors)
- sign-in.tsx contains all key patterns: signInWithIdToken, signInAsync, ERR_REQUEST_CANCELED, isAvailableAsync, updateUser, AppleAuthenticationButton
- expo-crypto in package.json
</verification>

<success_criteria>
- Apple Sign-In screen is created and TypeScript-valid
- Nonce-based signInWithIdToken flow is implemented correctly (hashed nonce to Apple, raw nonce to Supabase)
- Cancellation returns silently, errors display to user
- Availability check guards button rendering
- fullName is captured immediately on first sign-in
</success_criteria>

<output>
After completion, create `.planning/phases/14-core-auth-replacement/14-01-SUMMARY.md`
</output>
