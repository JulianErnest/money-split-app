---
phase: 14-core-auth-replacement
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - app/(auth)/phone.tsx
  - app/(auth)/otp.tsx
  - app/(auth)/_layout.tsx
  - app/_layout.tsx
  - app/join/[code].tsx
  - app/(auth)/profile-setup.tsx
  - app/(tabs)/profile.tsx
autonomous: true

must_haves:
  truths:
    - "Phone OTP screens (phone.tsx, otp.tsx) no longer exist in the app"
    - "All navigation routes point to the Apple Sign-In screen with no dead references to phone auth"
    - "Profile setup sends null (not empty string) for phone_number when user has no phone"
    - "Sign-out message references Apple Sign-In, not phone verification"
  artifacts:
    - path: "app/(auth)/_layout.tsx"
      provides: "Auth layout with sign-in screen replacing phone/otp"
      contains: "sign-in"
    - path: "app/_layout.tsx"
      provides: "Root layout routing to sign-in instead of phone"
      contains: "sign-in"
    - path: "app/join/[code].tsx"
      provides: "Join flow routing to sign-in instead of phone"
      contains: "sign-in"
  key_links:
    - from: "app/_layout.tsx"
      to: "app/(auth)/sign-in.tsx"
      via: "router.replace for unauthenticated users"
      pattern: 'replace.*auth.*sign-in'
    - from: "app/join/[code].tsx"
      to: "app/(auth)/sign-in.tsx"
      via: "router.replace for unauthenticated join"
      pattern: 'replace.*auth.*sign-in'
    - from: "app/(auth)/profile-setup.tsx"
      to: "supabase users table"
      via: "upsert with null phone_number"
      pattern: 'phone_number.*user\.phone.*null'
---

<objective>
Remove phone OTP auth flow and update all routing references to point to the new Apple Sign-In screen.

Purpose: Completes the auth replacement by deleting dead code (phone.tsx, otp.tsx), updating all navigation references from `/(auth)/phone` to `/(auth)/sign-in`, fixing the profile-setup phone_number empty string bug, and updating the sign-out message. Covers AUTH-05, AUTH-06 requirements.
Output: Clean codebase with no phone OTP references, all routes pointing to Apple Sign-In, and no empty-string phone_number bugs.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-core-auth-replacement/14-RESEARCH.md
@.planning/phases/14-core-auth-replacement/14-01-SUMMARY.md
@app/(auth)/_layout.tsx
@app/_layout.tsx
@app/join/[code].tsx
@app/(auth)/profile-setup.tsx
@app/(tabs)/profile.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete phone OTP screens and update auth layout</name>
  <files>
    app/(auth)/phone.tsx
    app/(auth)/otp.tsx
    app/(auth)/_layout.tsx
  </files>
  <action>
1. **Delete phone.tsx (AUTH-05):**
   ```bash
   rm app/(auth)/phone.tsx
   ```

2. **Delete otp.tsx (AUTH-05):**
   ```bash
   rm app/(auth)/otp.tsx
   ```

3. **Update auth layout (AUTH-06):** Edit `app/(auth)/_layout.tsx` to replace the phone and otp Stack.Screen entries with a single sign-in entry:
   - Remove: `<Stack.Screen name="phone" />` and `<Stack.Screen name="otp" />`
   - Add: `<Stack.Screen name="sign-in" />`
   - Keep: `<Stack.Screen name="profile-setup" />`

   The result should be:
   ```typescript
   import { Stack } from "expo-router";
   import { colors } from "@/theme";

   export default function AuthLayout() {
     return (
       <Stack
         screenOptions={{
           headerShown: false,
           contentStyle: { backgroundColor: colors.background },
         }}
       >
         <Stack.Screen name="sign-in" />
         <Stack.Screen name="profile-setup" />
       </Stack>
     );
   }
   ```
  </action>
  <verify>
1. `ls app/(auth)/phone.tsx` should return "No such file or directory"
2. `ls app/(auth)/otp.tsx` should return "No such file or directory"
3. `ls app/(auth)/sign-in.tsx` should exist (created by Plan 01)
4. `grep "phone\|otp" app/(auth)/_layout.tsx` should return no matches
5. `grep "sign-in" app/(auth)/_layout.tsx` should match
  </verify>
  <done>
- phone.tsx and otp.tsx are deleted
- Auth layout references sign-in and profile-setup only
- No references to phone or otp in the auth layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all routing references and fix profile bugs</name>
  <files>
    app/_layout.tsx
    app/join/[code].tsx
    app/(auth)/profile-setup.tsx
    app/(tabs)/profile.tsx
  </files>
  <action>
1. **Update root layout routing (AUTH-06):** In `app/_layout.tsx`, change line 39:
   - From: `router.replace("/(auth)/phone");`
   - To: `router.replace("/(auth)/sign-in");`
   - This is in the `RootNavigator` function's `useEffect`, the `if (!session && !inAuthGroup)` branch.
   - Do NOT change anything else in this file.

2. **Update join flow routing (AUTH-06):** In `app/join/[code].tsx`, change line 254:
   - From: `onPress={() => router.replace("/(auth)/phone")}`
   - To: `onPress={() => router.replace("/(auth)/sign-in")}`
   - This is in the "unauthenticated" state's "Go to Sign In" button.
   - Do NOT change anything else in this file.

3. **Fix profile-setup phone_number bug (CRITICAL):** In `app/(auth)/profile-setup.tsx`, change line 58:
   - From: `phone_number: user.phone ?? "",`
   - To: `phone_number: user.phone ?? null,`
   - This prevents the UNIQUE constraint violation when multiple Apple users complete profile setup. The empty string `""` violates the unique constraint on phone_number for the second Apple user. With `null`, PostgreSQL allows multiple NULL values in a UNIQUE column.
   - Do NOT change anything else in this file.

4. **Update sign-out message:** In `app/(tabs)/profile.tsx`, change line 76:
   - From: `"You'll need to verify your phone number again to sign back in.",`
   - To: `"You'll need to sign in with Apple again to access your account.",`
   - This is in the `handleSignOut` function's `Alert.alert` call.
   - Do NOT change anything else in this file.
  </action>
  <verify>
1. `npx tsc --noEmit` -- should compile without new errors (pre-existing errors acceptable)
2. `grep -r "/(auth)/phone" app/` should return NO matches (all references updated)
3. `grep -r "/(auth)/otp" app/` should return NO matches
4. `grep "sign-in" app/_layout.tsx` should match the updated route
5. `grep "sign-in" app/join/\[code\].tsx` should match the updated route
6. `grep "phone_number.*null" app/\(auth\)/profile-setup.tsx` should match
7. `grep "sign in with Apple" app/\(tabs\)/profile.tsx` should match
  </verify>
  <done>
- Root layout routes unauthenticated users to `/(auth)/sign-in`
- Join flow routes unauthenticated users to `/(auth)/sign-in`
- Profile setup sends `null` instead of empty string for phone_number
- Sign-out message references Apple Sign-In
- No references to `/(auth)/phone` or `/(auth)/otp` exist anywhere in the app
- TypeScript compiles without new errors
  </done>
</task>

</tasks>

<verification>
Complete codebase check:
1. `npx tsc --noEmit` passes (ignoring pre-existing errors)
2. `grep -r "/(auth)/phone" app/` returns NO matches
3. `grep -r "/(auth)/otp" app/` returns NO matches
4. `grep -r "signInWithOtp" app/` returns NO matches (all OTP code removed)
5. `ls app/(auth)/` shows: sign-in.tsx, profile-setup.tsx, _layout.tsx (no phone.tsx, no otp.tsx)
6. `grep "phone_number.*null" app/(auth)/profile-setup.tsx` confirms null not empty string
</verification>

<success_criteria>
- Phone OTP screens (phone.tsx, otp.tsx) are deleted from the codebase
- All 3 routing references updated from phone to sign-in (auth layout, root layout, join flow)
- Profile setup sends null for phone_number (not empty string)
- Sign-out message is auth-agnostic (references Apple Sign-In)
- Zero references to `/(auth)/phone` or `signInWithOtp` in the codebase
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/14-core-auth-replacement/14-02-SUMMARY.md`
</output>
