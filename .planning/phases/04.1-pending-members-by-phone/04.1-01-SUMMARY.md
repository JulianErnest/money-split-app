---
phase: "04.1"
plan: "01"
subsystem: "database"
tags: ["pending-members", "migrations", "triggers", "rpc", "supabase"]
dependency-graph:
  requires: ["01-01", "02-02", "04-01"]
  provides: ["pending_members table", "auto-link trigger", "add_pending_member RPC", "updated create_expense RPC"]
  affects: ["04.1-02", "04.1-03", "05-*"]
tech-stack:
  added: []
  patterns: ["pending member placeholder pattern", "auth.users INSERT trigger for auto-linking", "CHECK constraint for exclusive-or nullable FKs", "partial unique indexes"]
key-files:
  created:
    - supabase/migrations/00005_pending_members.sql
    - supabase/migrations/00006_update_expense_splits_pending.sql
    - supabase/migrations/00007_auto_link_trigger.sql
    - supabase/migrations/00008_pending_member_rpcs.sql
  modified: []
decisions:
  - id: "04.1-01-d1"
    decision: "Inner BEGIN...EXCEPTION per loop iteration in trigger"
    rationale: "If one pending member claim fails, others still proceed; outer catch ensures signup never blocked"
  - id: "04.1-01-d2"
    decision: "Trigger creates public.users row before group_members insert"
    rationale: "group_members FK references public.users(id); row must exist before INSERT; profile-setup upsert fills display_name later"
metrics:
  duration: "~1min"
  completed: "2026-02-18"
---

# Phase 4.1 Plan 01: Database Foundation for Pending Members Summary

Database migrations enabling phone-number-identified pending members with auto-link trigger on signup and updated RPCs for pending-aware expense creation.

## What Was Done

### Task 1: Create pending_members table and alter expense_splits
- Created `pending_members` table with `group_id`, `phone_number` (E.164), `added_by`, `UNIQUE(group_id, phone_number)`
- Enabled RLS with SELECT/INSERT/DELETE policies using `get_user_group_ids()` helper
- Added indexes on `phone_number` and `group_id`
- Made `expense_splits.user_id` nullable
- Added `pending_member_id` column with FK to `pending_members(id) ON DELETE SET NULL`
- Added CHECK constraint: `num_nonnulls(user_id, pending_member_id) = 1`
- Replaced unique constraint with partial unique indexes for both `user_id` and `pending_member_id`

### Task 2: Create auto-link trigger and RPC functions
- Created `handle_pending_member_claim()` trigger function (SECURITY DEFINER) on `auth.users` INSERT
- Trigger logic per pending match: create `public.users` row, insert `group_members`, update `expense_splits`, delete `pending_members`
- Double exception handling (inner per-iteration + outer) ensures signup is never blocked
- Created `add_pending_member` RPC with auth check, group membership verification, existing user detection, duplicate prevention
- Updated `create_expense` RPC to accept `pending_member_id` in splits JSONB array while remaining backward compatible

## Task Commits

| Task | Name | Commit | Key Files |
|------|------|--------|-----------|
| 1 | Create pending_members table and alter expense_splits | 95dd8bb | 00005_pending_members.sql, 00006_update_expense_splits_pending.sql |
| 2 | Create auto-link trigger and RPC functions | 4051d74 | 00007_auto_link_trigger.sql, 00008_pending_member_rpcs.sql |

## Decisions Made

| ID | Decision | Rationale |
|----|----------|-----------|
| 04.1-01-d1 | Inner BEGIN...EXCEPTION per loop iteration in trigger | If one pending member claim fails, others still proceed; outer catch ensures signup never blocked |
| 04.1-01-d2 | Trigger creates public.users row before group_members insert | group_members FK references public.users(id); row must exist before INSERT; profile-setup upsert fills display_name later |

## Deviations from Plan

None -- plan executed exactly as written.

## Next Phase Readiness

All 4 migration files are ready for the frontend integration in plans 04.1-02 and 04.1-03. The `add_pending_member` RPC and updated `create_expense` RPC provide the API surface needed for the UI layer.

## Self-Check: PASSED
