---
phase: 04.1-pending-members-by-phone
plan: 03
subsystem: expenses
tags: [pending-members, splits, expense-wizard, expense-detail]

dependency-graph:
  requires: [04.1-01, 04.1-02]
  provides: [pending-member-expense-splits, expense-detail-pending-display]
  affects: [05-settlements]

tech-stack:
  added: []
  patterns: [unified-member-type, conditional-split-payload]

key-files:
  created: []
  modified:
    - app/group/[id]/add-expense.tsx
    - components/expenses/MemberSelector.tsx
    - components/expenses/CustomSplitRow.tsx
    - app/group/[id]/expense/[expenseId].tsx

decisions:
  - id: pending-split-payload
    choice: "Conditional user_id vs pending_member_id in split entries"
    reason: "RPC create_expense handles both formats per plan 01 schema"

metrics:
  duration: 3min
  completed: 2026-02-18
---

# Phase 4.1 Plan 03: Expense Splits for Pending Members Summary

Pending members now participate in expense splits via the add-expense wizard and display correctly in expense detail -- the core value proposition of splitting with friends who have not signed up yet.

## Task Commits

| Task | Name | Commit | Key Changes |
|------|------|--------|-------------|
| 1 | Update add-expense wizard for pending member splits | e047efb | Import fetchAllMembers, split realMembers/allMembers, conditional split payload |
| 2 | Update expense detail screen for pending member splits | 3684446 | Join pending_members in query, render phone + Pending badge |

## Changes Made

### Task 1: Add-Expense Wizard

- **Replaced** local `GroupMember` interface with import from `@/lib/group-members` (uses `fetchAllMembers` for unified real + pending member list)
- **Split** members into `realMembers` (payer selector) and `allMembers` (split selectors) -- pending members cannot be payers
- **Updated** submit handler to emit `pending_member_id` instead of `user_id` for pending member splits
- **Added** "Pending" text badge to `MemberSelector` and `CustomSplitRow` components for visual distinction

### Task 2: Expense Detail Screen

- **Extended** `ExpenseSplitRow` interface with `pending_member_id` and `pending_members` join fields
- **Updated** Supabase query to include `pending_members(phone_number)` join
- **Renders** pending member splits with formatted phone number via `formatPhoneDisplay`
- **Shows** "Pending" badge next to pending member names (does not show "paid" badge since pending members cannot pay)

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Split payload format | `{ pending_member_id, amount }` for pending, `{ user_id, amount }` for real | Matches create_expense RPC from plan 01 |
| Pending badge style | Text caption in textTertiary color | Consistent with existing UI patterns |

## Deviations from Plan

None -- plan executed exactly as written.

## Verification

- TypeScript compiles cleanly (`npx tsc --noEmit` passes)
- PayerSelector receives only real members
- MemberSelector and CustomSplitRow receive all members with isPending flag
- Submit builds correct payload with pending_member_id for pending splits
- Expense detail joins pending_members and renders phone + badge

## Next Phase Readiness

Phase 4.1 is now complete (3/3 plans). All pending member functionality is in place:
- Plan 01: Database schema (pending_members table, auto-link trigger, RPC updates)
- Plan 02: Frontend member management (add by phone modal, group detail display)
- Plan 03: Expense splitting (wizard + detail screen support)

Ready to proceed with Phase 5 (Settlements/Balances) which will need to account for pending member balances.

## Self-Check: PASSED
