---
phase: 04.1-pending-members-by-phone
plan: 02
type: execute
wave: 2
depends_on: ["04.1-01"]
files_modified:
  - lib/group-members.ts
  - components/groups/AddMemberModal.tsx
  - app/group/[id].tsx
autonomous: true

must_haves:
  truths:
    - "User can tap 'Add Member' and enter a +63 phone number to add a pending member"
    - "Pending members appear in the group member list with a 'Pending' badge"
    - "If the phone number belongs to an existing user, they are added directly (not as pending)"
    - "Member count in group detail header includes both real and pending members"
  artifacts:
    - path: "lib/group-members.ts"
      provides: "Unified GroupMember type and fetchAllMembers function"
      contains: "isPending"
    - path: "components/groups/AddMemberModal.tsx"
      provides: "Phone input modal for adding pending members"
      contains: "add_pending_member"
    - path: "app/group/[id].tsx"
      provides: "Updated group detail with pending member display and add member button"
      contains: "isPending"
  key_links:
    - from: "components/groups/AddMemberModal.tsx"
      to: "add_pending_member RPC"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*add_pending_member"
    - from: "lib/group-members.ts"
      to: "pending_members table"
      via: "supabase.from('pending_members')"
      pattern: "from.*pending_members"
    - from: "app/group/[id].tsx"
      to: "lib/group-members.ts"
      via: "import fetchAllMembers"
      pattern: "import.*fetchAllMembers"
---

<objective>
Create the unified member type, add-member-by-phone modal, and update the group detail screen to display pending members with a visual indicator.

Purpose: Users need to add friends by phone number and see them in the member list before they sign up. This is the core UX of the pending member feature.
Output: Shared member type/fetcher, phone input modal component, updated group detail screen.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-pending-members-by-phone/04.1-RESEARCH.md
@.planning/phases/04.1-pending-members-by-phone/04.1-01-SUMMARY.md
@app/group/[id].tsx
@app/(auth)/phone.tsx
@lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified GroupMember type and fetch function</name>
  <files>
    lib/group-members.ts
  </files>
  <action>
    Create `lib/group-members.ts` with:

    1. Export interface `GroupMember`:
       ```
       id: string           // user.id for real members, pending_members.id for pending
       display_name: string // user.display_name or formatted phone for pending
       avatar_url: string | null
       isPending: boolean
       phone_number?: string // only for pending members, E.164 format
       ```

    2. Export function `formatPhoneDisplay(e164: string): string`:
       - Converts "+639171234567" to "+63 917 123 4567"
       - Extract digits after +63, format as `+63 ${digits.slice(0,3)} ${digits.slice(3,6)} ${digits.slice(6)}`
       - Fallback: return the original string if format doesn't match

    3. Export async function `fetchAllMembers(groupId: string): Promise<GroupMember[]>`:
       - Use Promise.all to fetch from both `group_members` (with users join) and `pending_members` in parallel
       - Map real members: id = users.id, display_name = users.display_name || "Unknown", avatar_url = users.avatar_url, isPending = false
       - Map pending members: id = pending_members.id, display_name = formatPhoneDisplay(phone_number), avatar_url = null, isPending = true, phone_number = phone_number
       - Return [...realMembers, ...pendingMembers]
       - Import supabase from `@/lib/supabase`

    4. Export function `isValidPHPhone(digits: string): boolean`:
       - Returns true if digits match /^9\d{9}$/ (10 digits starting with 9)
       - This validates the raw digits WITHOUT the +63 prefix
  </action>
  <verify>
    File exists at lib/group-members.ts. TypeScript compiles without errors: `npx tsc --noEmit lib/group-members.ts` (or run full `npx tsc --noEmit`). Exports GroupMember, fetchAllMembers, formatPhoneDisplay, isValidPHPhone.
  </verify>
  <done>
    Unified GroupMember type exported. fetchAllMembers queries both tables and returns merged list. Phone formatting and validation utilities ready for reuse.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add member modal and update group detail screen</name>
  <files>
    components/groups/AddMemberModal.tsx
    app/group/[id].tsx
  </files>
  <action>
    Create `components/groups/AddMemberModal.tsx`:
    - Props: `visible: boolean`, `groupId: string`, `onClose: () => void`, `onAdded: () => void`
    - Use React Native `Modal` (transparent, slide from bottom) -- same cross-platform Modal pattern used in group creation (decision from 03-01)
    - UI: Title "Add Member by Phone", +63 prefix display with TextInput for 10 digits (reuse the same pattern from phone.tsx auth screen: +63 prefix text + number-pad input)
    - Validate with `isValidPHPhone` from lib/group-members.ts
    - On submit: call `supabase.rpc('add_pending_member', { p_group_id: groupId, p_phone_number: '+63' + rawDigits })`
    - Handle errors: "already a member" -> show inline error, "already pending" -> show inline error, generic -> show error
    - On success: call `onAdded()` to trigger parent refresh, then `onClose()`
    - Style with dark theme (colors.surface background, colors.accent for button) matching existing app aesthetic
    - Add loading state during RPC call

    Update `app/group/[id].tsx`:
    - Import `GroupMember`, `fetchAllMembers` from `@/lib/group-members`
    - Import `AddMemberModal` from `@/components/groups/AddMemberModal`
    - Replace the existing `MemberRow` type and direct member fetch with `fetchAllMembers(id!)`
    - Store members as `GroupMember[]` state (replace current `MemberRow[]`)
    - Add state: `showAddMember: boolean` (default false)
    - Add "Add Member" button next to the "Invite Friends" button (or in the members section header). Use a secondary/outline style to differentiate from invite.
    - In the members section, update rendering:
      - For real members (isPending === false): render as before (avatar, display_name, joined date, creator badge)
      - For pending members (isPending === true): render with a phone icon or hourglass emoji as avatar, display the formatted phone number as name, show a "Pending" badge (same style as "Creator" badge but using colors.warning or colors.textTertiary)
      - Do NOT show "Joined X ago" for pending members -- show "Invited" or "Pending signup" instead
    - Update the member count badge to reflect total (real + pending)
    - Wire AddMemberModal: show when showAddMember is true, onAdded triggers fetchData() refresh
    - Keep the existing expenses fetch and rendering unchanged
    - The `handleShare` invite link flow stays unchanged

    IMPORTANT: The `expenses` query in fetchData currently selects `expense_splits(user_id, amount)`. This still works because existing expense splits all have user_id set. Pending member splits will be handled in Plan 03.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` -- no type errors
    2. Run `npx expo start` and navigate to a group detail screen:
       - "Add Member" button visible
       - Tapping shows phone input modal
       - Member list renders (real members shown as before)
    3. If Supabase is connected: test adding a phone number via the modal and verify the RPC call succeeds
  </verify>
  <done>
    Group detail screen shows both real and pending members. Users can add members by phone via the modal. Pending members display with formatted phone number and "Pending" badge. Member count includes pending members.
  </done>
</task>

</tasks>

<verification>
1. `lib/group-members.ts` exports GroupMember type, fetchAllMembers, formatPhoneDisplay, isValidPHPhone
2. `components/groups/AddMemberModal.tsx` renders phone input and calls add_pending_member RPC
3. `app/group/[id].tsx` uses unified member list and shows pending badge
4. TypeScript compiles without errors
</verification>

<success_criteria>
- Users can tap "Add Member" and enter a +63 phone number
- Pending members appear in the member list with "Pending" indicator
- Real members display unchanged (avatar, name, joined date)
- Phone input validates 10-digit Philippine numbers
- Error handling for duplicate and already-member cases
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-pending-members-by-phone/04.1-02-SUMMARY.md`
</output>
