---
phase: 04.1-pending-members-by-phone
plan: 03
type: execute
wave: 3
depends_on: ["04.1-02"]
files_modified:
  - app/group/[id]/add-expense.tsx
  - components/expenses/PayerSelector.tsx
  - components/expenses/MemberSelector.tsx
  - components/expenses/CustomSplitRow.tsx
  - app/group/[id]/expense/[expenseId].tsx
autonomous: true

must_haves:
  truths:
    - "Pending members appear in equal split member selector and can be toggled on/off"
    - "Pending members appear in custom split list and can have amounts assigned"
    - "Pending members do NOT appear in payer selector (only real members can pay)"
    - "Expense submission sends pending_member_id in splits for pending members"
    - "Expense detail screen shows pending member splits with formatted phone and 'Pending' badge"
  artifacts:
    - path: "app/group/[id]/add-expense.tsx"
      provides: "Updated expense wizard supporting pending member splits"
      contains: "pending_member_id"
    - path: "app/group/[id]/expense/[expenseId].tsx"
      provides: "Updated expense detail showing pending member splits"
      contains: "pending_member"
  key_links:
    - from: "app/group/[id]/add-expense.tsx"
      to: "create_expense RPC"
      via: "supabase.rpc with pending_member_id in splits"
      pattern: "pending_member_id"
    - from: "app/group/[id]/add-expense.tsx"
      to: "lib/group-members.ts"
      via: "import fetchAllMembers, GroupMember"
      pattern: "import.*fetchAllMembers"
    - from: "app/group/[id]/expense/[expenseId].tsx"
      to: "pending_members table"
      via: "expense_splits query includes pending_member join"
      pattern: "pending_member"
---

<objective>
Update the add-expense wizard and expense detail screen to support pending members in splits. Pending members can be included in equal and custom splits but cannot be selected as payers.

Purpose: This is the core value proposition -- users can split expenses with friends who haven't signed up yet. Without this, pending members are just names in a list.
Output: Updated expense wizard and detail screens that handle both real and pending member splits.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-pending-members-by-phone/04.1-RESEARCH.md
@.planning/phases/04.1-pending-members-by-phone/04.1-01-SUMMARY.md
@.planning/phases/04.1-pending-members-by-phone/04.1-02-SUMMARY.md
@app/group/[id]/add-expense.tsx
@app/group/[id]/expense/[expenseId].tsx
@components/expenses/PayerSelector.tsx
@components/expenses/MemberSelector.tsx
@components/expenses/CustomSplitRow.tsx
@lib/group-members.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update add-expense wizard for pending member splits</name>
  <files>
    app/group/[id]/add-expense.tsx
    components/expenses/PayerSelector.tsx
    components/expenses/MemberSelector.tsx
    components/expenses/CustomSplitRow.tsx
  </files>
  <action>
    Update `app/group/[id]/add-expense.tsx`:

    1. Replace the local `GroupMember` interface with import from `@/lib/group-members`:
       `import { GroupMember, fetchAllMembers } from '@/lib/group-members'`

    2. Update `fetchMembers()` to use `fetchAllMembers(groupId!)` instead of direct Supabase query. This returns both real and pending members with `isPending` flag.

    3. Create two derived lists:
       - `realMembers = members.filter(m => !m.isPending)` -- for payer selection (pending members CANNOT be payers per research decision)
       - `allMembers = members` -- for split selection (pending members CAN be split participants)

    4. Pass `realMembers` to PayerSelector (Step 2 "Who paid?")
    5. Pass `allMembers` to MemberSelector (Step 3 equal split) and to CustomSplitRow rendering (Step 3 custom split)

    6. Update the submit handler `handleSubmit()`:
       - When building splits array, check `member.isPending` for each member:
         - If NOT pending: `{ user_id: member.id, amount: amt / 100 }`
         - If pending: `{ pending_member_id: member.id, amount: amt / 100 }` (no user_id)
       - For equal split: look up each selectedMemberId in the `members` array to determine isPending
       - For custom split: look up each customAmounts key in the `members` array to determine isPending
       - The RPC `create_expense` (updated in Plan 01) accepts both formats

    7. Default payer to current user (unchanged). Default all members selected for equal split -- this now includes pending members (they should be included by default).

    Update `components/expenses/MemberSelector.tsx`:
    - Update the `Member` interface to include `isPending?: boolean`
    - For pending members, show a small "Pending" text badge next to the name (use colors.textTertiary, similar to how creator badge works in group detail)
    - Avatar for pending members: pass `undefined` emoji (will show default avatar)

    Update `components/expenses/PayerSelector.tsx`:
    - No changes needed to the component itself -- it already takes a Member[] prop
    - The parent now passes only real members, so pending members won't appear

    Update `components/expenses/CustomSplitRow.tsx`:
    - Update the `member` prop type to include `isPending?: boolean`
    - For pending members, show "Pending" badge next to name (same as MemberSelector)
  </action>
  <verify>
    1. `npx tsc --noEmit` -- no type errors
    2. Navigate to add-expense in a group:
       - Step 2 (Who paid?): Only real members shown, no pending members
       - Step 3 (Split between): Both real and pending members shown in equal split selector
       - Step 3 (Custom): Both real and pending members shown with amount inputs
       - Pending members have "Pending" label
    3. Submit an expense with a pending member included in the split -- verify the RPC call includes `pending_member_id` for the pending member's split
  </verify>
  <done>
    Add-expense wizard supports pending member splits. Payer restricted to real members. Equal and custom splits include pending members with visual indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update expense detail screen for pending member splits</name>
  <files>
    app/group/[id]/expense/[expenseId].tsx
  </files>
  <action>
    Update `app/group/[id]/expense/[expenseId].tsx`:

    1. Update the `ExpenseSplitRow` interface to handle pending members:
       ```
       interface ExpenseSplitRow {
         user_id: string | null;
         pending_member_id: string | null;
         amount: number;
         users: {
           display_name: string | null;
           avatar_url: string | null;
         } | null;
         pending_members: {
           phone_number: string;
         } | null;
       }
       ```

    2. Update the Supabase query for expense detail to include pending_members join:
       Change the select from:
       `expense_splits(user_id, amount, users(display_name, avatar_url))`
       to:
       `expense_splits(user_id, pending_member_id, amount, users(display_name, avatar_url), pending_members(phone_number))`

    3. Update the split breakdown rendering:
       - For real member splits (user_id is not null): render as before (display_name, avatar, payer badge)
       - For pending member splits (pending_member_id is not null, user_id is null):
         - Display name: use `formatPhoneDisplay(split.pending_members.phone_number)` from lib/group-members.ts
         - Avatar: use default (pass undefined emoji)
         - Show "Pending" badge next to name (same style as "paid" badge but different text)
         - Do NOT show "paid" badge for pending splits (pending members cannot be payers)
       - Use `split.user_id || split.pending_member_id` as the key for list rendering (one will always be non-null)

    4. Import `formatPhoneDisplay` from `@/lib/group-members`

    5. Update the ExpenseCard component in the group detail screen is NOT modified here -- it shows summary info only (paid_by name, your split amount). Since pending members cannot be payers, and the ExpenseCard only shows the current user's split, no changes needed to ExpenseCard.
  </action>
  <verify>
    1. `npx tsc --noEmit` -- no type errors
    2. Navigate to an expense detail that includes a pending member split:
       - Pending member's split shows with formatted phone number
       - "Pending" badge visible
       - Real member splits render as before
       - No crashes when pending_members join returns null for real member splits
  </verify>
  <done>
    Expense detail screen correctly displays pending member splits with formatted phone numbers and "Pending" badges alongside real member splits.
  </done>
</task>

</tasks>

<verification>
1. Full add-expense flow works: amount -> payer (real only) -> split (real + pending) -> submit
2. Expense detail shows both real and pending splits correctly
3. TypeScript compiles without errors across all modified files
4. Existing expenses (no pending members) still display correctly
</verification>

<success_criteria>
- Pending members selectable in equal and custom splits
- Pending members NOT selectable as payers
- Expense submission sends correct split format (user_id vs pending_member_id)
- Expense detail shows pending member splits with phone number and badge
- No regressions: existing expenses display unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-pending-members-by-phone/04.1-03-SUMMARY.md`
</output>
