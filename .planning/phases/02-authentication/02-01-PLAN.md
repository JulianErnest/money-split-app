---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/_layout.tsx
  - app/(auth)/phone.tsx
  - app/(auth)/otp.tsx
  - app/(auth)/_layout.tsx
  - lib/auth-context.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter a Philippine phone number with +63 prefix pre-filled"
    - "User receives OTP and can enter it via 6 individual digit boxes"
    - "OTP auto-submits when all 6 digits are filled"
    - "Returning user is auto-signed-in without re-entering OTP"
    - "Unauthenticated user is redirected to auth screen"
  artifacts:
    - path: "lib/auth-context.tsx"
      provides: "Auth state provider with session persistence"
      exports: ["AuthProvider", "useAuth"]
    - path: "app/(auth)/phone.tsx"
      provides: "Phone number input screen with +63 prefix"
      min_lines: 40
    - path: "app/(auth)/otp.tsx"
      provides: "OTP verification screen with 6 digit boxes"
      min_lines: 60
    - path: "app/(auth)/_layout.tsx"
      provides: "Auth route group layout"
      min_lines: 5
  key_links:
    - from: "app/_layout.tsx"
      to: "lib/auth-context.tsx"
      via: "AuthProvider wrapping Stack, conditional routing"
      pattern: "AuthProvider"
    - from: "app/(auth)/phone.tsx"
      to: "lib/supabase.ts"
      via: "supabase.auth.signInWithOtp"
      pattern: "signInWithOtp"
    - from: "app/(auth)/otp.tsx"
      to: "lib/supabase.ts"
      via: "supabase.auth.verifyOtp"
      pattern: "verifyOtp"
---

<objective>
Build the phone OTP authentication flow: an AuthProvider that manages session state and redirects, a phone number input screen with locked +63 prefix, and an OTP verification screen with 6 individual digit boxes.

Purpose: Establishes user identity — every subsequent feature (groups, expenses, balances) requires a signed-in user.
Output: Working auth flow from phone input through OTP verification to authenticated home screen, plus session persistence for returning users.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@lib/supabase.ts
@app/_layout.tsx
@theme/colors.ts
@components/ui/Input.tsx
@components/ui/Button.tsx
@components/ui/Text.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthProvider and protect routes</name>
  <files>lib/auth-context.tsx, app/_layout.tsx, app/(auth)/_layout.tsx</files>
  <action>
Create `lib/auth-context.tsx`:
- Create AuthContext with React.createContext holding: `session: Session | null`, `user: User | null`, `isLoading: boolean`, `isNewUser: boolean`
- AuthProvider component that:
  - Calls `supabase.auth.getSession()` on mount to restore persisted session
  - Subscribes to `supabase.auth.onAuthStateChange` for real-time session updates
  - Sets `isLoading = true` until initial session check completes
  - Determines `isNewUser` by checking if the user's `display_name` is set in the `users` table (query `supabase.from('users').select('display_name').eq('id', user.id).single()`) — if null/empty or row doesn't exist, user is new
  - Cleans up subscription on unmount
- Export `useAuth()` hook that consumes the context

Update `app/_layout.tsx`:
- Wrap the entire app in `<AuthProvider>`
- Inside the provider, use `useAuth()` to conditionally render routes:
  - If `isLoading`: return null (splash screen still visible)
  - If no session: render `<Stack.Screen name="(auth)" />` and use `router.replace('/(auth)/phone')`
  - If session exists but `isNewUser`: render `<Stack.Screen name="(auth)" />` and route to profile-setup (will be built in 02-02, for now just redirect to tabs)
  - If session exists and not new: render `<Stack.Screen name="(tabs)" />`
- Keep existing font loading and splash screen logic
- Use Expo Router's `useSegments` and `useRouter` for programmatic navigation based on auth state

Create `app/(auth)/_layout.tsx`:
- Simple Stack layout with `headerShown: false` and dark background from theme
- Stack screens for "phone" and "otp"
  </action>
  <verify>
- `npx tsc --noEmit` passes (no type errors)
- App compiles without errors
- AuthProvider correctly exports and wraps the app
  </verify>
  <done>
AuthProvider manages session state with Supabase listener, root layout conditionally routes to auth or tabs based on session, auth route group exists with Stack layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build phone input and OTP verification screens</name>
  <files>app/(auth)/phone.tsx, app/(auth)/otp.tsx</files>
  <action>
Create `app/(auth)/phone.tsx` — Phone number input screen:
- Layout: SafeAreaView with dark background (colors.background), vertically centered content with horizontal padding (spacing[6])
- Top section: App name "Hatian" in large text (textStyles.h1) with accent color, subtitle "Split expenses with your barkada" in textSecondary
- Phone input section:
  - Label "Phone number" using Text component
  - Row with non-editable "+63" prefix text (styled in accent color, fontSize.lg, fontFamily.semiBold) and a TextInput for the 10-digit number
  - TextInput: `keyboardType="number-pad"`, `maxLength={10}`, `placeholder="9XX XXX XXXX"`, uses Input component styling (underline border)
  - Auto-format as user types: insert spaces for readability (9XX XXX XXXX) but store raw digits
- Validation: Enable submit button only when exactly 10 digits entered
- Submit button: Full-width primary Button component, text "Send OTP", shows loading spinner during API call
- On submit: Call `supabase.auth.signInWithOtp({ phone: '+63' + rawDigits })`
- On success: Navigate to `/(auth)/otp` passing the full phone number as a param (use `router.push` with params)
- On error: Show inline error message below the input using Text component with error color
- Error states: network error, invalid phone number, rate limit exceeded

Create `app/(auth)/otp.tsx` — OTP verification screen:
- Receive phone number from route params
- Layout: SafeAreaView with dark background, vertically centered
- Header: "Enter verification code" (h2), "Sent to +63 9XX XXX XXXX" (body, textSecondary) showing the masked phone number
- OTP input: 6 individual TextInput boxes in a row
  - Each box: 48x56px, centered text, fontSize.xl, fontFamily.bold, dark surface background (colors.surface), rounded corners (borderRadius.md)
  - Focused box gets accent border (colors.inputBorderFocused)
  - Use `useRef` array for 6 TextInput refs
  - `keyboardType="number-pad"`, `maxLength={1}` per box
  - Auto-advance: on text change, if digit entered, focus next box
  - Backspace: if empty and backspace pressed, focus previous box
  - Auto-submit: when all 6 digits filled, automatically call verify
- Verification: Call `supabase.auth.verifyOtp({ phone, token: otpCode, type: 'sms' })`
- Error handling:
  - Track wrong attempts count in state
  - On wrong OTP: Show inline error "Invalid code. X attempts remaining" below boxes
  - After 3 wrong attempts: Show "Too many attempts. Try again in 5 minutes" and disable input + hide resend button
  - Store lockout timestamp in state, use countdown timer
- Resend OTP button:
  - Text: "Resend code" (ghost button style)
  - 60-second cooldown: Show countdown "Resend in XXs" (disabled state), then "Resend code" when timer expires
  - On press: Call `supabase.auth.signInWithOtp({ phone })` again, reset cooldown timer
  - After successful resend: Reset wrong attempt counter
- Loading state: Show loading indicator on the OTP boxes or a subtle spinner during verification
- On successful verify: The AuthProvider's onAuthStateChange listener will pick up the new session and handle navigation automatically (no manual navigation needed)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- App launches and shows phone input screen when not authenticated
- Can enter phone number with +63 prefix visible
- OTP screen shows 6 digit boxes with auto-advance behavior
  </verify>
  <done>
Phone input screen shows +63 locked prefix with 10-digit input, OTP screen has 6 individual digit boxes with auto-advance and auto-submit, resend button with 60s cooldown, 3-attempt lockout with 5-minute timer, and inline error messages.
  </done>
</task>

</tasks>

<verification>
1. App launches showing phone input screen (not tabs) when no session exists
2. +63 prefix is visible and non-editable
3. Phone number input accepts exactly 10 digits with number pad
4. Submit button is disabled until 10 digits entered
5. OTP screen displays 6 individual input boxes
6. Typing a digit auto-advances to next box
7. Backspace moves to previous box
8. Auto-submit fires when 6th digit entered
9. Resend button shows 60s countdown timer
10. Error messages display inline below OTP boxes
</verification>

<success_criteria>
- Unauthenticated users see phone input screen, not tabs
- Phone number entry with +63 prefix and 10-digit validation works
- OTP screen has 6 individual digit boxes with auto-advance and auto-submit
- Resend OTP has 60-second cooldown timer
- 3 wrong attempts triggers 5-minute lockout message
- Successful OTP verification transitions user to app (via AuthProvider session listener)
- Returning user with valid session bypasses auth screens entirely
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
