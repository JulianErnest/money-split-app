---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/(auth)/profile-setup.tsx
  - app/(tabs)/profile.tsx
  - lib/auth-context.tsx
  - app/_layout.tsx
autonomous: false

must_haves:
  truths:
    - "First-time user is prompted to set a display name before reaching home"
    - "First-time user can optionally pick an emoji avatar"
    - "User can sign out and is returned to the auth screen"
    - "Profile tab shows the current user's display name and avatar"
  artifacts:
    - path: "app/(auth)/profile-setup.tsx"
      provides: "Profile setup screen for first-time users"
      min_lines: 50
    - path: "app/(tabs)/profile.tsx"
      provides: "Profile tab with user info and sign-out button"
      min_lines: 40
  key_links:
    - from: "app/(auth)/profile-setup.tsx"
      to: "lib/supabase.ts"
      via: "supabase.from('users').upsert"
      pattern: "upsert|insert"
    - from: "app/(tabs)/profile.tsx"
      to: "lib/supabase.ts"
      via: "supabase.auth.signOut"
      pattern: "signOut"
    - from: "app/_layout.tsx"
      to: "lib/auth-context.tsx"
      via: "isNewUser routing to profile-setup"
      pattern: "isNewUser.*profile"
---

<objective>
Build the profile setup screen for first-time users and the sign-out flow from the profile tab, completing the authentication phase.

Purpose: First-time users need a display name (and optional avatar) before entering the app, so other users can identify them in groups and expenses. Sign-out closes the auth loop.
Output: Profile setup screen that gates new users, updated profile tab with user info and sign-out, complete auth lifecycle.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@lib/supabase.ts
@lib/auth-context.tsx
@app/_layout.tsx
@components/ui/Avatar.tsx
@components/ui/Button.tsx
@components/ui/Input.tsx
@components/ui/Text.tsx
@theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build profile setup screen and wire new-user routing</name>
  <files>app/(auth)/profile-setup.tsx, lib/auth-context.tsx, app/_layout.tsx</files>
  <action>
Create `app/(auth)/profile-setup.tsx`:
- Layout: SafeAreaView with dark background, content centered with padding (spacing[6])
- Header: "Set up your profile" (h1), "Let your friends know who you are" (body, textSecondary)
- Avatar section:
  - Display a large Avatar component (size "lg" or ~80px) at the top, centered
  - Below it, show a horizontal scrollable row of 8-10 emoji options from EMOJI_LIST (imported from Avatar component)
  - User taps an emoji to select it as their avatar; selected emoji gets accent border ring
  - Default: random emoji pre-selected on mount
- Display name input:
  - Label "Display name"
  - Use the Input component, `placeholder="e.g., Juan"`, `maxLength={30}`, `autoFocus={true}`
  - Validation: minimum 2 characters, maximum 30
  - Show error if user tries to submit with < 2 characters: "Name must be at least 2 characters"
- "Let's go!" primary Button, full width
  - Disabled until display name has >= 2 characters
  - Shows loading state during save
- On submit:
  - Upsert to users table: `supabase.from('users').upsert({ id: user.id, phone_number: user.phone, display_name, avatar_url: selectedEmoji })`
  - On success: Update the AuthProvider state so `isNewUser` becomes false (add a `refreshProfile` method to auth context that re-queries the user row)
  - The root layout will then redirect to (tabs) automatically
- On error: Show inline error message

Update `lib/auth-context.tsx`:
- Add `refreshProfile()` async method to the context that re-queries the users table and updates `isNewUser`
- Export it from `useAuth()`

Update `app/_layout.tsx`:
- Wire the `isNewUser` check: when session exists but `isNewUser` is true, route to `/(auth)/profile-setup`
- Add `<Stack.Screen name="(auth)/profile-setup" />` to the Stack if not already handled by the auth group
  </action>
  <verify>
- `npx tsc --noEmit` passes
- New users are redirected to profile setup after OTP verification
- Display name validation works (min 2 chars)
- Avatar selection shows emoji options
- Successful profile save transitions to home tabs
  </verify>
  <done>
First-time users see profile setup screen after OTP verification, can set display name (2-30 chars) and pick an emoji avatar, and are routed to home tabs after saving. AuthProvider correctly detects new vs returning users.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build profile tab with user info and sign-out</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
Replace the placeholder `app/(tabs)/profile.tsx` with a real profile screen:
- Layout: SafeAreaView with dark background, ScrollView with padding
- Header section:
  - Large Avatar component showing the user's emoji avatar (from auth context or users table query)
  - Display name in h1 style
  - Phone number in body style, textSecondary (formatted: +63 9XX XXX XXXX)
- Info card (Card component):
  - "Member since" row with joined date formatted (e.g., "February 2026")
- Sign out section:
  - At the bottom, a "Sign out" Button with `variant="ghost"` or `variant="secondary"` in error/red color
  - On press: Show a simple confirmation — use Alert.alert with "Sign out?" title, "You'll need to verify your phone number again to sign back in" message, "Cancel" and "Sign out" buttons
  - On confirm: Call `supabase.auth.signOut()` — the AuthProvider listener will detect session removal and route to auth screen automatically
  - Show loading state on the button during sign-out

Data loading:
- On mount, query user data from users table: `supabase.from('users').select('*').eq('id', user.id).single()`
- Use the auth context's user for immediate display, users table for display_name and avatar_url
- Show skeleton/loading state while fetching user profile data
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Profile tab shows user's display name, avatar, and phone number
- Sign out button triggers confirmation alert
- Confirming sign-out returns to phone input screen
  </verify>
  <done>
Profile tab displays user avatar, display name, phone number, and member-since date. Sign-out button with confirmation dialog calls supabase.auth.signOut and returns user to auth screen.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow: phone input with +63 prefix, OTP verification with 6 digit boxes, profile setup for new users, profile tab with sign-out. Session persistence for returning users.</what-built>
  <how-to-verify>
1. Launch the app — should see phone input screen with +63 prefix
2. Enter a valid PH phone number (10 digits) — "Send OTP" button should enable
3. Tap "Send OTP" — should navigate to OTP screen with 6 digit boxes
4. Enter OTP digits — each digit auto-advances to next box; 6th digit auto-submits
5. On first sign-in — should see profile setup screen with emoji picker and name input
6. Set a display name and pick an avatar — tap "Let's go!"
7. Should arrive at home tabs screen
8. Tap Profile tab — should see your name, avatar, phone number
9. Tap "Sign out" — should see confirmation dialog
10. Confirm — should return to phone input screen
11. Close and reopen app — should auto-sign-in to tabs (session persisted)

Note: Requires Supabase project with Phone Auth enabled. If not configured yet, verify screens render correctly and navigation flow works (API calls will fail gracefully with error messages).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. First-time user flow: phone -> OTP -> profile setup -> tabs
2. Returning user flow: app launch -> tabs (no auth screens)
3. Profile setup requires display name (min 2 chars)
4. Emoji avatar selection works with visual feedback
5. Profile tab shows user info (name, avatar, phone, join date)
6. Sign-out shows confirmation, then returns to auth screen
7. After sign-out, user must re-authenticate
</verification>

<success_criteria>
- First-time user is routed to profile setup after OTP verification
- Display name (required, 2-30 chars) and emoji avatar (optional, pre-selected) can be set
- Profile data persists in Supabase users table
- Profile tab shows current user info
- Sign-out clears session and returns to phone input screen
- All screens use design system components (Text, Button, Input, Avatar, Card) and theme tokens
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
