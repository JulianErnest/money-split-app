---
phase: 03-groups
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/group/[id].tsx
  - app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap into a group and see its list of members"
    - "Each member shows their display name and emoji avatar"
    - "Groups on the home screen show auto-generated emoji avatars"
    - "Groups list shows member count for each group"
  artifacts:
    - path: "app/group/[id].tsx"
      provides: "Group detail screen with member list"
      contains: "group_members"
      min_lines: 80
  key_links:
    - from: "app/group/[id].tsx"
      to: "supabase.from('group_members').select"
      via: "Fetch members with user details"
      pattern: "group_members.*select.*users"
---

<objective>
Add the member list to the group detail screen and enhance the groups list with member counts and polished group avatars.

Purpose: Completes the groups feature -- users can see who is in their groups, making the social structure visible before expenses are added.
Output: Group detail screen with full member list, groups list with member counts and emoji avatars.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-groups/03-RESEARCH.md
@.planning/phases/03-groups/03-01-SUMMARY.md
@lib/database.types.ts
@lib/supabase.ts
@components/ui/Avatar.tsx
@theme/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add member list to group detail screen</name>
  <files>
    app/group/[id].tsx
  </files>
  <action>
Update `app/group/[id].tsx` (created by Plan 03-02) to add the members section, replacing the placeholder comment.

**Fetch group members** alongside the group details (can be a separate query or combined):
```typescript
const { data: members } = await supabase
  .from('group_members')
  .select('user_id, joined_at, users (id, display_name, avatar_url)')
  .eq('group_id', id)
  .order('joined_at', { ascending: true });
```

**Render members section:**
- Section header: "Members" with a count badge (e.g., "Members (3)")
- FlatList or map of member items, each showing:
  - Avatar component with the member's emoji (from `users.avatar_url` -- this is the unicode emoji string stored in Phase 2)
  - Display name (from `users.display_name`)
  - "Creator" badge/label next to the group creator (compare `users.id` with `group.created_by`)
  - Joined date as secondary text (format as relative or short date)
- Members list should be part of a ScrollView with the group header above (or use a FlatList with ListHeaderComponent containing the group info + share button)
- Handle loading state (ActivityIndicator while members fetch)
- Handle edge case: member with null display_name (show "Unknown" or their user_id truncated)

**Styling:**
- Each member row: horizontal layout with avatar on left, name + metadata on right
- Use Card or a simple row with bottom border
- Follow the dark theme, use colors.surface for row backgrounds, textPrimary for names, textSecondary for metadata
- Use spacing from theme for consistent padding/gaps

**Important:** Do NOT break the share button or group header that Plan 02 created. Only ADD the members section below the existing content.
  </action>
  <verify>
Run `npx tsc --noEmit --pretty`. Navigate to a group detail screen and verify:
1. Members section shows below group header
2. Each member has avatar, name, and creator badge (for the group creator)
3. Member count is accurate
  </verify>
  <done>Group detail screen shows a list of members with avatars, names, and creator badges. Member count displayed in section header.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance groups list with member counts and avatars</name>
  <files>
    app/(tabs)/index.tsx
  </files>
  <action>
Update `app/(tabs)/index.tsx` (created by Plan 03-01) to add member counts and ensure group avatars are polished.

**Add member count to each group card:**
- Update the groups fetch query to include a member count. The simplest approach: fetch group_members with a count aggregation per group. Options:
  1. Use Supabase's `count` option: after fetching groups, do a separate query `supabase.from('group_members').select('group_id', { count: 'exact', head: true }).eq('group_id', groupId)` -- but this is N+1.
  2. Better: fetch all group_members for the user's groups and count client-side, or use a single query that includes the count.
  3. Simplest practical approach: Fetch `group_members` for each group_id in the groups list (batch), or include member records in the initial query and count them.

  Recommended approach: Update the query to:
  ```typescript
  const { data } = await supabase
    .from('group_members')
    .select('group_id, groups (id, name, invite_code, created_by, created_at), group_id')
    .eq('user_id', user.id)
    .order('joined_at', { ascending: false });
  ```
  Then for member counts, do a second query:
  ```typescript
  const groupIds = data.map(d => d.groups.id);
  const { data: counts } = await supabase
    .from('group_members')
    .select('group_id')
    .in('group_id', groupIds);
  // Count occurrences of each group_id
  const memberCounts = counts.reduce((acc, row) => {
    acc[row.group_id] = (acc[row.group_id] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  ```

- Display member count on each group card as secondary text: "{N} members" or "{N} member" (singular)

**Ensure group avatar is polished:**
- Each group card should show the deterministic emoji avatar (from Plan 01's getGroupEmoji helper)
- Verify the Avatar component is used with the correct emoji and size (md or lg)
- Layout: Avatar on left, group name + member count on right, chevron or arrow indicator on far right

**Polish the overall list:**
- Ensure consistent spacing between cards
- Verify the create group button/FAB is still accessible and prominent
- The "+" or create button should be clearly visible (top-right header area or floating)
  </action>
  <verify>
Run `npx tsc --noEmit --pretty`. Open the app and verify:
1. Each group card shows an emoji avatar, group name, and member count
2. Member count is accurate (create a group, it shows "1 member"; after someone joins, it shows "2 members")
3. Overall layout is clean and consistent with the dark theme
  </verify>
  <done>Groups list shows emoji avatars and accurate member counts for each group. Layout is polished and consistent with the design system.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --pretty` passes
2. Group detail screen shows member list with avatars, names, creator badges
3. Groups list shows member counts and emoji avatars
4. All group-related screens use consistent theme styling
</verification>

<success_criteria>
- User can tap into a group and see all members with their avatars and names
- Group creator is visually identified in the member list
- Groups list displays member count and auto-generated emoji avatar per group
- All screens follow the dark-first design system
</success_criteria>

<output>
After completion, create `.planning/phases/03-groups/03-03-SUMMARY.md`
</output>
