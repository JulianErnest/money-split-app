---
phase: 03-groups
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/+native-intent.tsx
  - app/join/[code].tsx
  - app/group/[id].tsx
  - app/_layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can generate a shareable invite link from a group"
    - "User can send the invite link via the system share sheet"
    - "Another user can tap the invite link and join the group via deep linking"
    - "User who is already a member tapping the link is handled gracefully"
  artifacts:
    - path: "app/+native-intent.tsx"
      provides: "Deep link URL rewriting for hatian:// scheme"
      min_lines: 5
    - path: "app/join/[code].tsx"
      provides: "Join flow screen handling invite code resolution"
      min_lines: 40
    - path: "app/group/[id].tsx"
      provides: "Group detail screen with invite sharing"
      min_lines: 60
  key_links:
    - from: "app/+native-intent.tsx"
      to: "app/join/[code].tsx"
      via: "URL rewrite from hatian://join/CODE to /join/CODE"
      pattern: "join/"
    - from: "app/join/[code].tsx"
      to: "supabase.rpc('join_group_by_invite')"
      via: "RPC call with invite code from route params"
      pattern: "rpc.*join_group_by_invite"
    - from: "app/group/[id].tsx"
      to: "Share.share"
      via: "Share button triggering system share sheet"
      pattern: "Share\\.share"
---

<objective>
Build the invite link generation with system share sheet, Expo deep link handling for join URLs, and the join flow screen. Also create the group detail screen (basic shell with share functionality -- member list added in Plan 03).

Purpose: This enables the core viral loop -- users create groups and invite friends via shareable links that open the app directly.
Output: Working deep link flow (hatian://join/CODE), share sheet integration, join screen, group detail screen with share button.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-groups/03-RESEARCH.md
@.planning/phases/03-groups/03-01-SUMMARY.md
@lib/database.types.ts
@lib/supabase.ts
@lib/auth-context.tsx
@app/_layout.tsx
@app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deep link handling and join flow screen</name>
  <files>
    app/+native-intent.tsx
    app/join/[code].tsx
    app/_layout.tsx
  </files>
  <action>
**1. Create `app/+native-intent.tsx`** for deep link URL rewriting:

```typescript
export function redirectSystemPath({ path, initial }: { path: string; initial: boolean }) {
  try {
    // Handle hatian://join/CODE deep links
    if (path.includes('/join/')) {
      const url = new URL(path, 'hatian://');
      if (url.pathname.startsWith('/join/')) {
        return url.pathname; // returns /join/CODE
      }
    }
    return path;
  } catch {
    return path;
  }
}
```

The app scheme is already `hatian` in app.json. This rewrites incoming `hatian://join/ABCD1234` URLs to the `/join/ABCD1234` route.

**2. Create `app/join/[code].tsx`** -- the join flow screen:

- Use `useLocalSearchParams<{ code: string }>()` to get the invite code (NOT useGlobalSearchParams -- research anti-pattern)
- On mount (useEffect), immediately attempt to join:
  1. Check if user is authenticated (from auth context session). If not authenticated, store the invite code in a module-level variable and redirect to auth flow. After auth completes, the user will need to re-open the link (simplest approach per research recommendation).
  2. If authenticated, call `supabase.rpc('join_group_by_invite', { invite: code })`
  3. On success: navigate to `group/[returned_group_id]` via `router.replace(\`/group/\${groupId}\`)`
  4. On error (invalid code): show error message with a "Go Home" button that navigates to `/(tabs)`
  5. On error (already a member -- the ON CONFLICT DO NOTHING means it returns the group_id anyway): still navigate to the group
- Show a loading state while the RPC is in flight (centered ActivityIndicator with "Joining group..." text)
- Use the app's theme colors and Text component
- Handle edge case: empty or malformed code (show error)

**3. Update `app/_layout.tsx`** to register the join route and group route in the Stack:

Add Stack.Screen entries for the new routes:
```tsx
<Stack.Screen name="join/[code]" />
<Stack.Screen name="group/[id]" />
```

These go inside the existing Stack, after the `(tabs)` screen. They use the default `headerShown: false` from screenOptions.
  </action>
  <verify>
Run `npx tsc --noEmit --pretty`. Verify the files exist and compile. Test deep link with `npx uri-scheme open "hatian://join/testcode" --ios` (or equivalent expo command) if a simulator is available. Otherwise verify file structure is correct.
  </verify>
  <done>Deep link handler rewrites hatian://join/CODE to /join/CODE route. Join screen resolves invite code via RPC and navigates to group on success. Root layout registers join and group routes.</done>
</task>

<task type="auto">
  <name>Task 2: Group detail screen with invite link sharing</name>
  <files>
    app/group/[id].tsx
  </files>
  <action>
Create `app/group/[id].tsx` -- the group detail screen:

- Use `useLocalSearchParams<{ id: string }>()` to get the group ID
- Fetch group details on mount:
  ```typescript
  const { data: group } = await supabase
    .from('groups')
    .select('id, name, invite_code, created_by, created_at')
    .eq('id', id)
    .single();
  ```
- Header area:
  - Back button (use `router.back()` or an `<` icon)
  - Group name as h2
  - Group emoji avatar (same `getGroupEmoji` helper from Plan 01 -- import or re-implement the same hash function)
- **Share/Invite button** (prominent, using Button component with "Invite Friends" or "Share Link" label):
  - On press, generate the invite URL using `Linking.createURL(\`join/\${group.invite_code}\`)` from `expo-linking`
  - Call `Share.share({ message: \`Join "${group.name}" on HatianApp! \${url}\` })` using React Native's built-in Share API
  - Import `Share` from `react-native` and `* as Linking` from `expo-linking`
- **Members section** -- for now, just show a placeholder "Members" header. Plan 03 will add the actual member list. Add a comment: `{/* Member list added by Plan 03-03 */}`
- Loading state while group data is fetching
- Error state if group not found (e.g., user navigated to invalid ID)
- Use SafeAreaView, theme colors, existing UI components (Text, Button, Card, Avatar)
  </action>
  <verify>
Run `npx tsc --noEmit --pretty`. Navigate to a group from the groups list (Plan 01 wired `router.push(/group/ID)`). Verify:
1. Group detail screen renders with group name and avatar
2. Share button opens system share sheet with invite link
3. Back navigation works
  </verify>
  <done>Group detail screen shows group info. Share button generates invite URL and opens system share sheet. Navigation from groups list to group detail works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify invite and deep link flow</name>
  <what-built>Complete invite flow: group detail with share button, deep link handling for hatian://join/CODE, and join screen that resolves invite codes. Combined with Plan 01's group creation and list.</what-built>
  <how-to-verify>
1. Open the app and create a group from the home screen
2. Tap the group to open group detail
3. Tap "Invite Friends" / "Share Link" -- verify system share sheet opens with a hatian:// URL
4. Copy the invite link
5. Test deep link: on simulator, run `npx uri-scheme open "hatian://join/INVITE_CODE" --ios` (replace INVITE_CODE with the actual code from the share URL)
6. Verify the join screen shows briefly then navigates to the group detail
7. Verify the groups list shows the group
8. Test with an invalid code -- should show error with "Go Home" option
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --pretty` passes
2. `app/+native-intent.tsx` exists and handles hatian://join/ URLs
3. `app/join/[code].tsx` resolves invite codes via RPC
4. `app/group/[id].tsx` shows group detail with working share button
5. Deep link from hatian://join/CODE reaches the join screen
6. System share sheet opens with correct invite URL format
</verification>

<success_criteria>
- User can tap share button on group detail and send invite link via share sheet
- Deep link (hatian://join/CODE) opens the app and triggers the join flow
- Join flow calls join_group_by_invite RPC and navigates to group on success
- Invalid invite codes show a clear error message
- All routes registered in root layout Stack
</success_criteria>

<output>
After completion, create `.planning/phases/03-groups/03-02-SUMMARY.md`
</output>
