---
phase: 03-groups
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00003_group_rpc_functions.sql
  - lib/database.types.ts
  - app/(tabs)/index.tsx
  - lib/auth-context.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new group by entering a name"
    - "Newly created group appears in the groups list immediately"
    - "User can view all groups they belong to on the home screen"
    - "Groups list is empty with friendly message for new users"
  artifacts:
    - path: "supabase/migrations/00003_group_rpc_functions.sql"
      provides: "create_group and join_group_by_invite RPC functions"
      contains: "create_group"
    - path: "lib/database.types.ts"
      provides: "Updated types with Functions for create_group, join_group_by_invite, get_user_group_ids"
      contains: "create_group"
    - path: "app/(tabs)/index.tsx"
      provides: "Groups list screen with create group flow"
      min_lines: 80
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "supabase.rpc('create_group')"
      via: "RPC call on group name submit"
      pattern: "rpc.*create_group"
    - from: "app/(tabs)/index.tsx"
      to: "supabase.from('group_members').select"
      via: "fetch groups query with join"
      pattern: "group_members.*select.*groups"
---

<objective>
Create the Supabase RPC functions for atomic group creation and invite-based joining, update TypeScript types, and build the groups list home screen with a create-group flow.

Purpose: This is the foundation for the entire Groups phase -- without DB functions and the groups list, nothing else (invites, deep links, member lists) can be built.
Output: Working groups list on home tab, create group modal/prompt, Supabase migration with RPC functions.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-groups/03-RESEARCH.md
@lib/database.types.ts
@lib/supabase.ts
@lib/auth-context.tsx
@app/(tabs)/index.tsx
@app/(tabs)/_layout.tsx
@components/ui/Avatar.tsx
@theme/index.ts
@supabase/migrations/00001_initial_schema.sql
@supabase/migrations/00002_fix_rls_recursion.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase RPC migration and update TypeScript types</name>
  <files>
    supabase/migrations/00003_group_rpc_functions.sql
    lib/database.types.ts
  </files>
  <action>
Create a new migration file `supabase/migrations/00003_group_rpc_functions.sql` with two security definer RPC functions:

1. `create_group(group_name text) returns uuid` -- security definer, search_path = public:
   - Gets current_user_id from auth.uid(), raises 'Not authenticated' if null
   - Inserts into groups (name, created_by) with (group_name, current_user_id), returning id into new_group_id
   - Inserts into group_members (group_id, user_id) with (new_group_id, current_user_id)
   - Returns new_group_id
   - This is atomic: both inserts happen in one transaction

2. `join_group_by_invite(invite text) returns uuid` -- security definer, search_path = public:
   - Gets current_user_id from auth.uid(), raises 'Not authenticated' if null
   - Selects id from groups where invite_code = invite into found_group_id
   - Raises 'Invalid invite code' if not found
   - Inserts into group_members (group_id, user_id) with ON CONFLICT (group_id, user_id) DO NOTHING (idempotent join)
   - Returns found_group_id

Both functions use `language plpgsql security definer set search_path = public`.

Then update `lib/database.types.ts`:
- Add the Functions section (replace the `[_ in never]: never` placeholder):
  ```
  Functions: {
    create_group: {
      Args: { group_name: string };
      Returns: string;
    };
    join_group_by_invite: {
      Args: { invite: string };
      Returns: string;
    };
    get_user_group_ids: {
      Args: Record<string, never>;
      Returns: string[];
    };
  };
  ```

Run `npx supabase db push` to apply the migration (or note if local-only).
  </action>
  <verify>
Run `npx supabase db push` or verify the migration file is syntactically correct SQL. Check that `lib/database.types.ts` compiles: `npx tsc --noEmit --pretty`.
  </verify>
  <done>Migration file exists with both RPC functions. TypeScript types include create_group, join_group_by_invite, and get_user_group_ids in Functions. Types compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Build groups list screen and create-group flow</name>
  <files>
    app/(tabs)/index.tsx
    lib/auth-context.tsx
  </files>
  <action>
Replace the current design-system showcase in `app/(tabs)/index.tsx` with a real groups list screen.

**Groups List Screen:**
- SafeAreaView with background color from theme
- Header: "Groups" as h1, with a "+" button (or "New Group" button) in the top-right area
- Fetch user's groups on mount using the pattern from research:
  ```typescript
  const { data } = await supabase
    .from('group_members')
    .select('group_id, groups (id, name, invite_code, created_by, created_at)')
    .eq('user_id', user.id)
    .order('joined_at', { ascending: false });
  ```
- Get user.id from auth context (add `user` to the auth context exports if not already exposed -- check auth-context.tsx and expose the session user id)
- Render groups as a FlatList of pressable Card components, each showing:
  - Group avatar (deterministic emoji from group name using hash -- implement `getGroupEmoji(name)` inline or as a helper at the top of the file using EMOJI_LIST from Avatar component)
  - Group name as bodyMedium text
  - Member count as caption/secondary text (use a count from the group_members query or a separate count -- simplest: just show the group name and avatar for now, member count can come from Plan 03)
- Each card is a Pressable that navigates to `group/[id]` (the route will be created in Plan 03, but wire the navigation now with `router.push(\`/group/\${group.id}\`)`)
- Empty state: friendly message like "No groups yet" with a prompt to create one, using the Text component with textSecondary color
- Pull-to-refresh on the FlatList (onRefresh + refreshing state)

**Create Group Flow:**
- Use `Alert.prompt` on iOS for simple group name input (consistent with the Alert.alert pattern used for sign-out in Phase 2)
- On Android, Alert.prompt is not available. Use a simple approach: a state-driven modal or a TextInput that appears inline. The simplest cross-platform approach: use a small Modal with a TextInput and two buttons (Cancel, Create).
- On submit: call `supabase.rpc('create_group', { group_name: name.trim() })`
- Validate: name must be 1-50 characters, trimmed
- On success: refetch groups list
- On error: show Alert.alert with error message
- Loading state on the create button while RPC is in flight

**Auth context update (if needed):**
- Ensure `user` (with at least `id`) is exposed from auth context. Check if `session?.user?.id` is already accessible. If the context only exposes `session`, that's fine -- use `session.user.id` directly in the screen. Only modify auth-context.tsx if truly needed.

Follow the existing design patterns: use colors, spacing from theme. Use Card, Text, Button, Avatar from components/ui. Dark background, consistent with the app aesthetic.
  </action>
  <verify>
Run `npx tsc --noEmit --pretty` to verify TypeScript compiles. Run `npx expo start` and verify:
1. Home tab shows "Groups" header (not the old design showcase)
2. Empty state shows when user has no groups
3. Create group flow works (modal/prompt appears, validates input, creates group via RPC)
4. Newly created group appears in the list
5. Pull-to-refresh works
  </verify>
  <done>Home tab displays a groups list. User can create a group by name. Created group appears immediately in the list. Empty state is shown when no groups exist. Pull-to-refresh reloads the list.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --pretty` passes with no errors
2. Migration file contains both `create_group` and `join_group_by_invite` functions
3. Home screen shows groups list (not design showcase)
4. Creating a group via the UI inserts into both `groups` and `group_members` tables atomically
5. Groups list fetches from Supabase and renders cards with emoji avatars
</verification>

<success_criteria>
- User can create a group by entering a name and sees it appear in the groups list
- Groups list shows all groups the user belongs to
- Empty state displayed for users with no groups
- Database has create_group and join_group_by_invite RPC functions
- TypeScript types updated with Functions section
</success_criteria>

<output>
After completion, create `.planning/phases/03-groups/03-01-SUMMARY.md`
</output>
