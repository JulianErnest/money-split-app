---
phase: 11-activity-feed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00022_activity_feed_rpc.sql
  - lib/activity.ts
  - lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "A Supabase RPC exists that returns expenses and settlements merged chronologically across all user groups"
    - "TypeScript types and fetch functions exist for activity data"
    - "Relative timestamp formatting converts ISO dates to human-readable strings like '2h ago' and 'Yesterday'"
    - "Day label grouping converts ISO dates to 'Today', 'Yesterday', or 'Feb 20' format"
  artifacts:
    - path: "supabase/migrations/00022_activity_feed_rpc.sql"
      provides: "get_recent_activity RPC with UNION ALL of expenses and settlements"
      contains: "create or replace function public.get_recent_activity"
    - path: "lib/activity.ts"
      provides: "ActivityItem type, fetchRecentActivity, formatRelativeTime, getDayLabel"
      exports: ["ActivityItem", "fetchRecentActivity", "formatRelativeTime", "getDayLabel"]
    - path: "lib/database.types.ts"
      provides: "get_recent_activity function type in Database interface"
      contains: "get_recent_activity"
  key_links:
    - from: "lib/activity.ts"
      to: "supabase RPC get_recent_activity"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc\\(\"get_recent_activity\""
    - from: "lib/database.types.ts"
      to: "supabase/migrations/00022_activity_feed_rpc.sql"
      via: "type definition matching RPC signature"
      pattern: "get_recent_activity"
---

<objective>
Create the data foundation for the activity feed: a Supabase RPC that merges expenses and settlements into a unified chronological feed, plus TypeScript types, fetch functions, and timestamp formatting utilities.

Purpose: All activity feed UI (dashboard section and history screen) depends on this data layer. The RPC handles the core challenge of querying two separate tables (expenses and settlements) and returning a merged, sorted, paginated result with denormalized group and payer names.
Output: One SQL migration, one TypeScript lib module, and updated database types.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-activity-feed/11-RESEARCH.md

@lib/database.types.ts
@lib/supabase.ts
@lib/expense-utils.ts
@supabase/migrations/00021_settlements_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create get_recent_activity RPC migration</name>
  <files>supabase/migrations/00022_activity_feed_rpc.sql</files>
  <action>
Create a new Supabase migration file that defines the `get_recent_activity` PostgreSQL function.

The function signature:
- Parameters: `p_limit integer default 5`, `p_offset integer default 0`, `p_since timestamptz default (now() - interval '30 days')`
- Returns table: `id uuid, type text, description text, amount numeric(10,2), payer_name text, payer_id uuid, group_name text, group_id uuid, expense_id uuid, created_at timestamptz`
- Language: plpgsql, security definer, set search_path = public

The function body:
1. Get `current_user_id` from `auth.uid()`, raise exception if null ('Not authenticated')
2. CTE `my_groups`: select `group_id` from `group_members` where `user_id = current_user_id`
3. First SELECT: expenses from user's groups -- join `groups` for `group_name`, join `users` on `paid_by` for `payer_name` (coalesce to 'Unknown'). Set `type = 'expense'`, `expense_id = e.id`. Filter `created_at >= p_since`.
4. UNION ALL
5. Second SELECT: settlements from user's groups -- join `groups` for `group_name`, join `users` on `paid_by` for `payer_name`. Set `type = 'settlement'`, `description = 'Settlement'`, `expense_id = null::uuid`. Filter `created_at >= p_since`.
6. ORDER BY `created_at DESC`
7. LIMIT `p_limit` OFFSET `p_offset`

Follow the exact pattern from 00021_settlements_table.sql for function style (security definer, auth.uid(), CTE).

IMPORTANT: The amount column in both expenses and settlements is stored as `numeric(10,2)` (pesos). Return it as-is -- the UI layer handles peso-to-centavo conversion.
  </action>
  <verify>
Read the migration file and confirm:
1. Function accepts p_limit, p_offset, p_since parameters with correct defaults
2. UNION ALL merges expenses and settlements
3. JOINs on groups and users tables for denormalized names
4. Returns all required columns including group_id and expense_id
5. Applies p_since filter and ORDER BY created_at DESC with LIMIT/OFFSET
6. Uses security definer and auth.uid() pattern
  </verify>
  <done>Migration file exists at supabase/migrations/00022_activity_feed_rpc.sql with a valid get_recent_activity function that UNIONs expenses and settlements with group/payer name joins, 30-day default filter, and offset pagination.</done>
</task>

<task type="auto">
  <name>Task 2: Create activity lib module and update database types</name>
  <files>lib/activity.ts, lib/database.types.ts</files>
  <action>
**lib/activity.ts** -- Create new file with:

1. `ActivityItem` interface:
   ```
   id: string
   type: "expense" | "settlement"
   description: string
   amount: number (pesos from DB)
   payer_name: string
   payer_id: string
   group_name: string
   group_id: string
   expense_id: string | null
   created_at: string
   ```

2. `fetchRecentActivity(limit = 5, offset = 0): Promise<ActivityItem[]>` -- calls `supabase.rpc("get_recent_activity", { p_limit: limit, p_offset: offset })`. Returns empty array on error.

3. `formatRelativeTime(dateStr: string): string` -- converts ISO timestamp to relative string:
   - < 1 min: "Just now"
   - < 60 min: "{N}m ago"
   - < 24 hours: "{N}h ago"
   - 1 day ago: "Yesterday"
   - < 7 days: "{N}d ago"
   - >= 7 days: "Feb 20" format (using toLocaleDateString with month short + day numeric)

4. `getDayLabel(dateStr: string): string` -- converts ISO timestamp to day group label:
   - Same calendar day as now: "Today"
   - Previous calendar day: "Yesterday"
   - Otherwise: "Feb 20" format (month short + day numeric)

Import supabase from `@/lib/supabase`.

**lib/database.types.ts** -- Add `get_recent_activity` to the Functions section:
```
get_recent_activity: {
  Args: {
    p_limit?: number;
    p_offset?: number;
    p_since?: string;
  };
  Returns: Array<{
    id: string;
    type: string;
    description: string;
    amount: number;
    payer_name: string;
    payer_id: string;
    group_name: string;
    group_id: string;
    expense_id: string | null;
    created_at: string;
  }>;
};
```

Add this AFTER the existing `delete_settlement` entry, before the closing `};` of Functions.
  </action>
  <verify>
1. `npx tsc --noEmit` completes without new errors (pre-existing errors in index.tsx and _layout.tsx are known and acceptable)
2. Read lib/activity.ts and confirm all 4 exports exist: ActivityItem, fetchRecentActivity, formatRelativeTime, getDayLabel
3. Read lib/database.types.ts and confirm get_recent_activity is in the Functions section
  </verify>
  <done>lib/activity.ts exports ActivityItem type, fetchRecentActivity function, formatRelativeTime function, and getDayLabel function. lib/database.types.ts includes get_recent_activity function type matching the RPC signature. TypeScript compiles without new errors.</done>
</task>

</tasks>

<verification>
1. Migration file exists and contains valid SQL for get_recent_activity RPC
2. lib/activity.ts exports all required types and functions
3. lib/database.types.ts includes get_recent_activity in Functions
4. TypeScript compiles (`npx tsc --noEmit`) without new errors
</verification>

<success_criteria>
- get_recent_activity RPC defined in migration with UNION ALL of expenses and settlements
- ActivityItem TypeScript type matches RPC return shape
- fetchRecentActivity calls the RPC with limit/offset parameters
- formatRelativeTime produces relative strings ("2h ago", "Yesterday", "3d ago")
- getDayLabel produces day group labels ("Today", "Yesterday", "Feb 20")
- Database types updated with new function signature
</success_criteria>

<output>
After completion, create `.planning/phases/11-activity-feed/11-01-SUMMARY.md`
</output>
