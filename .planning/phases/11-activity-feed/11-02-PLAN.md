---
phase: 11-activity-feed
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - app/(tabs)/index.tsx
  - components/ui/Skeleton.tsx
  - app/activity.tsx
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Home screen shows the 5 most recent activities (expenses and settlements merged) in a flat list below the balance header"
    - "Each activity item displays description/type, amount, who paid, and which group"
    - "Tapping an activity item navigates to the relevant expense detail or group"
    - "A 'See all' link is visible when activities exist, navigating to the Activity History screen"
    - "Activity History screen shows full chronological list with day headers (Today, Yesterday, Feb 20)"
    - "Activity History screen supports infinite scroll to load more items"
    - "Skeleton shimmer placeholders display while activity data loads"
    - "When no activity exists in last 30 days, a compact empty message appears"
  artifacts:
    - path: "app/(tabs)/index.tsx"
      provides: "Dashboard activity section replacing 'Coming soon' placeholder"
      contains: "fetchRecentActivity"
    - path: "components/ui/Skeleton.tsx"
      provides: "ActivityItemSkeleton component"
      contains: "ActivityItemSkeleton"
    - path: "app/activity.tsx"
      provides: "Activity History screen with infinite scroll and day headers"
      contains: "onEndReached"
    - path: "app/_layout.tsx"
      provides: "Stack.Screen registration for activity route"
      contains: "activity"
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "lib/activity.ts"
      via: "import fetchRecentActivity, formatRelativeTime, ActivityItem"
      pattern: "import.*from.*@/lib/activity"
    - from: "app/(tabs)/index.tsx"
      to: "app/activity.tsx"
      via: "router.push('/activity') on 'See all' press"
      pattern: "router\\.push.*activity"
    - from: "app/(tabs)/index.tsx"
      to: "expense detail / group detail"
      via: "router.push on activity item tap"
      pattern: "router\\.push.*group"
    - from: "app/activity.tsx"
      to: "lib/activity.ts"
      via: "import fetchRecentActivity, getDayLabel, ActivityItem"
      pattern: "import.*from.*@/lib/activity"
    - from: "app/activity.tsx"
      to: "FlatList onEndReached"
      via: "infinite scroll pagination"
      pattern: "onEndReached"
---

<objective>
Wire the activity feed into the home screen dashboard and create the Activity History screen. Replace the "Coming soon" placeholder with real activity data, add skeleton loading, and build the full history screen with infinite scroll and day headers.

Purpose: This makes the dashboard a true activity hub where users see what happened recently across all their groups without navigating into each one. The "See all" screen provides full history access.
Output: Modified dashboard with live activity feed, new Activity History screen, skeleton components, route registration.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-activity-feed/11-RESEARCH.md
@.planning/phases/11-activity-feed/11-01-SUMMARY.md

@app/(tabs)/index.tsx
@app/_layout.tsx
@components/ui/Skeleton.tsx
@lib/activity.ts
@lib/expense-utils.ts
@theme/index.ts
@components/ui/Text.tsx
@components/ui/Card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace activity placeholder with real feed on dashboard and add skeleton</name>
  <files>app/(tabs)/index.tsx, components/ui/Skeleton.tsx</files>
  <action>
**components/ui/Skeleton.tsx** -- Add `ActivityItemSkeleton` and export it:
- Row layout: 32px round skeleton (icon area) + flex column with 65% width/14px height line + 40% width/12px height line + 60px width/14px height skeleton on the right (amount area)
- Use existing SKELETON_COLORS, COLOR_MODE constants and spacing/radius from theme
- Also add `ActivitySectionSkeleton` that wraps 3x `ActivityItemSkeleton` in a `Skeleton.Group show` with vertical gap

**app/(tabs)/index.tsx** -- Major changes to wire the activity feed:

1. **New imports:** Add `import { ActivityItem, fetchRecentActivity, formatRelativeTime } from "@/lib/activity"` and `import { ActivitySectionSkeleton } from "@/components/ui/Skeleton"` and `import { formatPeso } from "@/lib/expense-utils"` (already imported).

2. **New state:** Add `const [activities, setActivities] = useState<ActivityItem[]>([])` and `const [activitiesLoading, setActivitiesLoading] = useState(true)`.

3. **Fetch function:** Add `fetchActivities` useCallback that calls `fetchRecentActivity(5)`, sets state, and sets loading false. Call it in the initial `useEffect` alongside fetchGroups/fetchInvites. Add it to `useFocusEffect`, `handleRefresh`, and the sync-complete listener.

4. **Activity item rendering:** Create a local `renderActivityItem` function that renders each ActivityItem as a Pressable row:
   - Left: Small View (32x32, rounded, centered) with text "E" (accent bg for expenses) or "S" (green/accent bg for settlements) to differentiate types
   - Middle (flex: 1): Top line = description (bodyMedium, textPrimary). Bottom line = group_name + " . " + formatRelativeTime(created_at) (caption, textSecondary)
   - Right: Amount = formatPeso(Math.round(item.amount * 100)) (bodyMedium). Expenses in textPrimary, settlements in accent color.
   - onPress: For expenses, `router.push(`/group/${item.group_id}/expense/${item.expense_id}`)`. For settlements, `router.push(`/group/${item.group_id}`)`.
   - No payer avatars on dashboard -- keep text-only for density per research recommendation.

5. **Dashboard header update:** Replace the activity placeholder block (the "Coming soon" section, lines ~621-640) in the `dashboardHeader` useMemo:
   - Keep the sectionDivider before and after
   - Section header row: "Recent Activity" (label, textSecondary) on left, "See all" (caption, accent) as Pressable on right -- same row with flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'. "See all" only visible when activities.length > 0. On press: `router.push("/activity" as any)`.
   - Below header: if activitiesLoading, show `<ActivitySectionSkeleton />`. Else if activities.length === 0, show compact text "No recent activity" (caption, textTertiary). Else, render activities.map(item => renderActivityItem(item)).
   - Update useMemo dependencies to include activities, activitiesLoading.

6. **Section reordering (Claude's discretion):** Reorder the `sections` useMemo array to put groups BEFORE invites. Change from `[invites, groups]` to `[groups, invites]`. This addresses the user's concern that pending invites push groups lower. The invite section empty state "No pending invites" should be removed (since invites are now at the bottom, showing an empty state wastes space). Instead, only render the invite section if `pendingInvites.length > 0`.

7. **Styles:** Add styles for `activityItem` (row layout), `activityIcon` (32x32 rounded center), `activityInfo` (flex column), `activityHeaderRow` (space-between row for "Recent Activity" + "See all").

8. **Cache:** Cache the 5-item activity preview using the existing `setCachedData`/`getCachedData` pattern with key `${user.id}:recent_activity`. Load from cache on mount (same as groups pattern). This provides instant display on subsequent visits.
  </action>
  <verify>
1. `npx tsc --noEmit` completes without new errors (pre-existing errors acceptable)
2. Read app/(tabs)/index.tsx and confirm:
   - "Coming soon" text is gone
   - fetchRecentActivity is imported and called
   - Activity items render with description, amount, group name, relative time
   - "See all" pressable exists with router.push to /activity
   - Sections array puts groups before invites
3. Read components/ui/Skeleton.tsx and confirm ActivityItemSkeleton and ActivitySectionSkeleton are exported
4. `npx expo export --platform ios 2>&1 | tail -5` succeeds (or `npx expo export --platform web` if faster)
  </verify>
  <done>Dashboard shows real activity items (or skeleton while loading, or "No recent activity" when empty) in place of the "Coming soon" placeholder. Each item shows description, amount, group name, and relative timestamp. "See all" link navigates to /activity. Groups section appears before invites section. Activity data is cached for instant display.</done>
</task>

<task type="auto">
  <name>Task 2: Create Activity History screen with infinite scroll and day headers</name>
  <files>app/activity.tsx, app/_layout.tsx</files>
  <action>
**app/_layout.tsx** -- Add a new Stack.Screen entry for the activity route:
- Add `<Stack.Screen name="activity" />` inside the Stack component, after the existing screen entries (after `group/[id]`).

**app/activity.tsx** -- Create new screen file:

1. **Imports:** SafeAreaView, View, FlatList, Pressable, ActivityIndicator, StyleSheet from react-native. Text from @/components/ui. ActivityItem, fetchRecentActivity, formatRelativeTime, getDayLabel from @/lib/activity. formatPeso from @/lib/expense-utils. useRouter from expo-router. colors, spacing, radius from @/theme. Haptics from expo-haptics. useState, useEffect, useCallback from react.

2. **Constants:** `const PAGE_SIZE = 20;`

3. **State:** activities (ActivityItem[]), loading (boolean, true initially), loadingMore (boolean), hasMore (boolean, true initially), offset (number, 0).

4. **Load initial:** useEffect on mount calls `loadInitial()` which fetches with limit=PAGE_SIZE, offset=0. Sets activities, sets offset to data.length, sets hasMore to data.length === PAGE_SIZE, sets loading false.

5. **Load more:** `loadMore` function -- if loadingMore or !hasMore, return. Set loadingMore true. Fetch with PAGE_SIZE and current offset. Append to activities. Update offset. Set hasMore false if data.length < PAGE_SIZE. Set loadingMore false.

6. **Day header rendering:** In the FlatList `renderItem`, before rendering the activity item row, check if the current item's getDayLabel differs from the previous item's getDayLabel (by comparing with `data[index - 1]`). If different (or index === 0), render a day header View with Text (label variant, textSecondary, uppercase) showing the day label. Then render the activity item row below it.

7. **Activity item row:** Same visual design as dashboard but slightly more spacious. Pressable row with:
   - Left: Type indicator (32x32 rounded, "E" or "S" with color differentiation)
   - Middle: description (bodyMedium, textPrimary), group_name + " . " + formatRelativeTime (caption, textSecondary)
   - Right: amount (bodyMedium, textPrimary for expenses, accent for settlements)
   - onPress: expenses navigate to `/group/${groupId}/expense/${expenseId}`, settlements navigate to `/group/${groupId}`
   - Haptic feedback (impactAsync light) on press

8. **Screen layout:**
   - SafeAreaView with edges={["top"]}
   - Header row: back button (Pressable with "<" text or arrow, navigates back via router.back()), title "Activity History" (h2, textPrimary)
   - FlatList below header with:
     - `data={activities}`
     - `onEndReached={loadMore}`
     - `onEndReachedThreshold={0.5}`
     - `ListFooterComponent` shows ActivityIndicator when loadingMore
     - `ListEmptyComponent` shows loading skeleton (use Skeleton.Group with multiple ActivityItemSkeleton) when loading, or EmptyState (emoji "ðŸ“‹", headline "No recent activity", subtext "Expenses and settlements from your groups will show up here") when not loading and empty
     - `contentContainerStyle` with padding and flexGrow: 1
     - `keyExtractor={(item) => item.id}`

9. **Styles:** Container, header, back button, list container, activity row, day header, empty state area.

10. **No filtering per locked decision** -- just a flat chronological list with day headers for visual grouping.
  </action>
  <verify>
1. `npx tsc --noEmit` completes without new errors
2. Read app/activity.tsx and confirm:
   - FlatList with onEndReached for infinite scroll
   - Day headers render between items when day changes
   - Activity items show description, amount, group, relative time
   - Navigation on tap works for both expenses and settlements
   - EmptyState shown when no data
3. Read app/_layout.tsx and confirm Stack.Screen name="activity" is registered
4. `npx expo export --platform ios 2>&1 | tail -5` succeeds
  </verify>
  <done>Activity History screen exists at app/activity.tsx, registered in the root Stack. Shows full chronological activity list with day headers ("Today", "Yesterday", "Feb 20"). Supports infinite scroll loading 20 items at a time. Tapping items navigates to expense detail or group. Shows empty state when no activity exists. Back button returns to dashboard.</done>
</task>

</tasks>

<verification>
1. Home screen "Coming soon" placeholder is replaced with real activity items
2. Activity items show description, amount (formatted in pesos), group name, and relative timestamp
3. Tapping expense items navigates to expense detail; tapping settlements navigates to group
4. "See all" link appears and navigates to Activity History screen
5. Activity History screen shows items grouped by day with headers
6. Infinite scroll loads more items when reaching bottom
7. Skeleton placeholders show while data loads on both screens
8. Empty state appears when no activity exists in last 30 days
9. Groups section appears before invites section on dashboard
10. TypeScript compiles without new errors
11. Expo export succeeds
</verification>

<success_criteria>
- Dashboard activity section shows 5 most recent items (expenses + settlements merged chronologically)
- Each item: description/type, formatted peso amount, payer info accessible, group name, relative timestamp
- Tap expense -> expense detail screen; tap settlement -> group detail screen
- "See all" -> Activity History screen with back navigation
- History screen: day headers, infinite scroll, no filters
- Skeleton loading on both screens
- Compact empty state on dashboard; full EmptyState on history screen
- Section order: Balance > Activity > Groups > Invites (invites only shown when pending)
</success_criteria>

<output>
After completion, create `.planning/phases/11-activity-feed/11-02-SUMMARY.md`
</output>
