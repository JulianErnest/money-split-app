---
phase: 07-invite-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - supabase/migrations/00019_invite_status_consent_flow.sql
  - lib/group-members.ts
autonomous: true

must_haves:
  truths:
    - "When creator adds someone by phone, they appear as a pending invite (not a full group member) even if they already have an account"
    - "The pending_members table has an invite_status column with values pending/accepted/declined"
    - "Auto-link trigger on signup creates the users row but does NOT auto-join to group_members"
    - "Invite link flow (join_group_by_invite) still works as instant auto-join with no changes"
  artifacts:
    - path: "supabase/migrations/00019_invite_status_consent_flow.sql"
      provides: "invite_status column, user_id column on pending_members, consent-aware add_pending_member and auto-link trigger"
      contains: "invite_status"
    - path: "lib/group-members.ts"
      provides: "Updated member fetching that includes pending invite status"
      contains: "invite_status"
  key_links:
    - from: "add_pending_member RPC"
      to: "pending_members table"
      via: "always inserts as pending (never auto-adds to group_members)"
      pattern: "invite_status.*pending"
    - from: "handle_pending_member_claim trigger"
      to: "pending_members.user_id"
      via: "links user identity but does not auto-join"
      pattern: "update pending_members.*set user_id"
---

<objective>
Add invite_status and user_id columns to pending_members, convert add_pending_member to always create pending invites (never auto-add), and make the auto-link trigger consent-aware.

Purpose: INV-03 (phone-added users appear as pending invites) requires the core behavioral change: adding someone by phone no longer auto-adds them. This is the schema foundation that Phase 8 (accept/decline UI) builds on.

Output: A SQL migration with schema changes and updated RPCs, plus updated client-side member fetching to surface invite status.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-invite-infrastructure/07-RESEARCH.md
@.planning/phases/07-invite-infrastructure/07-01-SUMMARY.md
@supabase/migrations/00014_fix_phone_format_mismatch.sql
@lib/group-members.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for invite schema and consent-aware RPCs</name>
  <files>supabase/migrations/00019_invite_status_consent_flow.sql</files>
  <action>
Create migration `00019_invite_status_consent_flow.sql` with three parts:

**Part 1: Schema changes on pending_members**

```sql
-- Add invite_status column (defaults to 'pending' for existing rows)
alter table public.pending_members
  add column if not exists invite_status text not null default 'pending'
  constraint pending_members_invite_status_check
  check (invite_status in ('pending', 'accepted', 'declined'));

-- Add optional user_id column (for Phase 8 invite inbox queries)
-- When a known user is added by phone, we store their user_id here
-- so Phase 8 can query: SELECT * FROM pending_members WHERE user_id = auth.uid()
alter table public.pending_members
  add column if not exists user_id uuid references users(id);

-- Index for Phase 8 inbox lookups
create index if not exists idx_pending_members_user_id
  on pending_members(user_id) where user_id is not null;
```

**Part 2: Replace add_pending_member to ALWAYS create pending invite**

This replaces the function from Plan 01 (migration 00018). Key behavioral change: even if the user already exists and has an account, they are NOT auto-added to group_members. Instead, a pending_members row is created with their user_id linked.

The function must:
- Keep the same signature: `(p_group_id uuid, p_phone_number text, p_nickname text default null)`
- Keep phone normalization (`normalized_phone := ltrim(p_phone_number, '+')`)
- Keep creator-only guard from 00018
- Keep duplicate pending member check (normalized)
- Check if user already a full group member (raise exception if yes)
- **CHANGE**: If user exists but NOT in group, create a pending_members row with `user_id = existing_user_id` and `invite_status = 'pending'` instead of inserting into group_members. Do NOT transfer expense splits or delete pending members. Do NOT insert into group_members.
- **KEEP**: If user does not exist, create pending_members row as before (user_id stays NULL, will be linked by trigger on signup)
- Store `invite_status = 'pending'` in both cases

```sql
-- When existing user is found but not in group:
insert into pending_members (group_id, phone_number, added_by, nickname, invite_status, user_id)
values (p_group_id, normalized_phone, current_user_id, nullif(trim(p_nickname), ''), 'pending', existing_user_id)
returning id into new_pending_id;

return new_pending_id;

-- When user does not exist:
insert into pending_members (group_id, phone_number, added_by, nickname, invite_status)
values (p_group_id, normalized_phone, current_user_id, nullif(trim(p_nickname), ''), 'pending')
returning id into new_pending_id;

return new_pending_id;
```

**Part 3: Replace auto-link trigger to be consent-aware**

The `handle_pending_member_claim` trigger fires on `auth.users` INSERT (new signup). It currently auto-joins users to groups and transfers expense splits. Change it to:

1. Still ensure `public.users` row exists (needed for FK constraints)
2. Find matching pending_members by normalized phone
3. **Instead of auto-joining**: Update `pending_members.user_id = new.id` so the invite inbox (Phase 8) can find them
4. Do NOT insert into group_members
5. Do NOT transfer expense_splits
6. Do NOT delete pending_members

```sql
create or replace function public.handle_pending_member_claim()
returns trigger
language plpgsql
security definer
set search_path = public
as $$
begin
  -- Ensure public.users row exists
  insert into users (id, phone_number)
  values (new.id, new.phone)
  on conflict (id) do nothing;

  -- Link identity to pending invites (don't auto-join, user must accept in Phase 8)
  update pending_members
  set user_id = new.id
  where user_id is null
    and ltrim(phone_number, '+') = ltrim(new.phone, '+');

  return new;
exception
  when others then
    raise warning 'handle_pending_member_claim failed for phone %: %',
      new.phone, sqlerrm;
    return new;
end;
$$;
```

Add clear comment headers for each part. Note that join_group_by_invite is NOT modified (INV-08).
  </action>
  <verify>
Run `supabase db reset` to apply all migrations through 00019. Verify:
1. `pending_members` table has `invite_status` and `user_id` columns
2. Existing pending_members rows have `invite_status = 'pending'` (default)
3. The add_pending_member function creates pending_members rows (not group_members) for existing users
4. The auto-link trigger updates user_id but does not auto-join
  </verify>
  <done>
Migration 00019 applies cleanly. add_pending_member always creates pending invites. Auto-link trigger links identity without auto-joining. Schema is ready for Phase 8 accept/decline flows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update client member fetching to include invite status</name>
  <files>lib/group-members.ts</files>
  <action>
Read `lib/group-members.ts` to understand the current member fetching pattern. This file provides the unified member list (real members + pending members) used by the group detail screen.

Update it to:
1. Include `invite_status` in the pending_members query (add to the select)
2. Surface `invite_status` in the returned member type so the UI can distinguish between pending-invite members and full members
3. If there is a TypeScript type for pending members or unified members, add `invite_status?: 'pending' | 'accepted' | 'declined'` to it

Also update `lib/database.types.ts` if pending_members types are defined there -- add the `invite_status` and `user_id` fields to match the new schema.

Do NOT change the group detail UI rendering yet -- Phase 8 will add the accept/decline buttons. The status field just needs to flow through to the data layer so it is available.

If the file exports a function that fetches group members, ensure the pending members portion includes invite_status in its select query. For example:
```typescript
.select('id, phone_number, nickname, added_by, invite_status')
```
  </action>
  <verify>
Run `npx expo export --platform ios 2>&1 | tail -5` to confirm TypeScript compiles without errors.

Read the updated file to verify:
- invite_status is included in pending member queries
- The type definitions include invite_status
  </verify>
  <done>
Client-side member fetching includes invite_status from pending_members. Type definitions updated. Phase 8 can now read invite_status to render accept/decline UI.
  </done>
</task>

</tasks>

<verification>
1. Migration 00019 applies cleanly on `supabase db reset`
2. pending_members table has invite_status (text, not null, default 'pending') and user_id (uuid, nullable FK to users)
3. add_pending_member: adding an existing user creates a pending_members row with their user_id, NOT a group_members row
4. Auto-link trigger: new signup links user_id on pending_members but does NOT auto-join groups
5. join_group_by_invite: unchanged, still instant auto-join (INV-08)
6. Client: group-members.ts fetches invite_status, types updated
7. App compiles without TypeScript errors
</verification>

<success_criteria>
- INV-03: Phone-added users appear as pending invites, not auto-added members
- INV-08: Invite link flow unchanged (verified by NOT modifying join_group_by_invite)
- Schema ready for Phase 8: invite_status column exists, user_id column exists for inbox queries
- Auto-link trigger is consent-aware: links identity without auto-joining
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-invite-infrastructure/07-02-SUMMARY.md`
</output>
