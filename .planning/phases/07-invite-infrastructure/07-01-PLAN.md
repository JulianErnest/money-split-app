---
phase: 07-invite-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00018_fix_phone_normalization_creator_guard.sql
autonomous: true

must_haves:
  truths:
    - "Phone lookup in add_pending_member succeeds regardless of whether input has + prefix"
    - "Only the group creator can add members by phone; non-creators get an error"
    - "Existing group members are still detected correctly with normalized comparison"
  artifacts:
    - path: "supabase/migrations/00018_fix_phone_normalization_creator_guard.sql"
      provides: "Fixed add_pending_member RPC with phone normalization and creator guard"
      contains: "ltrim(p_phone_number, '+')"
  key_links:
    - from: "add_pending_member RPC"
      to: "users.phone_number"
      via: "normalized_phone comparison"
      pattern: "ltrim.*p_phone_number.*\\+"
    - from: "add_pending_member RPC"
      to: "groups.created_by"
      via: "creator permission check"
      pattern: "created_by = current_user_id"
---

<objective>
Fix the phone format mismatch bug in `add_pending_member` and add a creator-only permission guard.

Purpose: INV-01 (phone lookup works regardless of + prefix) and INV-02 (only group creator can add by phone) are database-level fixes that must be correct before the invite schema changes in Plan 02.

Output: A single SQL migration that replaces the `add_pending_member` function with phone normalization restored (regressed in migration 00015) and a new creator-only guard.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-invite-infrastructure/07-RESEARCH.md
@supabase/migrations/00014_fix_phone_format_mismatch.sql
@supabase/migrations/00015_pending_member_nickname.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration fixing phone normalization and adding creator guard</name>
  <files>supabase/migrations/00018_fix_phone_normalization_creator_guard.sql</files>
  <action>
Create a new migration `00018_fix_phone_normalization_creator_guard.sql` that does `CREATE OR REPLACE FUNCTION public.add_pending_member(...)`.

The function must include ALL existing behavior from migration 00015 (the current latest version that has the nickname parameter) but restore the phone normalization from migration 00014 and add a creator guard. Specifically:

1. **Keep**: Same function signature: `(p_group_id uuid, p_phone_number text, p_nickname text default null)`
2. **Keep**: `security definer`, `set search_path = public`, `set row_security = off`
3. **Keep**: Auth check, group membership check, nickname handling

4. **RESTORE phone normalization** (was in 00014, dropped by 00015):
   - Add `normalized_phone text` to declarations
   - After auth check: `normalized_phone := ltrim(p_phone_number, '+');`
   - User lookup: `WHERE u.phone_number = normalized_phone` (NOT `= p_phone_number`)
   - Pending member duplicate check: `WHERE group_id = p_group_id AND (phone_number = p_phone_number OR phone_number = normalized_phone)`
   - Store normalized: `INSERT INTO pending_members (..., phone_number, ...) VALUES (..., normalized_phone, ...)`
   - Pending cleanup on existing user path: match both formats

5. **ADD creator-only guard** (new for INV-02):
   After the group membership check, add:
   ```sql
   -- INV-02: Only the group creator can add members by phone
   if not exists (
     select 1 from groups
     where id = p_group_id and created_by = current_user_id
   ) then
     raise exception 'Only the group creator can add members by phone';
   end if;
   ```

6. **Keep the existing-user-auto-add behavior FOR NOW**. Plan 02 will change this to always create pending invites. In this migration, if the user already exists and is not in the group, they still get added directly to group_members (same as 00015). This keeps the function working between Plan 01 and Plan 02.

Add a clear comment header explaining: "Fixes phone normalization regression from 00015 and adds creator-only permission guard (INV-01, INV-02)."
  </action>
  <verify>
Run `supabase db reset` to apply all migrations. Verify the migration applies without errors.

Then verify the function behavior with SQL queries:
1. Phone normalization: Call `add_pending_member` with a `+63...` number and confirm it normalizes correctly (no duplicate if same number without `+` exists)
2. Creator guard: Attempt to call from a non-creator member and confirm it raises the "Only the group creator" exception
3. Existing behavior preserved: Creator can still add a pending member with nickname
  </verify>
  <done>
Migration 00018 applies cleanly. The add_pending_member function:
- Normalizes phone numbers by stripping leading `+` before all comparisons and storage
- Rejects non-creator callers with a clear error message
- Preserves nickname support from 00015
- Still handles existing-user and pending-member duplicate checks correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Gate Add Member button to creator-only in client</name>
  <files>app/group/[id].tsx</files>
  <action>
In `app/group/[id].tsx`, the "Add Member" button (around line 392-397) is currently shown unconditionally to all group members. Gate it behind a creator check.

The group detail already fetches `created_by` from the groups table (line 150). The current user's ID is available from the auth context.

1. Find where the current user's ID is available (from `useAuth` or similar context). Look at the existing code pattern -- the file already uses `member.id === group.created_by` for the member list display (line 571).

2. Add a check near the top of the component (or where group data is available):
   ```typescript
   const isGroupCreator = user?.id === group?.created_by;
   ```

3. Conditionally render the "Add Member" button:
   ```typescript
   {isGroupCreator && (
     <Button
       label="Add Member"
       variant="secondary"
       onPress={openAddMember}
       style={styles.addMemberButton}
     />
   )}
   ```

Keep the "Invite Friends" (share link) button visible to everyone -- INV-08 says invite link flow stays as instant auto-join for all members.

Do NOT change AddMemberModal or any other component. Only gate the button visibility.
  </action>
  <verify>
Run `npx expo export --platform ios 2>&1 | tail -5` to confirm the TypeScript compiles without errors.

Visually verify by reading the code that:
- The Add Member button is wrapped in `{isGroupCreator && (...)}`
- The Invite Friends button remains unconditional
  </verify>
  <done>
The "Add Member" button only appears for the group creator. Non-creator members can still see and use "Invite Friends" (share link). The RPC also enforces this server-side (from Task 1), so even if the UI gate is bypassed, the server rejects non-creator attempts.
  </done>
</task>

</tasks>

<verification>
1. Migration 00018 applies cleanly with `supabase db reset`
2. Phone normalization works: `+639...` and `639...` are treated as the same number
3. Creator guard works: non-creator gets rejection error
4. Client: Add Member button only visible to group creator
5. Client: Invite Friends button still visible to all members
</verification>

<success_criteria>
- INV-01: Phone lookup succeeds regardless of + prefix format
- INV-02: Only group creator can add members by phone (server + client enforced)
- No regression: existing add_pending_member behavior (nickname, duplicate detection) preserved
- App compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-invite-infrastructure/07-01-SUMMARY.md`
</output>
