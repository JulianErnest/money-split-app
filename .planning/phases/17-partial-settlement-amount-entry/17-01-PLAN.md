---
phase: 17-partial-settlement-amount-entry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/settlements/SettleConfirmSheet.tsx
  - lib/analytics.ts
autonomous: true

must_haves:
  truths:
    - "User sees full balance pre-filled when settle sheet opens"
    - "User can tap amount to activate NumPad and type a custom settlement amount"
    - "NumPad prevents typing amounts exceeding the current balance"
    - "Confirm button is disabled when amount is zero or below P1.00"
    - "Dust rule: if remainder after payment < P1.00, effective amount is forced to full balance"
    - "Confirm button shows dynamic text: Settle PX.XX with exact amount"
    - "Partial settlement toast: Settled PX.XX to Name"
    - "Full settlement toast: Fully settled with Name"
    - "Full amount button resets to the full balance"
    - "Confirming without editing records a full settlement (backwards-compatible)"
  artifacts:
    - path: "components/settlements/SettleConfirmSheet.tsx"
      provides: "Two-state settle sheet with NumPad, validation, dynamic snaps"
      contains: "useSettlementAmountInput"
    - path: "lib/analytics.ts"
      provides: "Updated trackSettleUp with isPartial flag"
      contains: "is_partial"
  key_links:
    - from: "components/settlements/SettleConfirmSheet.tsx"
      to: "components/expenses/NumPad.tsx"
      via: "import and render NumPad with onDigit/onDecimal/onBackspace"
      pattern: "NumPad.*onDigit"
    - from: "components/settlements/SettleConfirmSheet.tsx"
      to: "lib/expense-utils.ts"
      via: "formatPeso for amount display"
      pattern: "formatPeso"
    - from: "components/settlements/SettleConfirmSheet.tsx"
      to: "lib/analytics.ts"
      via: "trackSettleUp call with isPartial"
      pattern: "trackSettleUp"
---

<objective>
Rewrite SettleConfirmSheet to support partial settlement amount entry with NumPad input, validation, and differentiated confirmation messages.

Purpose: Users can choose how much to settle (from P1.00 up to the full balance) instead of always settling the full amount, enabling installment-style paybacks.
Output: Modified SettleConfirmSheet with two-state UI (display/edit), useSettlementAmountInput hook, validation logic, and updated analytics tracking.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-partial-settlement-amount-entry/17-CONTEXT.md
@.planning/phases/17-partial-settlement-amount-entry/17-RESEARCH.md

Key source files to reference:
@components/settlements/SettleConfirmSheet.tsx
@components/expenses/NumPad.tsx
@app/group/[id]/add-expense.tsx (useAmountInput hook pattern at line 41-79)
@components/ui/BottomSheet.tsx
@lib/expense-utils.ts (formatPeso, MAX_AMOUNT_CENTAVOS)
@lib/analytics.ts (trackSettleUp)
@components/ui/Toast.tsx (showToast API)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SettleConfirmSheet with partial settlement support</name>
  <files>components/settlements/SettleConfirmSheet.tsx</files>
  <action>
Rewrite SettleConfirmSheet.tsx to add partial settlement amount entry. The component keeps its existing props interface unchanged (the parent in app/group/[id].tsx already passes amountCentavos as the full balance). All new logic is internal to this file.

**1. Create useSettlementAmountInput(maxCentavos) hook inline in the file:**

Adapt the pattern from app/group/[id]/add-expense.tsx (line 41-79) with these changes:
- Accept `maxCentavos: number` parameter (the balance cap, NOT the global MAX_AMOUNT_CENTAVOS)
- `onDigit`: Same logic but cap check uses `maxCentavos` instead of `MAX_AMOUNT_CENTAVOS`
- `onDecimal`: Same logic as original
- `onBackspace`: Same logic as original
- Add `reset()` method: sets display to "0"
- Add `setFull()` method: sets display to `(maxCentavos / 100).toString()` -- converts centavos back to peso string
- Return: `{ display, centavos, onDigit, onDecimal, onBackspace, reset, setFull }`

**2. Create getEffectiveSettleAmount helper inline:**

```typescript
function getEffectiveSettleAmount(
  enteredCentavos: number,
  balanceCentavos: number,
): { amount: number; isFullSettle: boolean } {
  if (enteredCentavos === 0) return { amount: 0, isFullSettle: false };
  const remainder = balanceCentavos - enteredCentavos;
  // Dust rule: if remainder < P1.00, force full settlement
  if (remainder > 0 && remainder < 100) {
    return { amount: balanceCentavos, isFullSettle: true };
  }
  return {
    amount: enteredCentavos,
    isFullSettle: enteredCentavos >= balanceCentavos,
  };
}
```

**3. Two-state sheet component (display mode vs edit mode):**

Add `const [editing, setEditing] = useState(false);` state.

Dynamic snap points using useMemo:
```typescript
const snapPoints = useMemo(() => [editing ? "75%" : "35%"], [editing]);
```

Pass `snapPoints` to AppBottomSheet.

**Display mode (editing === false):**
- Header: "Settle Up" (h3, textPrimary)
- Subtitle: "{payerName} pays {receiverName}" (body, textSecondary)
- Amount display: Pressable wrapping the formatted full balance in h1 accent color, with peso sign. On press: call `amountInput.reset()` then `setEditing(true)`.
- Confirm button: label = `Settle ${peso}${formatPeso(amountCentavos)}` (shows full amount). On press: calls handleConfirmSettle with full amountCentavos (this is the backwards-compatible full settle path).
- Cancel pressable

**Edit mode (editing === true):**
- Header: "Settle Up" (same -- per discretion, keep title unchanged)
- Subtitle: "{payerName} pays {receiverName}" (same)
- Balance reference: Show "Balance: {peso}{formatPeso(amountCentavos)}" in textSecondary below subtitle
- Amount display: Show the hook's display value formatted as the amount being entered. Use h1 accent color with peso sign. Format: `{peso}${amountInput.display === "0" ? "0.00" : amountInput.display}`. The amount is NOT pressable in edit mode (already editing).
- Remaining balance preview: When the effective amount is partial (not full settle) and centavos > 0, show "Remaining: {peso}{formatPeso(amountCentavos - effectiveAmount)}" in textSecondary
- "Full amount" button: A Pressable styled as a secondary/outline action. Label: `Full amount ({peso}${formatPeso(amountCentavos)})`. On press: call `amountInput.setFull()`.
- NumPad component: `<NumPad onDigit={amountInput.onDigit} onDecimal={amountInput.onDecimal} onBackspace={amountInput.onBackspace} />`
- Confirm button: Dynamic label based on effective amount:
  - If effectiveAmount is 0 or < 100 centavos: label = "Settle" (button is disabled)
  - If isFullSettle: label = `Settle ${peso}${formatPeso(effectiveAmount)} (Full)`
  - If partial: label = `Settle ${peso}${formatPeso(effectiveAmount)}`
  - Disabled when: effectiveAmount < 100 (P1.00 minimum) OR effectiveAmount === 0 OR loading
- Cancel pressable: On press, reset editing state AND reset amount: `setEditing(false); amountInput.reset();`

**4. Update handleConfirmSettle to use effective amount:**

The function should accept the amount to settle (either the full amountCentavos in display mode, or the effective amount in edit mode). Compute effective amount using getEffectiveSettleAmount.

Update the RPC call to use effectiveAmount instead of always amountCentavos:
```typescript
p_amount: settleAmount / 100,
```

Update analytics call to include isPartial:
```typescript
trackSettleUp({ groupId, amount: settleAmount / 100, isPartial: !isFullSettle });
```

**5. Differentiated toast messages (per locked decision):**

- Full settle: `showToast({ message: "Fully settled with {receiverName}", type: "success" })`
- Partial settle: `showToast({ message: "Settled {peso}{formatPeso(settleAmount)} to {receiverName}", type: "success" })`

Use the peso sign character \u20B1.

**6. After successful settlement in edit mode:**
- Call onSettled() then onClose() (same as current behavior)
- The component unmounts on close, which naturally resets all state

**7. Styles to add:**
- `balanceRef`: textAlign center, for the balance reference line in edit mode
- `remainingPreview`: textAlign center, for the remaining balance preview
- `fullAmountButton`: secondary button style -- paddingVertical spacing[2], paddingHorizontal spacing[4], borderRadius radius.md, borderWidth 1, borderColor colors.border (or similar subtle outline)
- `fullAmountButtonText`: textAlign center
- Keep all existing styles, adjust as needed

**Important constraints:**
- Do NOT change the SettleConfirmSheetProps interface -- the parent passes amountCentavos as the full balance
- Do NOT modify NumPad.tsx -- it stays as a pure input component
- Do NOT add inline error messages -- disabled button only (per locked decision)
- Use integer centavos for ALL math -- never compare floats
- Import NumPad from "@/components/expenses/NumPad"
- Import useMemo from React (add to existing import)
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit` passes with no errors in SettleConfirmSheet.tsx.

Manual verification points (for developer):
1. Open a group with balances, tap "Settle Up" on any balance
2. Sheet opens at 35% showing full balance, confirm button says "Settle PX.XX"
3. Tap the amount -- sheet expands to 75%, NumPad appears, amount clears to P0.00
4. Type an amount less than the balance -- confirm button shows "Settle PX.XX" with typed amount
5. Type digits that would exceed balance -- they are ignored (capped)
6. Tap "Full amount" button -- amount resets to full balance
7. Confirm a partial amount -- toast says "Settled PX.XX to Name", balance refreshes
8. Confirm full amount without editing -- toast says "Fully settled with Name"
  </verify>
  <done>
SettleConfirmSheet supports two modes: display (backwards-compatible full settle) and edit (partial settle with NumPad). Validation enforces P1.00 minimum, balance cap, and dust rule. Confirm button shows dynamic amount text. Toast messages differentiate partial from full settlements. All 6 SETL requirements covered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update trackSettleUp analytics with isPartial flag</name>
  <files>lib/analytics.ts</files>
  <action>
Update the `trackSettleUp` function signature and PostHog capture call to include an `isPartial` boolean flag.

Change the function from:
```typescript
export function trackSettleUp(data: { groupId: string; amount: number }) {
  posthogClient.capture("settle_up", {
    group_id: data.groupId,
    amount: data.amount,
  });
}
```

To:
```typescript
export function trackSettleUp(data: { groupId: string; amount: number; isPartial: boolean }) {
  posthogClient.capture("settle_up", {
    group_id: data.groupId,
    amount: data.amount,
    is_partial: data.isPartial,
  });
}
```

This adds the `is_partial` property to the PostHog event, enabling analytics queries that segment partial vs full settlements.

NOTE: The SettleConfirmSheet (Task 1) already calls this with the new signature. No other callers exist in the codebase -- verify with grep that only SettleConfirmSheet.tsx calls trackSettleUp.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Grep for all usages of trackSettleUp to confirm only SettleConfirmSheet calls it: `grep -r "trackSettleUp" --include="*.ts" --include="*.tsx"` should show only lib/analytics.ts (definition) and components/settlements/SettleConfirmSheet.tsx (usage).
  </verify>
  <done>
trackSettleUp analytics event includes is_partial boolean, enabling segmentation of partial vs full settlements in PostHog dashboards.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- no TypeScript errors across the project
2. `npx expo start` launches without crashes
3. Settle flow works end-to-end:
   - Display mode: tap Settle Up, see full balance, confirm without editing -> full settlement recorded, toast "Fully settled with Name"
   - Edit mode: tap amount, type partial amount, confirm -> partial settlement recorded, toast "Settled PX.XX to Name", balance refreshes to show remainder
   - Validation: cannot confirm P0.00, cannot type beyond balance, dust rule forces full settle when remainder < P1.00
4. "Full amount" button resets to full balance from any edited state
5. Cancel in edit mode returns to display mode (or closes sheet)
</verification>

<success_criteria>
- SETL-01: Settle sheet displays editable amount field with NumPad
- SETL-02: Amount pre-filled with full simplified balance
- SETL-03: Amount cannot exceed current balance (NumPad caps input)
- SETL-04: Minimum P1.00 (confirm disabled below this -- note: CONTEXT.md says P1.00, not P0.01 from requirements)
- SETL-05: After partial settlement, group balances refresh showing remaining debt
- SETL-06: Confirming without editing records full settlement (backwards-compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/17-partial-settlement-amount-entry/17-01-SUMMARY.md`
</output>
