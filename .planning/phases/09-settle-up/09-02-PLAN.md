---
phase: 09-settle-up
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - components/settlements/SettleConfirmSheet.tsx
  - app/group/[id].tsx
autonomous: true

must_haves:
  truths:
    - "User can tap Settle on a balance row where they are payer or receiver and see a confirmation bottom sheet"
    - "Confirmation sheet shows payer name, receiver name, and non-editable peso amount with a Confirm button"
    - "After confirming, a success toast appears, haptic fires, balances refresh, and zero-balance rows disappear"
    - "User can view settlement history in the group showing who paid who, how much, and when"
    - "User can long-press a settlement history entry they created to delete it"
    - "Settle button does NOT appear on balance rows involving pending members"
  artifacts:
    - path: "components/settlements/SettleConfirmSheet.tsx"
      provides: "Bottom sheet confirmation component for settling a balance"
      contains: "SettleConfirmSheet"
    - path: "app/group/[id].tsx"
      provides: "Settle button on balance rows, settlement history section, delete settlement flow"
      contains: "handleConfirmSettle"
  key_links:
    - from: "components/settlements/SettleConfirmSheet.tsx"
      to: "supabase.rpc('record_settlement')"
      via: "RPC call on confirm button press"
      pattern: "record_settlement"
    - from: "app/group/[id].tsx"
      to: "components/settlements/SettleConfirmSheet.tsx"
      via: "import and render with bottom sheet ref"
      pattern: "SettleConfirmSheet"
    - from: "app/group/[id].tsx"
      to: "supabase.rpc('delete_settlement')"
      via: "Alert confirm then RPC call on long-press delete"
      pattern: "delete_settlement"
    - from: "app/group/[id].tsx"
      to: "settlements table query"
      via: "Supabase select with joined user names for history display"
      pattern: "from.*settlements.*select"
---

<objective>
Add settle-up UI flow and settlement history to the group detail screen: settle button on balance rows, confirmation bottom sheet, settlement history section with delete capability.

Purpose: Completes the settle-up feature by wiring the backend RPCs (from 09-01) to the user-facing UI, letting users record and view settlements.
Output: SettleConfirmSheet component and updated group detail screen with settle buttons, history section, and delete flow.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-settle-up/09-RESEARCH.md
@.planning/phases/09-settle-up/09-01-SUMMARY.md

@app/group/[id].tsx
@components/ui/BottomSheet.tsx
@components/ui/Toast.tsx
@lib/balance-utils.ts
@lib/database.types.ts
@lib/expense-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettleConfirmSheet component</name>
  <files>components/settlements/SettleConfirmSheet.tsx</files>
  <action>
Create `components/settlements/SettleConfirmSheet.tsx` -- a bottom sheet for confirming a settlement. Follow the pattern of `components/groups/AddMemberModal.tsx` (uses `AppBottomSheet` with `forwardRef`).

**Props interface:**
```typescript
interface SettleConfirmSheetProps {
  groupId: string;
  payerName: string;       // debtor display name (person who owes)
  payerId: string;         // debtor user id
  receiverName: string;    // creditor display name (person owed money)
  receiverId: string;      // creditor user id
  amountCentavos: number;  // settlement amount in centavos
  onSettled: () => void;   // callback to refetch group data after success
  onClose: () => void;     // callback to close the sheet
}
```

**Component structure:**
- Use `forwardRef<BottomSheetModal, SettleConfirmSheetProps>` pattern
- Wrap content in `AppBottomSheet` with `snapPoints={["35%"]}` (compact confirmation)
- Content layout (centered, padded with `spacing[6]`):
  1. Header text: "Settle Up" using `Text variant="h3" color="textPrimary"`
  2. Description: "{payerName} pays {receiverName}" using `Text variant="body" color="textSecondary"` -- centered
  3. Amount display: large peso amount using `Text variant="h1" color="accent"` showing `P{formatPeso(amountCentavos)}` -- this is NON-EDITABLE (LOCKED decision), just displayed as fixed text
  4. No explanation text about the constraint (LOCKED decision)
  5. Confirm button: `Button label="Confirm Settlement" variant="primary"` with loading state
  6. Cancel link: `Pressable` with `Text variant="body" color="textTertiary"` saying "Cancel"

**On confirm press (handleConfirmSettle):**
1. Set loading state to true
2. Call `supabase.rpc("record_settlement", { p_group_id: groupId, p_paid_by: payerId, p_paid_to: receiverId, p_amount: amountCentavos / 100 })` -- convert centavos to pesos for DB storage
3. On error: `showToast({ message: error.message, type: "error" })`, `Haptics.notificationAsync(Error)`, return
4. On success: `Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success)` (LOCKED decision), `showToast({ message: "Settled!", type: "success" })` (LOCKED decision), call `onSettled()`, call `onClose()`
5. Wrap in try/catch with generic error toast in catch
6. Set loading false in finally

**Imports needed:**
- `AppBottomSheet` from `@/components/ui/BottomSheet`
- `BottomSheetModal` from `@gorhom/bottom-sheet`
- `Text` from `@/components/ui/Text`
- `Button` from `@/components/ui/Button`
- `useToast` from `@/components/ui/Toast`
- `supabase` from `@/lib/supabase`
- `formatPeso` from `@/lib/expense-utils`
- `* as Haptics` from `expo-haptics`
- `colors, spacing` from `@/theme`
- Standard React/RN imports (forwardRef, useState, View, Pressable, StyleSheet)

**Style:** Dark-first, consistent with existing bottom sheets. Content centered vertically with good spacing between elements.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation. Check that the component exports correctly and follows the same forwardRef+AppBottomSheet pattern as AddMemberModal.
  </verify>
  <done>
`components/settlements/SettleConfirmSheet.tsx` exists with: forwardRef pattern, non-editable amount display, confirm button calling record_settlement RPC with centavos-to-pesos conversion, success haptic + toast on confirm, error handling, cancel action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add settle buttons, settlement history, and delete to group detail</name>
  <files>app/group/[id].tsx</files>
  <action>
Modify `app/group/[id].tsx` to add three features: settle button on balance rows, settlement history section, and settlement deletion.

**A. New imports:**
- Add `SettleConfirmSheet` from `@/components/settlements/SettleConfirmSheet`
- Add `useToast` from `@/components/ui/Toast` (if not already imported)
- Add `Alert` to the RN import (already imported)

**B. New state variables** (add after existing state declarations around line 108-114):
```typescript
const [selectedSettle, setSelectedSettle] = useState<Settlement | null>(null);
const [settlementHistory, setSettlementHistory] = useState<Array<{
  id: string;
  paid_by: string;
  paid_to: string;
  amount: number;
  created_by: string;
  created_at: string;
  payer_name: string;
  receiver_name: string;
}>>([]);
```

**C. New bottom sheet ref** (add after existing `addMemberRef`):
```typescript
const { ref: settleSheetRef, open: openSettleSheet, close: closeSettleSheet } = useBottomSheet();
const { showToast } = useToast();
```

**D. Update fetchData function** to also fetch settlement history:
- Add a 5th parallel query in the `Promise.all` array:
  ```typescript
  supabase
    .from("settlements")
    .select("id, paid_by, paid_to, amount, created_by, created_at, payer:users!settlements_paid_by_fkey(display_name), receiver:users!settlements_paid_to_fkey(display_name)")
    .eq("group_id", id!)
    .order("created_at", { ascending: false })
  ```
- Process the result: map each row to the settlementHistory shape, extracting `payer_name` and `receiver_name` from the joined user objects
- Set `settlementHistory` state with the mapped data

**E. Settle button on balance rows** (modify the settlements.map around lines 431-523):
- After the existing creditor `<View style={styles.settlementPerson}>` section and before the closing `</View>` of `settlementRow`, add a settle button:
- Determine eligibility: `const canSettle = s.from === currentUserId || s.to === currentUserId;` and `const bothReal = !isMemberPending(s.from) && !isMemberPending(s.to);`
  - `isMemberPending` should check `balanceMemberFlags.get(memberId) === true`
  - These checks may already partially exist; the `isCurrentUserDebtor` / `isCurrentUserCreditor` variables are already computed
- When `canSettle && bothReal`, render a "Settle" button on the right side of the card:
  ```tsx
  {canSettle && bothReal && (
    <Pressable
      onPress={() => {
        setSelectedSettle(s);
        openSettleSheet();
      }}
      style={styles.settleButton}
      hitSlop={8}
    >
      <Text variant="caption" color="accent">Settle</Text>
    </Pressable>
  )}
  ```
- The settle button should be positioned at the far right of the card. Adjust the `settlementRow` layout: the existing layout has debtor, center (owes + amount), creditor in a row. Add the settle button as a fourth element at the end. Give it a small fixed width so it doesn't distort the layout.

**F. Settlement History section** (add BETWEEN the balances section and the expenses section, around line 524):
- New section with same styling pattern as expenses section:
  ```tsx
  {/* Settlement History section */}
  <View style={styles.settlementHistorySection}>
    <View style={styles.sectionHeader}>
      <Text variant="bodyMedium" color="textPrimary">
        Settlement History
      </Text>
      {settlementHistory.length > 0 && (
        <View style={styles.countBadge}>
          <Text variant="caption" color="textSecondary">
            {settlementHistory.length}
          </Text>
        </View>
      )}
    </View>

    {settlementHistory.length === 0 ? (
      <EmptyState
        emoji="handshake"
        headline="No settlements yet"
        subtext="Settle balances to record payments here"
      />
    ) : (
      settlementHistory.map((sh) => (
        <Pressable
          key={sh.id}
          onLongPress={() => handleDeleteSettlement(sh)}
        >
          <Card style={styles.settlementHistoryCard}>
            <View style={styles.settlementHistoryRow}>
              <View style={{ flex: 1 }}>
                <Text variant="bodyMedium" color="textPrimary">
                  {sh.payer_name} paid {sh.receiver_name}
                </Text>
                <Text variant="caption" color="textTertiary">
                  {new Date(sh.created_at).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}
                </Text>
              </View>
              <Text variant="bodyMedium" color="accent">
                {"\u20B1"}{formatPeso(Math.round(sh.amount * 100))}
              </Text>
            </View>
          </Card>
        </Pressable>
      ))
    )}
  </View>
  ```

**G. Delete settlement handler:**
```typescript
function handleDeleteSettlement(sh: typeof settlementHistory[number]) {
  // Only the creator can delete
  if (sh.created_by !== currentUserId) return;

  Alert.alert(
    "Delete Settlement",
    `Remove this settlement of P${formatPeso(Math.round(sh.amount * 100))}? The balance will revert.`,
    [
      { text: "Cancel", style: "cancel" },
      {
        text: "Delete",
        style: "destructive",
        onPress: async () => {
          const { error: rpcError } = await supabase.rpc("delete_settlement", {
            p_settlement_id: sh.id,
          });
          if (rpcError) {
            showToast({ message: rpcError.message, type: "error" });
            Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
            return;
          }
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
          showToast({ message: "Settlement removed", type: "success" });
          fetchData(); // Refetch to update balances and history
        },
      },
    ],
  );
}
```

**H. Render SettleConfirmSheet** (add after the existing AddMemberSheet, before the closing `</SafeAreaView>`):
```tsx
{selectedSettle && (
  <SettleConfirmSheet
    ref={settleSheetRef}
    groupId={id!}
    payerName={getMemberDisplayName(selectedSettle.from)}
    payerId={selectedSettle.from}
    receiverName={getMemberDisplayName(selectedSettle.to)}
    receiverId={selectedSettle.to}
    amountCentavos={selectedSettle.amount}
    onSettled={async () => {
      await fetchData(); // Immediate server refresh (LOCKED decision)
    }}
    onClose={closeSettleSheet}
  />
)}
```

**I. New styles** (add to StyleSheet.create):
```typescript
settleButton: {
  paddingHorizontal: spacing[3],
  paddingVertical: spacing[2],
},
settlementHistorySection: {
  paddingHorizontal: spacing[6],
  gap: spacing[2],
  marginBottom: spacing[6],
},
settlementHistoryCard: {
  paddingVertical: spacing[3],
  paddingHorizontal: spacing[3],
},
settlementHistoryRow: {
  flexDirection: "row",
  alignItems: "center",
  justifyContent: "space-between",
  gap: spacing[3],
},
```

**J. Update CachedGroupDetail type** to include settlementHistory if desired (optional but recommended for consistency -- add `settlementHistory` to the interface and the cache set/get logic).

**Key constraints to honor:**
- Only own debts: Settle button only shows when `canSettle` (current user is from or to)
- Non-editable amount: Sheet displays fixed amount, no input field
- Success toast + stay on screen: After settling, show toast and remain (LOCKED)
- Zero-balance rows disappear: Handled by server RPC WHERE != 0; UI just refetches
- Success haptic: Handled in SettleConfirmSheet
- Immediate server refresh: `await fetchData()` in onSettled callback (LOCKED)
- No settle on pending members: `bothReal` check prevents button from showing
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Visually review:
1. Settle button appears on balance rows only for current user's balances with real members
2. Settlement history section exists between Balances and Expenses sections
3. SettleConfirmSheet is rendered and wired to bottom sheet ref
4. Delete handler exists with Alert confirmation
5. fetchData includes settlement history query
  </verify>
  <done>
Group detail screen has: "Settle" button on eligible balance rows, SettleConfirmSheet wired with bottom sheet, settlement history section between Balances and Expenses with date-formatted entries, long-press delete with Alert confirmation calling delete_settlement RPC, fetchData includes settlement history query. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Settle button only appears on balance rows where current user is involved AND both parties are real users
3. Tapping Settle opens a bottom sheet with payer/receiver names and non-editable peso amount
4. Confirming calls record_settlement RPC, shows success toast, fires success haptic, refetches data
5. Zero-balance rows disappear after settling (server filters them out on refetch)
6. Settlement history section shows between Balances and Expenses with payer, receiver, amount, date
7. Long-pressing a settlement history entry (created by current user) shows delete confirmation
8. Deleting calls delete_settlement RPC and refetches data
9. Home screen balance updates automatically via existing useFocusEffect when navigating back
</verification>

<success_criteria>
- User can tap "Settle" on their own balance row and confirm in a bottom sheet
- Settlement amount is displayed as non-editable fixed text
- After confirming: success haptic, "Settled!" toast, balances refresh, zero rows disappear
- Settlement history section shows all settlements in the group with who paid who, amount, and date
- User can long-press their own settlement to delete it with Alert confirmation
- Settle button does NOT appear for pending member balances
</success_criteria>

<output>
After completion, create `.planning/phases/09-settle-up/09-02-SUMMARY.md`
</output>
