---
phase: 09-settle-up
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00021_settlements_table.sql
  - lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Settlement is recorded with amount, payer, payee, and timestamp when user confirms"
    - "Only the payer or receiver can record a settlement (own debts only)"
    - "After settling, balance between those two people updates to reflect the payment"
    - "Home screen per-group balance also reflects settlements"
    - "Settlement creator can delete a mistaken settlement"
  artifacts:
    - path: "supabase/migrations/00021_settlements_table.sql"
      provides: "settlements table, record_settlement RPC, delete_settlement RPC, updated balance RPCs"
      contains: "create table public.settlements"
    - path: "lib/database.types.ts"
      provides: "TypeScript types for record_settlement and delete_settlement RPCs"
      contains: "record_settlement"
  key_links:
    - from: "supabase/migrations/00021_settlements_table.sql"
      to: "get_group_balances RPC"
      via: "settled_out and settled_in CTEs incorporated into net_balance computation"
      pattern: "settled_out|settled_in"
    - from: "supabase/migrations/00021_settlements_table.sql"
      to: "get_my_group_balances RPC"
      via: "same settlement CTEs for home screen balance"
      pattern: "settled_out|settled_in"
---

<objective>
Create the settlements database table, record_settlement and delete_settlement RPCs, and update both balance RPCs to incorporate settlement amounts into net balance computation.

Purpose: Provides the backend foundation for the settle-up feature -- without this, no settlement can be recorded and balances cannot reflect payments.
Output: Migration file with settlements table + 4 RPCs (record, delete, updated get_group_balances, updated get_my_group_balances), and updated TypeScript database types.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-settle-up/09-RESEARCH.md

@supabase/migrations/00009_balance_rpcs.sql
@supabase/migrations/00017_fix_get_group_balances_anchor.sql
@supabase/migrations/00020_invite_accept_decline.sql
@lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settlements migration with table, RPCs, and balance updates</name>
  <files>supabase/migrations/00021_settlements_table.sql</files>
  <action>
Create migration `supabase/migrations/00021_settlements_table.sql` containing:

**1. Settlements table:**
```sql
create table public.settlements (
  id uuid primary key default gen_random_uuid(),
  group_id uuid references public.groups(id) on delete cascade not null,
  paid_by uuid references public.users(id) not null,
  paid_to uuid references public.users(id) not null,
  amount numeric(10,2) not null check (amount > 0),
  created_by uuid references public.users(id) not null,
  created_at timestamptz default now() not null
);
```
- Enable RLS on settlements
- RLS SELECT policy: group members can view settlements in their groups (same pattern as expenses RLS -- check `group_id in (select group_id from group_members where user_id = auth.uid())`)
- Indexes on group_id, paid_by, paid_to for query performance

**2. record_settlement RPC** (security definer, set search_path = public):
- Params: `p_group_id uuid, p_paid_by uuid, p_paid_to uuid, p_amount numeric(10,2)`
- Returns: uuid (new settlement id)
- Validations:
  - Auth check: `auth.uid()` must not be null
  - Caller must be either `p_paid_by` or `p_paid_to` (own debts only -- LOCKED decision)
  - Both `p_paid_by` and `p_paid_to` must exist in `group_members` for this group
  - `p_amount` must be positive
- Do NOT validate that amount matches current balance (per research -- race condition tolerance)
- Insert into settlements table with `created_by = auth.uid()`
- Return the new settlement id

**3. delete_settlement RPC** (security definer, set search_path = public):
- Params: `p_settlement_id uuid`
- Returns: void
- Validations:
  - Auth check
  - Settlement must exist
  - `created_by` must equal `auth.uid()` (only creator can delete)
- Delete the settlement row
- No time window restriction (per research recommendation)

**4. Replace get_group_balances** with `create or replace function`:
- Same signature: `(p_group_id uuid) returns table(member_id uuid, is_pending boolean, net_balance numeric(10,2))`
- Same security definer pattern
- Add two new CTEs after the existing `paid` and `owed` CTEs:
  - `settled_out`: `select s.paid_by as mid, sum(s.amount) as total_settled from settlements s where s.group_id = p_group_id group by s.paid_by`
  - `settled_in`: `select s.paid_to as mid, sum(s.amount) as total_settled from settlements s where s.group_id = p_group_id group by s.paid_to`
- Update the final SELECT to add:
  - `+ coalesce(so.total_settled, 0)` (paid settlements increase net -- debtor paid off debt)
  - `- coalesce(si.total_settled, 0)` (received settlements decrease net -- creditor's credit was satisfied)
- Join settled_out and settled_in only for non-pending members (`am.is_pend = false`)
- Keep the `WHERE != 0` filter (zero-balance rows disappear -- LOCKED decision)

IMPORTANT: Read the latest version of get_group_balances from migration 00017 (the anchor fix) to get the current CTE structure. The replacement must preserve all existing logic and only ADD the settlement CTEs.

**5. Replace get_my_group_balances** with `create or replace function`:
- Same signature: `() returns table(group_id uuid, net_balance numeric(10,2))`
- Same security definer pattern
- Add same two settlement CTEs (scoped to `current_user_id` and `my_groups`):
  - `settled_out`: settlements where `paid_by = current_user_id`
  - `settled_in`: settlements where `paid_to = current_user_id`
- Update final SELECT with same `+ settled_out - settled_in` math
- Keep `WHERE != 0` filter

IMPORTANT: Read the latest version of get_my_group_balances from migration 00009 or 00017 to get the current structure.

Follow the exact SQL patterns from the research document (09-RESEARCH.md Pattern 2, 3, 4) but verify against the actual current migration files before writing.
  </action>
  <verify>
Run `npx supabase migration list` to confirm the migration file is detected. Visually verify the SQL has:
- settlements table with correct columns and constraints
- record_settlement with all 4 validations
- delete_settlement with creator-only guard
- get_group_balances with settled_out and settled_in CTEs
- get_my_group_balances with settlement CTEs
- RLS policy on settlements table
- All three indexes
  </verify>
  <done>
Migration file exists at supabase/migrations/00021_settlements_table.sql with: settlements table (6 columns, RLS, 3 indexes), record_settlement RPC (4 validations, returns uuid), delete_settlement RPC (creator-only), get_group_balances with settlement math, get_my_group_balances with settlement math.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update database types with settlement RPCs</name>
  <files>lib/database.types.ts</files>
  <action>
Add the following to the `Functions` section in `lib/database.types.ts` (after the existing `decline_invite` entry):

```typescript
record_settlement: {
  Args: {
    p_group_id: string;
    p_paid_by: string;
    p_paid_to: string;
    p_amount: number;
  };
  Returns: string;
};
delete_settlement: {
  Args: {
    p_settlement_id: string;
  };
  Returns: undefined;
};
```

Also add the `settlements` table type to the `Tables` section (after `pending_members`):

```typescript
settlements: {
  Row: {
    id: string;
    group_id: string;
    paid_by: string;
    paid_to: string;
    amount: number;
    created_by: string;
    created_at: string;
  };
  Insert: {
    id?: string;
    group_id: string;
    paid_by: string;
    paid_to: string;
    amount: number;
    created_by: string;
    created_at?: string;
  };
  Update: {
    id?: string;
    group_id?: string;
    paid_by?: string;
    paid_to?: string;
    amount?: number;
    created_by?: string;
    created_at?: string;
  };
  Relationships: [
    {
      foreignKeyName: "settlements_group_id_fkey";
      columns: ["group_id"];
      isOneToOne: false;
      referencedRelation: "groups";
      referencedColumns: ["id"];
    },
    {
      foreignKeyName: "settlements_paid_by_fkey";
      columns: ["paid_by"];
      isOneToOne: false;
      referencedRelation: "users";
      referencedColumns: ["id"];
    },
    {
      foreignKeyName: "settlements_paid_to_fkey";
      columns: ["paid_to"];
      isOneToOne: false;
      referencedRelation: "users";
      referencedColumns: ["id"];
    },
    {
      foreignKeyName: "settlements_created_by_fkey";
      columns: ["created_by"];
      isOneToOne: false;
      referencedRelation: "users";
      referencedColumns: ["id"];
    },
  ];
};
```

Follow the exact formatting pattern of existing table and function type definitions in the file.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root to verify no TypeScript compilation errors. Check that the new types are properly structured by searching for `record_settlement` and `settlements` in the file.
  </verify>
  <done>
`lib/database.types.ts` contains: settlements table Row/Insert/Update types with all 7 columns, record_settlement function type (4 args, returns string), delete_settlement function type (1 arg, returns undefined). TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Migration file `supabase/migrations/00021_settlements_table.sql` exists and contains all 5 SQL objects (table, 2 new RPCs, 2 updated RPCs)
2. `lib/database.types.ts` has settlements table type and both new function types
3. TypeScript compiles without errors: `npx tsc --noEmit`
4. The settlement math direction is correct: paid_by (debtor) gets net increase, paid_to (creditor) gets net decrease
5. Both balance RPCs filter out zero-balance rows (WHERE != 0)
</verification>

<success_criteria>
- Migration creates settlements table with proper constraints and RLS
- record_settlement validates caller is payer or receiver, both are group members, amount is positive
- delete_settlement restricts deletion to the settlement creator
- get_group_balances incorporates settlement amounts correctly
- get_my_group_balances incorporates settlement amounts correctly
- TypeScript types match the new database schema
</success_criteria>

<output>
After completion, create `.planning/phases/09-settle-up/09-01-SUMMARY.md`
</output>
