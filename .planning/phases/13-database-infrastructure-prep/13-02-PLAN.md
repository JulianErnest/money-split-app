---
phase: 13-database-infrastructure-prep
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app.json
  - package.json
autonomous: false

user_setup:
  - service: supabase-apple-provider
    why: "Apple Sign-In authentication provider for native iOS flow"
    dashboard_config:
      - task: "Enable Apple provider and set bundle ID"
        location: "Supabase Dashboard > Authentication > Providers > Apple"
        steps:
          - "Toggle: Enable Apple provider = ON"
          - "Field: Authorized Client IDs = com.kkbsplit.app"
          - "Leave empty: Secret Key, Service ID, redirect URL (not needed for native flow)"
          - "Save"

must_haves:
  truths:
    - "app.json is configured with expo-apple-authentication plugin and usesAppleSignIn capability flag"
    - "Apple Sign-In provider is enabled in Supabase dashboard with the correct bundle ID"
  artifacts:
    - path: "app.json"
      provides: "iOS Apple Sign-In capability and config plugin"
      contains: "usesAppleSignIn"
    - path: "package.json"
      provides: "expo-apple-authentication dependency"
      contains: "expo-apple-authentication"
  key_links:
    - from: "app.json"
      to: "EAS Build"
      via: "expo-apple-authentication plugin enables iOS entitlement"
      pattern: "expo-apple-authentication"
    - from: "app.json"
      to: "Apple Developer Portal"
      via: "usesAppleSignIn flag syncs capability during EAS Build"
      pattern: "usesAppleSignIn"
---

<objective>
Install expo-apple-authentication, configure app.json for Apple Sign-In capability, and verify Supabase dashboard Apple provider is enabled.

Purpose: EAS Build must have the Apple Sign-In capability configured BEFORE any auth code is written (Phase 14). If the plugin is missing during an EAS build, the capability gets disabled in Apple Developer Portal and Apple Sign-In silently fails at runtime. The Supabase dashboard must have the Apple provider enabled with the correct bundle ID for `signInWithIdToken` to work.

Output: Updated `app.json` with `usesAppleSignIn: true` and `expo-apple-authentication` plugin. Supabase Apple provider enabled.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-database-infrastructure-prep/13-RESEARCH.md
@app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-apple-authentication and configure app.json</name>
  <files>app.json, package.json</files>
  <action>
1. Install the expo-apple-authentication package:
   ```bash
   npx expo install expo-apple-authentication
   ```
   This uses `expo install` (not `npm install`) to ensure version compatibility with the current Expo SDK.

2. Add `usesAppleSignIn: true` to the `ios` section of `app.json`:
   ```json
   "ios": {
     "supportsTablet": true,
     "bundleIdentifier": "com.kkbsplit.app",
     "buildNumber": "2",
     "usesAppleSignIn": true,
     "infoPlist": {
       "ITSAppUsesNonExemptEncryption": false
     }
   }
   ```

3. Add `"expo-apple-authentication"` to the `plugins` array in `app.json`:
   ```json
   "plugins": [
     "expo-router",
     ["expo-splash-screen", { ... }],
     "expo-sqlite",
     "expo-font",
     "expo-apple-authentication"
   ]
   ```

**Important:** The `usesAppleSignIn` flag tells EAS Build to enable the "Sign in with Apple" capability in Apple Developer Portal. The plugin handles iOS entitlement file generation. Both are needed.

**Do NOT:**
- Add expo-crypto yet (that is Phase 14 work)
- Add any authentication code (that is Phase 14 work)
- Modify any other app.json fields
  </action>
  <verify>
1. `grep 'expo-apple-authentication' package.json` returns a match
2. `grep 'usesAppleSignIn' app.json` returns a match with `true`
3. `grep 'expo-apple-authentication' app.json` returns a match in plugins array
4. `npx expo config --type public` runs without errors (validates app.json structure)
  </verify>
  <done>expo-apple-authentication is installed, app.json has usesAppleSignIn: true in ios section and expo-apple-authentication in plugins array. App config validates successfully.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Enable Apple provider in Supabase dashboard</name>
  <what-to-do>
Enable the Apple Sign-In provider in the Supabase dashboard. This is a manual step because Supabase Management API does not support auth provider configuration.

Steps:
1. Go to: Supabase Dashboard > Authentication > Providers > Apple
2. Toggle: Enable Apple provider = ON
3. Field: Authorized Client IDs = `com.kkbsplit.app`
4. Leave empty: Secret Key, Service ID, redirect URL (these are for OAuth web flow, not needed for native iOS `signInWithIdToken`)
5. Click Save

**Why this matters:** Without the Apple provider enabled, `signInWithIdToken` calls in Phase 14 will return 400/422 errors. The bundle ID must match `com.kkbsplit.app` exactly (as in app.json).
  </what-to-do>
  <resume-signal>Type "done" after enabling the Apple provider in Supabase dashboard</resume-signal>
</task>

</tasks>

<verification>
1. `app.json` has `"usesAppleSignIn": true` in the `ios` section
2. `app.json` has `"expo-apple-authentication"` in the `plugins` array
3. `package.json` lists `expo-apple-authentication` as a dependency
4. Apple provider is enabled in Supabase dashboard with bundle ID `com.kkbsplit.app`
</verification>

<success_criteria>
- expo-apple-authentication is installed and listed in package.json
- app.json ios section has usesAppleSignIn: true
- app.json plugins array includes expo-apple-authentication
- Supabase Apple provider is enabled with correct bundle ID (verified by user)
</success_criteria>

<output>
After completion, create `.planning/phases/13-database-infrastructure-prep/13-02-SUMMARY.md`
</output>
