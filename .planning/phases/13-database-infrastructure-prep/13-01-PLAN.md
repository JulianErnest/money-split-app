---
phase: 13-database-infrastructure-prep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00024_apple_auth_prep.sql
  - lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "A user row can exist with NULL phone_number (column is nullable)"
    - "The auth trigger creates a users row for Apple Sign-In users without crashing on NULL phone"
    - "An RPC exists that links pending member invites when a phone number is provided after authentication"
  artifacts:
    - path: "supabase/migrations/00024_apple_auth_prep.sql"
      provides: "ALTER TABLE + trigger rewrite + new RPC in a single atomic migration"
      contains: "ALTER TABLE public.users ALTER COLUMN phone_number DROP NOT NULL"
    - path: "lib/database.types.ts"
      provides: "Updated TypeScript types reflecting nullable phone_number"
      contains: "phone_number: string | null"
  key_links:
    - from: "supabase/migrations/00024_apple_auth_prep.sql"
      to: "public.users.phone_number"
      via: "ALTER TABLE DROP NOT NULL"
      pattern: "DROP NOT NULL"
    - from: "supabase/migrations/00024_apple_auth_prep.sql"
      to: "public.handle_pending_member_claim"
      via: "CREATE OR REPLACE FUNCTION with NULLIF guard"
      pattern: "NULLIF\\(new\\.phone"
    - from: "supabase/migrations/00024_apple_auth_prep.sql"
      to: "public.link_phone_to_pending_invites"
      via: "New RPC function definition"
      pattern: "link_phone_to_pending_invites"
---

<objective>
Write and apply the database migration that makes phone_number nullable, rewrites the auth trigger for Apple Sign-In compatibility, and creates the deferred invite-linking RPC.

Purpose: Existing phone OTP users are unaffected, but new Apple Sign-In users can exist with NULL phone_number. The trigger no longer crashes on empty/NULL phone, and a new RPC allows Phase 15 to link pending invites when the user provides their phone during profile setup.

Output: Migration file `00024_apple_auth_prep.sql` applied to local Supabase, regenerated TypeScript types with `phone_number: string | null`.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-database-infrastructure-prep/13-RESEARCH.md
@supabase/migrations/00019_invite_status_consent_flow.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 00024_apple_auth_prep.sql</name>
  <files>supabase/migrations/00024_apple_auth_prep.sql</files>
  <action>
Create `supabase/migrations/00024_apple_auth_prep.sql` with three parts in a single atomic migration:

**PART 1 -- Make phone_number nullable (DB-01):**
```sql
ALTER TABLE public.users ALTER COLUMN phone_number DROP NOT NULL;
```
The UNIQUE constraint remains -- PostgreSQL allows multiple NULLs in a UNIQUE column by SQL spec. Existing rows with phone numbers are unaffected.

**PART 2 -- Rewrite auth trigger for Apple Sign-In (DB-02):**
Replace the `handle_pending_member_claim` function body (from migration 00019). Key changes:
1. Use `NULLIF(new.phone, '')` in the INSERT to store NULL instead of empty string for Apple users
2. Wrap the pending_members UPDATE in `IF NULLIF(new.phone, '') IS NOT NULL THEN ... END IF;` so Apple users (no phone) skip invite linking
3. Keep the EXCEPTION handler
4. Use `CREATE OR REPLACE FUNCTION` (do NOT drop/recreate the trigger itself -- only the function body changes)

**PART 3 -- Create link_phone_to_pending_invites RPC (DB-03):**
New `SECURITY DEFINER` function matching existing RPC patterns (see add_pending_member in migration 00019):
- Parameter: `p_phone_number text`
- Returns: `void`
- Auth check: `IF auth.uid() IS NULL THEN RAISE EXCEPTION 'Not authenticated'`
- Normalize phone: `ltrim(p_phone_number, '+')`
- UPDATE pending_members SET user_id = auth.uid() WHERE user_id IS NULL AND ltrim(phone_number, '+') = normalized_phone
- Include `SET search_path = public` and `SET row_security = off`

Use the complete migration from the RESEARCH.md code example. Add clear comments explaining each part.

**Anti-patterns to avoid:**
- Do NOT store empty string '' as phone_number (use NULL via NULLIF)
- Do NOT add a DEFAULT value to phone_number column
- Do NOT split into separate migration files (ALTER and trigger are interdependent)
- Do NOT use CREATE TRIGGER (the trigger already exists from migration 00007, only replace the function)
  </action>
  <verify>
1. File exists: `ls supabase/migrations/00024_apple_auth_prep.sql`
2. Contains all three parts: `grep -c 'PART' supabase/migrations/00024_apple_auth_prep.sql` returns 3
3. Contains NULLIF guard: `grep 'NULLIF' supabase/migrations/00024_apple_auth_prep.sql`
4. Contains new RPC: `grep 'link_phone_to_pending_invites' supabase/migrations/00024_apple_auth_prep.sql`
5. Contains DROP NOT NULL: `grep 'DROP NOT NULL' supabase/migrations/00024_apple_auth_prep.sql`
  </verify>
  <done>Migration file exists with all three parts: ALTER TABLE making phone_number nullable, trigger rewrite with NULLIF guard and conditional logic, and new link_phone_to_pending_invites RPC with auth check.</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and regenerate TypeScript types</name>
  <files>lib/database.types.ts</files>
  <action>
1. Reset local Supabase database and apply all migrations (including the new 00024):
   ```bash
   npx supabase db reset
   ```
   This replays all 24 migrations from scratch, ensuring the new migration works in sequence.

2. Regenerate TypeScript types:
   ```bash
   npx supabase gen types typescript --local > lib/database.types.ts
   ```

3. Verify the generated types show `phone_number` as nullable:
   - In the `users` Row type: `phone_number: string | null`
   - In the `users` Insert type: `phone_number?: string | null`
   - The new `link_phone_to_pending_invites` RPC should appear in the Functions section

If `npx supabase db reset` fails, check the migration SQL for syntax errors and fix them.

If the type generation does not show `phone_number` as nullable, the migration did not apply correctly -- investigate and fix.
  </action>
  <verify>
1. `npx supabase db reset` completes without errors
2. `grep 'phone_number' lib/database.types.ts` shows `string | null` (not just `string`)
3. `grep 'link_phone_to_pending_invites' lib/database.types.ts` returns matches (RPC is in generated types)
4. `npx tsc --noEmit` completes (may have pre-existing errors from phase 08-02, but no NEW errors from nullable phone_number)
  </verify>
  <done>Local Supabase has all 24 migrations applied. TypeScript types reflect phone_number as `string | null`. The link_phone_to_pending_invites RPC appears in generated types. No new TypeScript compilation errors introduced.</done>
</task>

</tasks>

<verification>
1. Migration file `supabase/migrations/00024_apple_auth_prep.sql` exists and contains ALTER TABLE + trigger rewrite + new RPC
2. `npx supabase db reset` succeeds (all 24 migrations apply cleanly)
3. `lib/database.types.ts` shows `phone_number: string | null` in users Row type
4. `link_phone_to_pending_invites` appears in TypeScript types as an available RPC
5. No new TypeScript errors introduced by the nullable change
</verification>

<success_criteria>
- users.phone_number column is nullable in local database
- Auth trigger uses NULLIF and conditional logic for Apple Sign-In compatibility
- link_phone_to_pending_invites RPC exists with auth check and phone normalization
- TypeScript types are regenerated and reflect all changes
- Existing phone OTP flow is unaffected (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/13-database-infrastructure-prep/13-01-SUMMARY.md`
</output>
