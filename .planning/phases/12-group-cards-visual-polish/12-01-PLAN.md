---
phase: 12-group-cards-visual-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00023_group_card_data_rpc.sql
  - lib/group-card-data.ts
  - theme/colors.ts
  - components/ui/GlassCard.tsx
  - components/ui/AvatarStack.tsx
autonomous: true

must_haves:
  truths:
    - "A single RPC returns member display info and last activity date for all groups"
    - "Warm accent colors (amber, coral) exist as palette and semantic tokens"
    - "A glassmorphism card component renders semi-transparent cards with subtle borders"
    - "An avatar stack component renders overlapping member avatars with overflow badge"
  artifacts:
    - path: "supabase/migrations/00023_group_card_data_rpc.sql"
      provides: "get_group_card_data RPC"
      contains: "create or replace function public.get_group_card_data"
    - path: "lib/group-card-data.ts"
      provides: "TypeScript types and fetch function for group card data"
      exports: ["GroupCardData", "fetchGroupCardData"]
    - path: "theme/colors.ts"
      provides: "Warm accent palette tokens"
      contains: "amber"
    - path: "components/ui/GlassCard.tsx"
      provides: "Glassmorphism card component"
      exports: ["GlassCard"]
    - path: "components/ui/AvatarStack.tsx"
      provides: "Avatar stack with overlapping layout"
      exports: ["AvatarStack"]
  key_links:
    - from: "lib/group-card-data.ts"
      to: "supabase RPC get_group_card_data"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*get_group_card_data"
    - from: "components/ui/GlassCard.tsx"
      to: "theme/colors.ts"
      via: "rgba transparency values"
      pattern: "rgba\\(255"
---

<objective>
Create the data layer, theme tokens, and reusable UI components that Phase 12's visual polish depends on.

Purpose: Provide the building blocks (RPC for group card enrichment data, warm accent palette, GlassCard and AvatarStack components) so that Plan 02 can assemble them into the polished dashboard without creating infrastructure.
Output: New Supabase RPC migration, TypeScript fetch layer, extended color palette, and two new UI components.
</objective>

<execution_context>
@/Users/julianernestcamello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianernestcamello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-group-cards-visual-polish/12-RESEARCH.md
@theme/colors.ts
@components/ui/Card.tsx
@components/ui/Avatar.tsx
@supabase/migrations/00022_activity_feed_rpc.sql
@lib/activity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create group card data RPC, fetch layer, and warm accent palette</name>
  <files>
    supabase/migrations/00023_group_card_data_rpc.sql
    lib/group-card-data.ts
    theme/colors.ts
  </files>
  <action>
**Migration (00023_group_card_data_rpc.sql):**

Create a new RPC `get_group_card_data` that returns enriched data for group cards on the dashboard. Follow the exact pattern from `00022_activity_feed_rpc.sql` (plpgsql, security definer, auth.uid() check).

The RPC returns one row per group the user belongs to, with columns:
- `group_id uuid`
- `member_count integer`
- `member_ids uuid[]` — first 4 member user IDs (ordered by joined_at)
- `member_names text[]` — first 4 member display_names
- `member_avatars text[]` — first 4 member avatar_urls (nullable entries)
- `last_activity_at timestamptz` — most recent expense or settlement in the group (null if no activity)

SQL structure:
1. CTE `my_groups`: user's group_ids from `group_members` where `user_id = auth.uid()`
2. CTE `ranked_members`: `group_members` rows for my_groups with `row_number() over (partition by group_id order by joined_at)` — join to `users` table for display_name and avatar_url
3. CTE `group_member_agg`: aggregate per group — `count(*)` for member_count, `array_agg(user_id order by rn) filter (where rn <= 4)` for member_ids, same pattern for member_names and member_avatars
4. CTE `last_activities`: `max(created_at)` from `(expenses UNION ALL settlements)` per group
5. Final SELECT joining my_groups, group_member_agg, last_activities with LEFT JOINs and COALESCE for nulls

Important: The `filter (where rn <= 4)` must use the row_number column from the ranked CTE, NOT a window function inside the aggregate. Structure as a subquery or CTE with the row number pre-computed, then aggregate with a WHERE or FILTER clause on that number.

**TypeScript fetch layer (lib/group-card-data.ts):**

```typescript
export interface GroupCardMember {
  id: string;
  display_name: string;
  avatar_url: string | null;
}

export interface GroupCardData {
  group_id: string;
  member_count: number;
  members: GroupCardMember[];  // first 4
  last_activity_at: string | null;
}

export async function fetchGroupCardData(): Promise<GroupCardData[]> { ... }
```

The fetch function calls `supabase.rpc('get_group_card_data')` and transforms the raw array columns (member_ids, member_names, member_avatars) into the `GroupCardMember[]` shape by zipping the three arrays. Return empty array on error.

**Warm accent palette (theme/colors.ts):**

Add warm accent colors to the `palette` object:
```typescript
amber: '#F5A623',        // warm golden amber
amberSubtle: '#2A2010',  // dark amber for backgrounds
coral: '#FF6B6B',        // warm coral
coralSubtle: '#2A1515',  // dark coral for backgrounds
```

Add semantic tokens to the `colors` object:
```typescript
// Warm accents (brand touches)
warmAccent: palette.amber,
warmAccentSubtle: palette.amberSubtle,
warmSecondary: palette.coral,
warmSecondarySubtle: palette.coralSubtle,
```

These are additive — do NOT modify any existing green/red functional color tokens.
  </action>
  <verify>
1. `npx tsc --noEmit` — no new TypeScript errors (pre-existing ones in index.tsx and _layout.tsx are acceptable)
2. The migration file exists at `supabase/migrations/00023_group_card_data_rpc.sql` and contains valid SQL
3. `lib/group-card-data.ts` exports `GroupCardData` and `fetchGroupCardData`
4. `theme/colors.ts` contains `amber`, `coral`, `warmAccent`, `warmSecondary` tokens
  </verify>
  <done>
- RPC migration creates `get_group_card_data` returning member display info and last activity per group
- TypeScript layer provides typed `fetchGroupCardData()` function
- Palette has amber and coral primitives; colors has warmAccent and warmSecondary semantic tokens
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GlassCard and AvatarStack UI components</name>
  <files>
    components/ui/GlassCard.tsx
    components/ui/AvatarStack.tsx
  </files>
  <action>
**GlassCard (components/ui/GlassCard.tsx):**

A glassmorphism-styled card component — semi-transparent background with subtle border on the dark theme. This replaces the solid `Card` for group cards only.

```typescript
import React from 'react';
import { View, ViewProps, StyleSheet } from 'react-native';
import { radius, spacing } from '@/theme';

interface GlassCardProps extends ViewProps {
  children: React.ReactNode;
}

export function GlassCard({ style, children, ...props }: GlassCardProps) {
  return (
    <View style={[styles.card, style]} {...props}>
      {children}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.08)',
    borderRadius: radius.lg,
    padding: spacing[4],
  },
});
```

Key: Do NOT use expo-blur. The CSS-only glassmorphism (5% white background + 8% white border) achieves the frosted-glass effect on the dark theme background (#0D0D0D) per research recommendation.

**AvatarStack (components/ui/AvatarStack.tsx):**

Renders a horizontal row of overlapping small avatars with an overflow "+N" badge.

```typescript
import React from 'react';
import { View, StyleSheet } from 'react-native';
import { Avatar } from '@/components/ui/Avatar';
import { Text } from '@/components/ui/Text';
import { colors, radius } from '@/theme';

export interface AvatarStackMember {
  id: string;
  display_name: string;
  avatar_url: string | null;
}

interface AvatarStackProps {
  members: AvatarStackMember[];
  max?: number;
}

export function AvatarStack({ members, max = 3 }: AvatarStackProps) {
  const visible = members.slice(0, max);
  const overflow = members.length - max;

  return (
    <View style={styles.container}>
      {visible.map((member, index) => (
        <View
          key={member.id}
          style={[
            styles.wrapper,
            {
              marginLeft: index === 0 ? 0 : -8,
              zIndex: max - index,
            },
          ]}
        >
          <Avatar emoji={member.avatar_url || undefined} size="sm" />
        </View>
      ))}
      {overflow > 0 && (
        <View style={[styles.overflow, { marginLeft: -8 }]}>
          <Text variant="caption" color="textSecondary">
            +{overflow}
          </Text>
        </View>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  wrapper: {
    borderWidth: 2,
    borderColor: '#0D0D0D',  // matches background for clean overlap edge
    borderRadius: radius.full,
  },
  overflow: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: colors.surface,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 2,
    borderColor: '#0D0D0D',
  },
});
```

Key details:
- Use `size="sm"` (32px) for avatars in the stack
- Negative marginLeft of -8px creates the overlap effect
- zIndex ordering: first avatar on top, descending
- Border color matches background (#0D0D0D) so overlap edges look clean
- Overflow badge: 32px circle with "+N" text, same surface color as other UI elements
- Cap visible at `max` (default 3), show "+N" only when overflow > 0
  </action>
  <verify>
1. `npx tsc --noEmit` — no new TypeScript errors
2. `components/ui/GlassCard.tsx` exports `GlassCard`
3. `components/ui/AvatarStack.tsx` exports `AvatarStack` and `AvatarStackMember`
  </verify>
  <done>
- GlassCard renders a semi-transparent card with rgba(255,255,255,0.05) background and rgba(255,255,255,0.08) border
- AvatarStack renders overlapping small avatars with -8px overlap and "+N" overflow badge
- Both components are ready for import in Plan 02's dashboard wiring
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes (ignoring pre-existing cosmetic errors)
2. Migration file: `supabase/migrations/00023_group_card_data_rpc.sql` exists with valid CREATE FUNCTION
3. All exports: GlassCard, AvatarStack, AvatarStackMember, GroupCardData, fetchGroupCardData
4. Color palette extended: amber, coral in palette; warmAccent, warmSecondary in colors
</verification>

<success_criteria>
- New RPC `get_group_card_data` migration is created following existing SQL patterns
- TypeScript fetch layer provides typed access to group card enrichment data
- Warm accent color tokens extend the palette without modifying functional colors
- GlassCard and AvatarStack components are ready for Plan 02 integration
</success_criteria>

<output>
After completion, create `.planning/phases/12-group-cards-visual-polish/12-01-SUMMARY.md`
</output>
